<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>yaze: IT-05: Test Introspection API – Implementation Guide</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript">var page_layout=1;</script>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="side-nav" class="ui-resizable side-nav-resizable"><!-- do not remove this div, it is closed by doxygen! -->
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../yaze.ico"/></td>
  <td id="projectalign">
   <div id="projectname">yaze<span id="projectnumber">&#160;0.3.1</span>
   </div>
   <div id="projectbrief">Link to the Past ROM Editor</div>
  </td>
 </tr>
   <tr><td colspan="2">        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.svg" alt=""/></a>
          </span>
        </div>
</td></tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d5/d3d/md_docs_2z3ed_2IT-05-IMPLEMENTATION-GUIDE.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">IT-05: Test Introspection API – Implementation Guide</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md1365"></a> <b>Status (Oct 2, 2025)</b>: ✅ <b>COMPLETE - Production Ready</b></p>
<h1><a class="anchor" id="autotoc_md1366"></a>
Progress Snapshot</h1>
<ul>
<li>✅ Proto definitions and service stubs added for <code>GetTestStatus</code>, <code>ListTests</code>, <code>GetTestResults</code>.</li>
<li>✅ <code>TestManager</code> now records execution lifecycle, aggregates, logs, and metrics with thread-safe history trimming.</li>
<li>✅ <code>ImGuiTestHarnessServiceImpl</code> implements the three introspection RPC handlers, including pagination and status conversion helpers.</li>
<li>✅ CLI wiring complete: <code>GuiAutomationClient</code> exposes all introspection methods.</li>
<li>✅ User-facing commands: <code>z3ed agent test {status,list,results}</code> fully functional with YAML/JSON output.</li>
<li>✅ End-to-end validation script (<code>scripts/test_introspection_e2e.sh</code>) validates complete workflow.</li>
</ul>
<p><b>E2E Test Results</b> (Oct 2, 2025): </p><div class="fragment"><div class="line">✓ GetTestStatus RPC - Query test execution status</div>
<div class="line">✓ ListTests RPC - Enumerate available tests</div>
<div class="line">✓ GetTestResults RPC - Retrieve detailed results (YAML + JSON)</div>
<div class="line">✓ Follow mode - Poll status until completion</div>
<div class="line">✓ Category filtering - Filter tests by category</div>
<div class="line">✓ Pagination - Limit number of results</div>
</div><!-- fragment --><p> st Introspection API – Implementation Guide</p>
<p><b>Status (Oct 2, 2025)</b>: 🟡 <em>Server-side RPCs complete; CLI + E2E pending</em></p>
<h1><a class="anchor" id="autotoc_md1367"></a>
Progress Snapshot</h1>
<ul>
<li>✅ Proto definitions and service stubs added for <code>GetTestStatus</code>, <code>ListTests</code>, <code>GetTestResults</code>.</li>
<li>✅ <code>TestManager</code> now records execution lifecycle, aggregates, logs, and metrics with thread-safe history trimming.</li>
<li>✅ <code>ImGuiTestHarnessServiceImpl</code> implements the three RPC handlers, including pagination and status conversion helpers.</li>
<li>⚠️ CLI wiring, automation client calls, and user-facing output still TODO.</li>
<li>⚠️ End-to-end validation script (<code>scripts/test_introspection_e2e.sh</code>) not yet authored.</li>
</ul>
<p><b>Current Limitations</b>:</p><ul>
<li>❌ Tests execute asynchronously with no way to query status</li>
<li>❌ Clients must poll blindly or give up early</li>
<li>❌ No visibility into test execution queue</li>
<li>❌ Results lost after test completion</li>
<li>❌ Can't track test history or identify flaky tests</li>
</ul>
<p><b>Why This Blocks AI Agent Autonomy</b></p>
<p>Without test introspection, <b>AI agents cannot implement closed-loop feedback</b>:</p>
<div class="fragment"><div class="line">❌ BROKEN: AI Agent Without IT-05</div>
<div class="line">1. AI generates commands: [&quot;z3ed palette export ...&quot;]</div>
<div class="line">2. AI executes commands in sandbox</div>
<div class="line">3. AI generates test: &quot;Verify soldier is red&quot;</div>
<div class="line">4. AI runs test → Gets test_id</div>
<div class="line">5. ??? AI has no way to check if test passed ???</div>
<div class="line">6. AI presents proposal to user blindly</div>
<div class="line">   (might be broken, AI doesn&#39;t know)</div>
<div class="line"> </div>
<div class="line">✅ WORKING: AI Agent With IT-05</div>
<div class="line">1. AI generates commands</div>
<div class="line">2. AI executes in sandbox</div>
<div class="line">3. AI generates verification test</div>
<div class="line">4. AI runs test → Gets test_id</div>
<div class="line">5. AI polls: GetTestStatus(test_id)</div>
<div class="line">6. Test FAILED? AI sees error + screenshot</div>
<div class="line">7. AI adjusts strategy and retries</div>
<div class="line">8. Test PASSED? AI presents successful proposal</div>
</div><!-- fragment --><p><b>This is the difference between</b>:</p><ul>
<li><b>Dumb automation</b>: Execute blindly, hope for the best</li>
<li><b>Intelligent agent</b>: Verify, learn, self-correct</li>
</ul>
<p><b>Benefits After IT-05</b>:</p><ul>
<li>✅ AI agents can reliably poll for test completion</li>
<li>✅ AI agents can read detailed failure messages</li>
<li>✅ AI agents can implement retry logic with adjusted strategies</li>
<li>✅ CLI can show real-time progress bars</li>
<li>✅ Test history enables trend analysis (flaky tests, performance regressions)</li>
<li>✅ Foundation for test recording/replay (IT-07)</li>
<li>✅ **Enables autonomous agent operation**ion API - Implementation Guide</li>
</ul>
<p><b>Status</b>: 📋 Planned | Priority 1 | Time Estimate: 6-8 hours <br  />
 <b>Dependencies</b>: IT-01 Complete ✅, IT-02 Complete ✅ <br  />
 <b>Blocking</b>: IT-06 (Widget Discovery needs introspection foundation)</p>
<h1><a class="anchor" id="autotoc_md1368"></a>
Overview</h1>
<p>Add test introspection capabilities to enable clients to query test execution status, list available tests, and retrieve detailed results. This is critical for AI agents to reliably poll for test completion and make decisions based on results.</p>
<h1><a class="anchor" id="autotoc_md1369"></a>
Motivation</h1>
<p><b>Current Limitations</b>:</p><ul>
<li>❌ Tests execute asynchronously with no way to query status</li>
<li>❌ Clients must poll blindly or give up early</li>
<li>❌ No visibility into test execution queue</li>
<li>❌ Results lost after test completion</li>
<li>❌ Can't track test history or identify flaky tests</li>
</ul>
<p><b>Benefits After IT-05</b></p>
<ul>
<li>✅ AI agents can reliably poll for test completion</li>
<li>✅ CLI can show real-time progress bars</li>
<li>✅ Test history enables trend analysis</li>
<li>✅ Foundation for test recording/replay (IT-07)</li>
</ul>
<h1><a class="anchor" id="autotoc_md1370"></a>
Architecture</h1>
<h2><a class="anchor" id="autotoc_md1371"></a>
New Service Components</h2>
<div class="fragment"><div class="line"><span class="comment">// src/app/core/test_manager.h</span></div>
<div class="line"><span class="keyword">class </span>TestManager {</div>
<div class="line">  <span class="comment">// Existing...</span></div>
<div class="line">  </div>
<div class="line">  <span class="comment">// NEW: Test tracking</span></div>
<div class="line">  <span class="keyword">struct </span>TestExecution {</div>
<div class="line">    std::string test_id;</div>
<div class="line">    std::string name;</div>
<div class="line">    std::string category;</div>
<div class="line">    TestStatus status;  <span class="comment">// QUEUED, RUNNING, PASSED, FAILED, TIMEOUT</span></div>
<div class="line">    int64_t queued_at_ms;</div>
<div class="line">    int64_t started_at_ms;</div>
<div class="line">    int64_t completed_at_ms;</div>
<div class="line">    int32_t execution_time_ms;</div>
<div class="line">    std::string error_message;</div>
<div class="line">    std::vector&lt;std::string&gt; assertion_failures;</div>
<div class="line">    std::vector&lt;std::string&gt; logs;</div>
<div class="line">  };</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// NEW: Test execution tracking</span></div>
<div class="line">  absl::StatusOr&lt;TestExecution&gt; GetTestStatus(<span class="keyword">const</span> std::string&amp; test_id);</div>
<div class="line">  std::vector&lt;TestExecution&gt; ListTests(<span class="keyword">const</span> std::string&amp; category_filter = <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line">  absl::StatusOr&lt;TestExecution&gt; GetTestResults(<span class="keyword">const</span> std::string&amp; test_id);</div>
<div class="line">  </div>
<div class="line"> <span class="keyword">private</span>:</div>
<div class="line">  <span class="comment">// NEW: Test execution history</span></div>
<div class="line">  std::map&lt;std::string, TestExecution&gt; test_history_;</div>
<div class="line">  absl::Mutex test_history_mutex_;  <span class="comment">// Thread-safe access</span></div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md1372"></a>
Proto Additions</h2>
<div class="fragment"><div class="line">// src/app/core/proto/imgui_test_harness.proto</div>
<div class="line"> </div>
<div class="line">// Add to service definition</div>
<div class="line">service ImGuiTestHarness {</div>
<div class="line">  // ... existing RPCs ...</div>
<div class="line">  </div>
<div class="line">  // NEW: Test introspection</div>
<div class="line">  rpc GetTestStatus(GetTestStatusRequest) returns (GetTestStatusResponse);</div>
<div class="line">  rpc ListTests(ListTestsRequest) returns (ListTestsResponse);</div>
<div class="line">  rpc GetTestResults(GetTestResultsRequest) returns (GetTestResultsResponse);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">// ============================================================================</div>
<div class="line">// GetTestStatus - Query test execution state</div>
<div class="line">// ============================================================================</div>
<div class="line"> </div>
<div class="line">message GetTestStatusRequest {</div>
<div class="line">  string test_id = 1;  // Test ID from Click/Type/Wait/Assert response</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">message GetTestStatusResponse {</div>
<div class="line">  enum Status {</div>
<div class="line">    UNKNOWN = 0;   // Test ID not found</div>
<div class="line">    QUEUED = 1;    // Waiting to execute</div>
<div class="line">    RUNNING = 2;   // Currently executing</div>
<div class="line">    PASSED = 3;    // Completed successfully</div>
<div class="line">    FAILED = 4;    // Assertion failed or error</div>
<div class="line">    TIMEOUT = 5;   // Exceeded timeout</div>
<div class="line">  }</div>
<div class="line">  </div>
<div class="line">  Status status = 1;</div>
<div class="line">  int64 queued_at_ms = 2;      // When test was queued</div>
<div class="line">  int64 started_at_ms = 3;     // When test started (0 if not started)</div>
<div class="line">  int64 completed_at_ms = 4;   // When test completed (0 if not complete)</div>
<div class="line">  int32 execution_time_ms = 5; // Total execution time</div>
<div class="line">  string error_message = 6;    // Error details if FAILED/TIMEOUT</div>
<div class="line">  repeated string assertion_failures = 7;  // Failed assertion details</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">// ============================================================================</div>
<div class="line">// ListTests - Enumerate available tests</div>
<div class="line">// ============================================================================</div>
<div class="line"> </div>
<div class="line">message ListTestsRequest {</div>
<div class="line">  string category_filter = 1;  // Optional: &quot;grpc&quot;, &quot;unit&quot;, &quot;integration&quot;, &quot;e2e&quot;</div>
<div class="line">  int32 page_size = 2;         // Number of results per page (default 100)</div>
<div class="line">  string page_token = 3;       // Pagination token from previous response</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">message ListTestsResponse {</div>
<div class="line">  repeated TestInfo tests = 1;</div>
<div class="line">  string next_page_token = 2;  // Token for next page (empty if no more)</div>
<div class="line">  int32 total_count = 3;       // Total number of matching tests</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">message TestInfo {</div>
<div class="line">  string test_id = 1;           // Unique test identifier</div>
<div class="line">  string name = 2;              // Human-readable test name</div>
<div class="line">  string category = 3;          // Category: grpc, unit, integration, e2e</div>
<div class="line">  int64 last_run_timestamp_ms = 4;  // When test last executed</div>
<div class="line">  int32 total_runs = 5;         // Total number of executions</div>
<div class="line">  int32 pass_count = 6;         // Number of successful runs</div>
<div class="line">  int32 fail_count = 7;         // Number of failed runs</div>
<div class="line">  int32 average_duration_ms = 8;  // Average execution time</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">// ============================================================================</div>
<div class="line">// GetTestResults - Retrieve detailed results</div>
<div class="line">// ============================================================================</div>
<div class="line"> </div>
<div class="line">message GetTestResultsRequest {</div>
<div class="line">  string test_id = 1;</div>
<div class="line">  bool include_logs = 2;  // Include full execution logs</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">message GetTestResultsResponse {</div>
<div class="line">  bool success = 1;         // Overall test result</div>
<div class="line">  string test_name = 2;</div>
<div class="line">  string category = 3;</div>
<div class="line">  int64 executed_at_ms = 4;</div>
<div class="line">  int32 duration_ms = 5;</div>
<div class="line">  </div>
<div class="line">  // Detailed results</div>
<div class="line">  repeated AssertionResult assertions = 6;</div>
<div class="line">  repeated string logs = 7;  // If include_logs=true</div>
<div class="line">  </div>
<div class="line">  // Performance metrics</div>
<div class="line">  map&lt;string, int32&gt; metrics = 8;  // e.g., &quot;frame_count&quot;: 123</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">message AssertionResult {</div>
<div class="line">  string description = 1;</div>
<div class="line">  bool passed = 2;</div>
<div class="line">  string expected_value = 3;</div>
<div class="line">  string actual_value = 4;</div>
<div class="line">  string error_message = 5;</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md1373"></a>
Implementation Steps</h1>
<h2><a class="anchor" id="autotoc_md1374"></a>
Step 1: Extend TestManager (✔️ Completed)</h2>
<p><b>What changed</b>:</p><ul>
<li>Introduced <code>HarnessTestExecution</code>, <code>HarnessTestSummary</code>, and related enums in <code><a class="el" href="../../d6/d5c/test__manager_8h.html">test_manager.h</a></code>.</li>
<li>Added registration, running, completion, log, and metric helpers with <code>absl::Mutex</code> guarding (<code>RegisterHarnessTest</code>, <code>MarkHarnessTestRunning</code>, <code>MarkHarnessTestCompleted</code>, etc.).</li>
<li>Stored executions in <code>harness_history_</code> + <code>harness_aggregates_</code> with deque-based trimming to avoid unbounded growth.</li>
</ul>
<p><b>Where to look</b>:</p><ul>
<li><code><a class="el" href="../../d6/d5c/test__manager_8h.html">src/app/test/test_manager.h</a></code> (see <em>Harness test introspection (IT-05)</em> section around <code>HarnessTestExecution</code>).</li>
<li><code><a class="el" href="../../d1/d2e/test__manager_8cc.html">src/app/test/test_manager.cc</a></code> (functions <code>RegisterHarnessTest</code>, <code>MarkHarnessTestCompleted</code>, <code>AppendHarnessTestLog</code>, <code>GetHarnessTestExecution</code>, <code>ListHarnessTestSummaries</code>).</li>
</ul>
<p><b>Next touch-ups</b>:</p><ul>
<li>Consider persisting assertion metadata (expected/actual) so <code>GetTestResults</code> can populate richer <code>AssertionResult</code> entries.</li>
<li>Decide on retention limit (<code>harness_history_limit_</code>) tuning once CLI consumption patterns are known.</li>
</ul>
<h3><a class="anchor" id="autotoc_md1375"></a>
1.2 Update Existing RPC Handlers</h3>
<p><b>File</b>: <code><a class="el" href="../../dd/d7f/imgui__test__harness__service_8cc.html">src/app/core/service/imgui_test_harness_service.cc</a></code></p>
<p>Modify Click, Type, Wait, Assert handlers to record test execution:</p>
<div class="fragment"><div class="line">absl::Status ImGuiTestHarnessServiceImpl::Click(</div>
<div class="line">    <span class="keyword">const</span> ClickRequest* request, ClickResponse* response) {</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// Generate unique test ID</span></div>
<div class="line">  std::string test_id = test_manager_-&gt;GenerateTestId(<span class="stringliteral">&quot;grpc_click&quot;</span>);</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// Record test start</span></div>
<div class="line">  test_manager_-&gt;RecordTestStart(</div>
<div class="line">      test_id, </div>
<div class="line">      absl::StrFormat(<span class="stringliteral">&quot;Click: %s&quot;</span>, request-&gt;target()),</div>
<div class="line">      <span class="stringliteral">&quot;grpc&quot;</span>);</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// ... existing implementation ...</span></div>
<div class="line">  </div>
<div class="line">  <span class="comment">// Record test completion</span></div>
<div class="line">  <span class="keywordflow">if</span> (success) {</div>
<div class="line">    test_manager_-&gt;RecordTestComplete(test_id, TestManager::TestStatus::PASSED);</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    test_manager_-&gt;RecordTestComplete(</div>
<div class="line">        test_id, TestManager::TestStatus::FAILED, error_message);</div>
<div class="line">  }</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// Add test ID to response (requires proto update)</span></div>
<div class="line">  response-&gt;set_test_id(test_id);</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">return</span> absl::OkStatus();</div>
<div class="line">}</div>
</div><!-- fragment --><p><b>Proto Update</b>: Add <code>test_id</code> field to all responses:</p>
<div class="fragment"><div class="line">message ClickResponse {</div>
<div class="line">  bool success = 1;</div>
<div class="line">  string message = 2;</div>
<div class="line">  int32 execution_time_ms = 3;</div>
<div class="line">  string test_id = 4;  // NEW: Unique test identifier for introspection</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">// Repeat for TypeResponse, WaitResponse, AssertResponse</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md1376"></a>
Step 2: Implement Introspection RPCs (✔️ Completed)</h2>
<p><b>What changed</b>:</p><ul>
<li>Added helper utilities (<code>ConvertHarnessStatus</code>, <code>ToUnixMillisSafe</code>, <code>ClampDurationToInt32</code>) in <code><a class="el" href="../../dd/d7f/imgui__test__harness__service_8cc.html">imgui_test_harness_service.cc</a></code>.</li>
<li>Implemented <code>GetTestStatus</code>, <code>ListTests</code>, and <code>GetTestResults</code> with pagination, optional log inclusion, and structured metrics.mapping.</li>
<li>Updated gRPC wrapper to surface new RPCs and translate Abseil status codes into gRPC codes.</li>
<li>Ensured deque-backed <code>DynamicTestData</code> keep-alive remains bounded while reusing new tracking helpers.</li>
</ul>
<p><b>Where to look</b>:</p><ul>
<li><code><a class="el" href="../../dd/d7f/imgui__test__harness__service_8cc.html">src/app/core/service/imgui_test_harness_service.cc</a></code> (search for <code>GetTestStatus(</code>, <code>ListTests(</code>, <code>GetTestResults(</code>).</li>
<li><code><a class="el" href="../../d9/d30/imgui__test__harness__service_8h.html">src/app/core/service/imgui_test_harness_service.h</a></code> (new method declarations).</li>
</ul>
<p><b>Follow-ups</b>:</p><ul>
<li>Expand <code>AssertionResult</code> population once <code>TestManager</code> captures structured expected/actual data.</li>
<li>Evaluate pagination defaults (<code>page_size</code>, <code>page_token</code>) once CLI usage patterns are seen.</li>
</ul>
<h2><a class="anchor" id="autotoc_md1377"></a>
Step 3: CLI Integration (🚧 TODO)</h2>
<p>Goal: expose the new RPCs through <code>GuiAutomationClient</code> and user-facing <code>z3ed agent test</code> subcommands. The pseudo-code below illustrates the desired flow; implementation still pending.</p>
<p><b>File</b>: <code><a class="el" href="../../d2/d0e/agent_8cc.html">src/cli/handlers/agent.cc</a></code></p>
<p>Add new CLI commands for test introspection:</p>
<div class="fragment"><div class="line"><span class="comment">// z3ed agent test status --test-id &lt;id&gt; [--follow]</span></div>
<div class="line">absl::Status HandleAgentTestStatus(<span class="keyword">const</span> CommandOptions&amp; options) {</div>
<div class="line">  <span class="keyword">const</span> std::string test_id = absl::GetFlag(FLAGS_test_id);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">bool</span> follow = absl::GetFlag(FLAGS_follow);</div>
<div class="line">  </div>
<div class="line">  GuiAutomationClient client(<span class="stringliteral">&quot;localhost&quot;</span>, 50052);</div>
<div class="line">  <a class="code hl_define" href="../../d4/d9e/macro_8h.html#a755e0e0d964b4d81ae730d174c5fa3ce">RETURN_IF_ERROR</a>(client.Connect());</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">while</span> (<span class="keyword">true</span>) {</div>
<div class="line">    <span class="keyword">auto</span> status_or = client.GetTestStatus(test_id);</div>
<div class="line">    <a class="code hl_define" href="../../d4/d9e/macro_8h.html#a755e0e0d964b4d81ae730d174c5fa3ce">RETURN_IF_ERROR</a>(status_or.status());</div>
<div class="line">    </div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; status = status_or.value();</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Print status</span></div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Test ID: &quot;</span> &lt;&lt; test_id &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Status: &quot;</span> &lt;&lt; StatusToString(status.status) &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Execution Time: &quot;</span> &lt;&lt; status.execution_time_ms &lt;&lt; <span class="stringliteral">&quot;ms\n&quot;</span>;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (status.status == TestStatus::PASSED ||</div>
<div class="line">        status.status == TestStatus::FAILED ||</div>
<div class="line">        status.status == TestStatus::TIMEOUT) {</div>
<div class="line">      <span class="keywordflow">break</span>;  <span class="comment">// Terminal state</span></div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (!follow) <span class="keywordflow">break</span>;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Poll every 500ms</span></div>
<div class="line">    absl::SleepFor(absl::Milliseconds(500));</div>
<div class="line">  }</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">return</span> absl::OkStatus();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// z3ed agent test results --test-id &lt;id&gt; [--format json] [--include-logs]</span></div>
<div class="line">absl::Status HandleAgentTestResults(<span class="keyword">const</span> CommandOptions&amp; options) {</div>
<div class="line">  <span class="keyword">const</span> std::string test_id = absl::GetFlag(FLAGS_test_id);</div>
<div class="line">  <span class="keyword">const</span> std::string format = absl::GetFlag(FLAGS_format);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">bool</span> include_logs = absl::GetFlag(FLAGS_include_logs);</div>
<div class="line">  </div>
<div class="line">  GuiAutomationClient client(<span class="stringliteral">&quot;localhost&quot;</span>, 50052);</div>
<div class="line">  <a class="code hl_define" href="../../d4/d9e/macro_8h.html#a755e0e0d964b4d81ae730d174c5fa3ce">RETURN_IF_ERROR</a>(client.Connect());</div>
<div class="line">  </div>
<div class="line">  <span class="keyword">auto</span> results_or = client.GetTestResults(test_id, include_logs);</div>
<div class="line">  <a class="code hl_define" href="../../d4/d9e/macro_8h.html#a755e0e0d964b4d81ae730d174c5fa3ce">RETURN_IF_ERROR</a>(results_or.status());</div>
<div class="line">  </div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span>&amp; results = results_or.value();</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">if</span> (format == <span class="stringliteral">&quot;json&quot;</span>) {</div>
<div class="line">    <span class="comment">// Output JSON</span></div>
<div class="line">    PrintTestResultsJson(results);</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    <span class="comment">// Output YAML (default)</span></div>
<div class="line">    PrintTestResultsYaml(results);</div>
<div class="line">  }</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">return</span> absl::OkStatus();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// z3ed agent test list [--category &lt;name&gt;] [--status &lt;filter&gt;]</span></div>
<div class="line">absl::Status HandleAgentTestList(<span class="keyword">const</span> CommandOptions&amp; options) {</div>
<div class="line">  <span class="keyword">const</span> std::string category = absl::GetFlag(FLAGS_category);</div>
<div class="line">  <span class="keyword">const</span> std::string status_filter = absl::GetFlag(FLAGS_status);</div>
<div class="line">  </div>
<div class="line">  GuiAutomationClient client(<span class="stringliteral">&quot;localhost&quot;</span>, 50052);</div>
<div class="line">  <a class="code hl_define" href="../../d4/d9e/macro_8h.html#a755e0e0d964b4d81ae730d174c5fa3ce">RETURN_IF_ERROR</a>(client.Connect());</div>
<div class="line">  </div>
<div class="line">  <span class="keyword">auto</span> tests_or = client.ListTests(category);</div>
<div class="line">  <a class="code hl_define" href="../../d4/d9e/macro_8h.html#a755e0e0d964b4d81ae730d174c5fa3ce">RETURN_IF_ERROR</a>(tests_or.status());</div>
<div class="line">  </div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span>&amp; tests = tests_or.value();</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// Print table</span></div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;=== Test List ===\n\n&quot;</span>;</div>
<div class="line">  std::cout &lt;&lt; absl::StreamFormat(<span class="stringliteral">&quot;%-20s %-30s %-10s %-10s\n&quot;</span>,</div>
<div class="line">                                   <span class="stringliteral">&quot;Test ID&quot;</span>, <span class="stringliteral">&quot;Name&quot;</span>, <span class="stringliteral">&quot;Category&quot;</span>, <span class="stringliteral">&quot;Status&quot;</span>);</div>
<div class="line">  std::cout &lt;&lt; std::string(80, <span class="charliteral">&#39;-&#39;</span>) &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; test : tests) {</div>
<div class="line">    std::cout &lt;&lt; absl::StreamFormat(<span class="stringliteral">&quot;%-20s %-30s %-10s %-10s\n&quot;</span>,</div>
<div class="line">                                     test.test_id, test.name, test.category,</div>
<div class="line">                                     StatusToString(test.last_status));</div>
<div class="line">  }</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">return</span> absl::OkStatus();</div>
<div class="line">}</div>
<div class="ttc" id="amacro_8h_html_a755e0e0d964b4d81ae730d174c5fa3ce"><div class="ttname"><a href="../../d4/d9e/macro_8h.html#a755e0e0d964b4d81ae730d174c5fa3ce">RETURN_IF_ERROR</a></div><div class="ttdeci">#define RETURN_IF_ERROR(expression)</div><div class="ttdef"><b>Definition</b> <a href="../../d4/d9e/macro_8h_source.html#l00053">macro.h:53</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md1378"></a>
Step 4: Testing &amp; Validation (🚧 TODO)</h2>
<h3><a class="anchor" id="autotoc_md1379"></a>
Test Script: &lt;tt&gt;scripts/test_introspection_e2e.sh&lt;/tt&gt;</h3>
<div class="fragment"><div class="line">#!/bin/bash</div>
<div class="line"># Test introspection API</div>
<div class="line"> </div>
<div class="line">set -e</div>
<div class="line"> </div>
<div class="line"># Start YAZE</div>
<div class="line">./build-grpc-test/bin/yaze.app/Contents/MacOS/yaze \</div>
<div class="line">  --enable_test_harness \</div>
<div class="line">  --test_harness_port=50052 \</div>
<div class="line">  --rom_file=assets/zelda3.sfc &amp;</div>
<div class="line"> </div>
<div class="line">YAZE_PID=$!</div>
<div class="line">sleep 3</div>
<div class="line"> </div>
<div class="line"># Test 1: Run a test and capture test ID</div>
<div class="line">echo &quot;Test 1: GetTestStatus&quot;</div>
<div class="line">TEST_ID=$(z3ed agent test --prompt &quot;Open Overworld&quot; --output json | jq -r &#39;.test_id&#39;)</div>
<div class="line">echo &quot;Test ID: $TEST_ID&quot;</div>
<div class="line"> </div>
<div class="line"># Test 2: Poll for status</div>
<div class="line">echo &quot;Test 2: Poll status&quot;</div>
<div class="line">z3ed agent test status --test-id $TEST_ID --follow</div>
<div class="line"> </div>
<div class="line"># Test 3: Get results</div>
<div class="line">echo &quot;Test 3: Get results&quot;</div>
<div class="line">z3ed agent test results --test-id $TEST_ID --format yaml --include-logs</div>
<div class="line"> </div>
<div class="line"># Test 4: List all tests</div>
<div class="line">echo &quot;Test 4: List tests&quot;</div>
<div class="line">z3ed agent test list --category grpc</div>
<div class="line"> </div>
<div class="line"># Cleanup</div>
<div class="line">kill $YAZE_PID</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md1380"></a>
Success Criteria</h1>
<ul>
<li>[x] All 3 new RPCs respond correctly ✅</li>
<li>[x] Test IDs returned in Click/Type/Wait/Assert responses ✅</li>
<li>[x] Status polling works with <code>--follow</code> flag ✅</li>
<li>[x] Test history persists across multiple test runs ✅</li>
<li>[x] CLI commands output clean YAML/JSON ✅</li>
<li>[x] No memory leaks in test history tracking (bounded deque + pruning) ✅</li>
<li>[x] Thread-safe access to test history (mutex-protected) ✅</li>
<li>[x] Documentation updated in <code><a class="el" href="../../db/d7d/E6-z3ed-reference_8md.html">E6-z3ed-reference.md</a></code> ✅</li>
<li>[x] E2E test script validates complete workflow ✅</li>
</ul>
<h1><a class="anchor" id="autotoc_md1381"></a>
Migration Guide</h1>
<p><b>For Existing Code</b>:</p><ul>
<li>No breaking changes - new RPCs only</li>
<li>Existing tests continue to work</li>
<li>Test ID field added to responses (backwards compatible)</li>
</ul>
<p><b>For CLI Users</b>: </p><div class="fragment"><div class="line"># Old: Test runs, no way to check status</div>
<div class="line">z3ed agent test --prompt &quot;Open Overworld&quot;</div>
<div class="line"> </div>
<div class="line"># New: Get test ID, poll for status</div>
<div class="line">TEST_ID=$(z3ed agent test --prompt &quot;Open Overworld&quot; --output json | jq -r &#39;.test_id&#39;)</div>
<div class="line">z3ed agent test status --test-id $TEST_ID --follow</div>
<div class="line">z3ed agent test results --test-id $TEST_ID</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md1382"></a>
Next Steps</h1>
<p>After IT-05 completion:</p><ol type="1">
<li><b>IT-06</b>: Widget Discovery API (uses introspection foundation)</li>
<li><b>IT-07</b>: Test Recording &amp; Replay (records test IDs and results)</li>
<li><b>IT-08</b>: Enhanced Error Reporting (captures test context on failure)</li>
</ol>
<h1><a class="anchor" id="autotoc_md1383"></a>
References</h1>
<ul>
<li><b>Proto Definition</b>: <code>src/app/core/proto/imgui_test_harness.proto</code></li>
<li><b>Test Manager</b>: <code>src/app/core/test_manager.{h,cc}</code></li>
<li><b>RPC Service</b>: <code>src/app/core/service/imgui_test_harness_service.{h,cc}</code></li>
<li><b>CLI Handlers</b>: <code><a class="el" href="../../d2/d0e/agent_8cc.html">src/cli/handlers/agent.cc</a></code></li>
<li><b>Main Plan</b>: <code><a class="el" href="../../df/d90/E6-z3ed-implementation-plan_8md.html">docs/z3ed/E6-z3ed-implementation-plan.md</a></code></li>
</ul>
<hr  />
<p><b>Author</b>: @scawful, GitHub Copilot <br  />
 <b>Created</b>: October 2, 2025 <br  />
 <b>Status</b>: In progress (server-side complete; CLI + E2E pending) </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
