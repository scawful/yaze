<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>yaze: Canvas Coordinate Synchronization and Scroll Fix</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript">var page_layout=1;</script>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="side-nav" class="ui-resizable side-nav-resizable"><!-- do not remove this div, it is closed by doxygen! -->
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../yaze.ico"/></td>
  <td id="projectalign">
   <div id="projectname">yaze<span id="projectnumber">&#160;0.3.2</span>
   </div>
   <div id="projectbrief">Link to the Past ROM Editor</div>
  </td>
 </tr>
   <tr><td colspan="2">        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.svg" alt=""/></a>
          </span>
        </div>
</td></tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d5/db9/md_docs_2G4-canvas-coordinate-fix.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Canvas Coordinate Synchronization and Scroll Fix</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md1381"></a> <b>Date</b>: October 10, 2025 <b>Issues</b>:</p><ol type="1">
<li>Overworld map highlighting regression after canvas refactoring</li>
<li>Overworld canvas scrolling unexpectedly when selecting tiles</li>
<li>Vanilla Dark/Special World large map outlines not displaying <b>Status</b>: Fixed</li>
</ol>
<h1><a class="anchor" id="autotoc_md1382"></a>
Problem Summary</h1>
<p>After the canvas refactoring (commits f538775954, 60ddf76331), two critical bugs appeared:</p>
<ol type="1">
<li><b>Map highlighting broken</b>: The overworld editor stopped properly highlighting the current map when hovering. The map highlighting only worked during active tile painting, not during normal mouse hover.</li>
<li><b>Wrong canvas scrolling</b>: When right-clicking to select tiles (especially on Dark World), the overworld canvas would scroll unexpectedly instead of the tile16 blockset selector.</li>
</ol>
<h1><a class="anchor" id="autotoc_md1383"></a>
Root Cause</h1>
<p>The regression had <b>FIVE</b> issues:</p>
<h2><a class="anchor" id="autotoc_md1384"></a>
Issue 1: Wrong Coordinate System (Line 1041)</h2>
<p><b>File</b>: <code><a class="el" href="../../d9/d8a/overworld__editor_8cc.html">src/app/editor/overworld/overworld_editor.cc</a>:1041</code></p>
<p><b>Before (BROKEN)</b>: </p><div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keyword">auto</span> mouse_position = ImGui::GetIO().MousePos;  <span class="comment">// ❌ Screen coordinates!</span></div>
<div class="line"><span class="keyword">const</span> <span class="keyword">auto</span> canvas_zero_point = ow_map_canvas_.zero_point();</div>
<div class="line"><span class="keywordtype">int</span> map_x = (mouse_position.x - canvas_zero_point.x) / kOverworldMapSize;</div>
</div><!-- fragment --><p><b>After (FIXED)</b>: </p><div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keyword">auto</span> mouse_position = ow_map_canvas_.hover_mouse_pos();  <span class="comment">//  World coordinates!</span></div>
<div class="line"><span class="keywordtype">int</span> map_x = mouse_position.x / kOverworldMapSize;</div>
</div><!-- fragment --><p><b>Why This Was Wrong</b>:</p><ul>
<li><code>ImGui::GetIO().MousePos</code> returns <b>screen space</b> coordinates (absolute position on screen)</li>
<li>The canvas may be scrolled, scaled, or positioned anywhere on screen</li>
<li>Screen coordinates don't account for canvas scrolling/offset</li>
<li><code>hover_mouse_pos()</code> returns <b>canvas/world space</b> coordinates (relative to canvas content)</li>
</ul>
<h2><a class="anchor" id="autotoc_md1385"></a>
Issue 2: Hover Position Not Updated (Line 416)</h2>
<p><b>File</b>: <code>src/app/gui/canvas.cc:416</code></p>
<p><b>Before (BROKEN)</b>: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> Canvas::DrawBackground(ImVec2 canvas_size) {</div>
<div class="line">  <span class="comment">// ... setup code ...</span></div>
<div class="line">  ImGui::InvisibleButton(canvas_id_.c_str(), scaled_size, kMouseFlags);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// ❌ mouse_pos_in_canvas_ only updated in DrawTilePainter() during painting!</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (config_.is_draggable &amp;&amp; IsItemHovered()) {</div>
<div class="line">    <span class="comment">// ... pan handling ...</span></div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p><code>mouse_pos_in_canvas_</code> was only updated inside painting methods:</p><ul>
<li><code>DrawTilePainter()</code> at line 741</li>
<li><code>DrawSolidTilePainter()</code> at line 860</li>
<li><code>DrawTileSelector()</code> at line 929</li>
</ul>
<p><b>After (FIXED)</b>: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> Canvas::DrawBackground(ImVec2 canvas_size) {</div>
<div class="line">  <span class="comment">// ... setup code ...</span></div>
<div class="line">  ImGui::InvisibleButton(canvas_id_.c_str(), scaled_size, kMouseFlags);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//  CRITICAL FIX: Always update hover position when hovering</span></div>
<div class="line">  <span class="keywordflow">if</span> (IsItemHovered()) {</div>
<div class="line">    <span class="keyword">const</span> ImGuiIO&amp; io = GetIO();</div>
<div class="line">    <span class="keyword">const</span> ImVec2 origin(canvas_p0_.x + scrolling_.x, canvas_p0_.y + scrolling_.y);</div>
<div class="line">    <span class="keyword">const</span> ImVec2 mouse_pos(io.MousePos.x - origin.x, io.MousePos.y - origin.y);</div>
<div class="line">    mouse_pos_in_canvas_ = mouse_pos;  <span class="comment">//  Updated every frame during hover</span></div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (config_.is_draggable &amp;&amp; IsItemHovered()) {</div>
<div class="line">    <span class="comment">// ... pan handling ...</span></div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md1386"></a>
Technical Details</h1>
<h2><a class="anchor" id="autotoc_md1387"></a>
Coordinate Spaces</h2>
<p>yaze has three coordinate spaces:</p>
<ol type="1">
<li><b>Screen Space</b>: Absolute pixel coordinates on the monitor<ul>
<li><code>ImGui::GetIO().MousePos</code> returns this</li>
<li>Never use this for canvas operations!</li>
</ul>
</li>
<li><b>Canvas/World Space</b>: Coordinates relative to canvas content<ul>
<li>Accounts for canvas scrolling and offset</li>
<li><code>Canvas::hover_mouse_pos()</code> returns this</li>
<li>Use this for map calculations, entity positioning, etc.</li>
</ul>
</li>
<li><b>Tile/Grid Space</b>: Coordinates in tile units (not pixels)<ul>
<li><code>Canvas::CanvasToTile()</code> converts from canvas to grid space</li>
<li>Used by automation API</li>
</ul>
</li>
</ol>
<h2><a class="anchor" id="autotoc_md1388"></a>
Usage Patterns</h2>
<p><b>For Hover/Highlighting</b> (CheckForCurrentMap): </p><div class="fragment"><div class="line"><span class="keyword">auto</span> hover_pos = canvas.hover_mouse_pos();  <span class="comment">//  Updates continuously</span></div>
<div class="line"><span class="keywordtype">int</span> map_x = hover_pos.x / kOverworldMapSize;</div>
</div><!-- fragment --><p><b>For Active Painting</b> (DrawOverworldEdits): </p><div class="fragment"><div class="line"><span class="keyword">auto</span> paint_pos = canvas.drawn_tile_position();  <span class="comment">//  Updates only during drag</span></div>
<div class="line"><span class="keywordtype">int</span> map_x = paint_pos.x / kOverworldMapSize;</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md1389"></a>
Testing</h1>
<h2><a class="anchor" id="autotoc_md1390"></a>
Visual Testing</h2>
<p><b>Map Highlighting Test</b>:</p><ol type="1">
<li>Open overworld editor</li>
<li>Hover mouse over different maps (without clicking)</li>
<li>Verify current map highlights correctly</li>
<li>Test with different scale levels (0.25x - 4.0x)</li>
<li>Test with scrolled canvas</li>
</ol>
<p><b>Scroll Regression Test</b>:</p><ol type="1">
<li>Open overworld editor</li>
<li>Switch to Dark World (or any world)</li>
<li>Right-click on overworld canvas to select a tile</li>
<li><b>Expected</b>: Tile16 blockset selector scrolls to show the selected tile</li>
<li><b>Expected</b>: Overworld canvas does NOT scroll</li>
<li>❌ <b>Before fix</b>: Overworld canvas would scroll unexpectedly</li>
</ol>
<h2><a class="anchor" id="autotoc_md1391"></a>
Unit Tests</h2>
<p>Created <code><a class="el" href="../../d5/df9/canvas__coordinate__sync__test_8cc.html">test/unit/gui/canvas_coordinate_sync_test.cc</a></code> with regression tests:</p><ul>
<li><code>HoverMousePos_IndependentFromDrawnPos</code>: Verifies hover vs paint separation</li>
<li><code>CoordinateSpace_WorldNotScreen</code>: Ensures world coordinates used</li>
<li><code>MapCalculation_SmallMaps</code>: Tests 512x512 map boundaries</li>
<li><code>MapCalculation_LargeMaps</code>: Tests 1024x1024 v3 ASM maps</li>
<li><code>OverworldMapHighlight_UsesHoverNotDrawn</code>: Critical regression test</li>
<li><code>OverworldMapIndex_From8x8Grid</code>: Tests all three worlds (Light/Dark/Special)</li>
</ul>
<p>Run tests: </p><div class="fragment"><div class="line">./build/bin/yaze_test --unit</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md1392"></a>
Impact Analysis</h1>
<h2><a class="anchor" id="autotoc_md1393"></a>
Files Changed</h2>
<ol type="1">
<li><code><a class="el" href="../../d9/d8a/overworld__editor_8cc.html">src/app/editor/overworld/overworld_editor.cc</a></code> (line 1041-1049)<ul>
<li>Changed from screen coordinates to canvas hover coordinates</li>
<li>Removed incorrect <code>canvas_zero_point</code> subtraction</li>
</ul>
</li>
<li><code>src/app/gui/canvas.cc</code> (line 414-421)<ul>
<li>Added continuous hover position tracking in <code>DrawBackground()</code></li>
<li>Now updates <code>mouse_pos_in_canvas_</code> every frame when hovering</li>
</ul>
</li>
<li><code><a class="el" href="../../d9/d8a/overworld__editor_8cc.html">src/app/editor/overworld/overworld_editor.cc</a></code> (line 2344-2360)<ul>
<li>Removed fallback scroll code that scrolled the wrong canvas</li>
<li>Now only uses <code>blockset_selector_-&gt;ScrollToTile()</code> which targets the correct canvas</li>
</ul>
</li>
<li><code><a class="el" href="../../d9/d8a/overworld__editor_8cc.html">src/app/editor/overworld/overworld_editor.cc</a></code> (line 1403-1408)<ul>
<li>Changed from <code>ImGui::IsItemHovered()</code> (checks last drawn item)</li>
<li>To <code>ow_map_canvas_.IsMouseHovering()</code> (checks canvas hover state directly)</li>
</ul>
</li>
<li><code><a class="el" href="../../d9/d8a/overworld__editor_8cc.html">src/app/editor/overworld/overworld_editor.cc</a></code> (line 1133-1151)<ul>
<li>Added world offset subtraction for vanilla large map parent coordinates</li>
<li>Now properly accounts for Dark World (0x40-0x7F) and Special World (0x80-0x9F)</li>
</ul>
</li>
</ol>
<h2><a class="anchor" id="autotoc_md1394"></a>
Affected Functionality</h2>
<ul>
<li><b>Fixed</b>: Overworld map highlighting during hover (all worlds, all ROM types)</li>
<li><b>Fixed</b>: Vanilla Dark World large map highlighting (was drawing off-screen)</li>
<li><b>Fixed</b>: Vanilla Special World large map highlighting (was drawing off-screen)</li>
<li><b>Fixed</b>: Overworld canvas no longer scrolls when selecting tiles</li>
<li><b>Fixed</b>: Tile16 selector properly scrolls to show selected tile (via blockset_selector_)</li>
<li><b>Fixed</b>: Entity renderer using <code>hover_mouse_pos()</code> (already worked correctly)</li>
<li><b>Preserved</b>: Tile painting using <code>drawn_tile_position()</code> (unchanged)</li>
<li><b>Preserved</b>: Multi-area map support (512x512, 1024x1024)</li>
<li><b>Preserved</b>: All three worlds (Light 0x00-0x3F, Dark 0x40-0x7F, Special 0x80+)</li>
<li><b>Preserved</b>: ZSCustomOverworld v3 large maps (already worked correctly)</li>
</ul>
<h2><a class="anchor" id="autotoc_md1395"></a>
Related Code That Works Correctly</h2>
<p>These files already use the correct pattern:</p><ul>
<li><code><a class="el" href="../../d2/dae/overworld__entity__renderer_8cc.html">src/app/editor/overworld/overworld_entity_renderer.cc</a>:68-69</code> - Uses <code>hover_mouse_pos()</code> for entity placement</li>
<li><code><a class="el" href="../../d9/d8a/overworld__editor_8cc.html">src/app/editor/overworld/overworld_editor.cc</a>:664</code> - Uses <code>drawn_tile_position()</code> for painting</li>
</ul>
<h1><a class="anchor" id="autotoc_md1396"></a>
Multi-Area Map Support</h1>
<p>The fix properly handles all area sizes:</p>
<h2><a class="anchor" id="autotoc_md1397"></a>
Standard Maps (512x512)</h2>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> map_x = hover_pos.x / 512;  <span class="comment">// 0-7 range</span></div>
<div class="line"><span class="keywordtype">int</span> map_y = hover_pos.y / 512;  <span class="comment">// 0-7 range</span></div>
<div class="line"><span class="keywordtype">int</span> map_index = map_x + map_y * 8;  <span class="comment">// 0-63 (8x8 grid)</span></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md1398"></a>
ZSCustomOverworld v3 Large Maps (1024x1024)</h2>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> map_x = hover_pos.x / 1024;  <span class="comment">// Large map X</span></div>
<div class="line"><span class="keywordtype">int</span> map_y = hover_pos.y / 1024;  <span class="comment">// Large map Y</span></div>
<div class="line"><span class="comment">// Parent map calculation handled in lines 1073-1190</span></div>
</div><!-- fragment --><p>The existing multi-area logic (lines 1068-1190) remains unchanged and works correctly with the fix.</p>
<h1><a class="anchor" id="autotoc_md1399"></a>
Issue 3: Wrong Canvas Being Scrolled (Line 2344-2366)</h1>
<p><b>File</b>: <code><a class="el" href="../../d9/d8a/overworld__editor_8cc.html">src/app/editor/overworld/overworld_editor.cc</a>:2344</code></p>
<p><b>Problem</b>: When selecting tiles with right-click on the overworld canvas, <code>ScrollBlocksetCanvasToCurrentTile()</code> was calling <code>ImGui::SetScrollX/Y()</code> which scrolls <b>the current <a class="el" href="../../df/de4/namespaceImGui.html">ImGui</a> window</b>, not a specific canvas.</p>
<p><b>Call Stack</b>: </p><div class="fragment"><div class="line">DrawOverworldCanvas()                    // Overworld canvas is current window</div>
<div class="line">  └─ CheckForOverworldEdits() (line 1401)</div>
<div class="line">      └─ CheckForSelectRectangle() (line 793)</div>
<div class="line">          └─ ScrollBlocksetCanvasToCurrentTile() (line 916)</div>
<div class="line">              └─ ImGui::SetScrollX/Y() (lines 2364-2365)  // ❌ Scrolls CURRENT window!</div>
</div><!-- fragment --><p><b>Before (BROKEN)</b>: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> OverworldEditor::ScrollBlocksetCanvasToCurrentTile() {</div>
<div class="line">  <span class="keywordflow">if</span> (blockset_selector_) {</div>
<div class="line">    blockset_selector_-&gt;ScrollToTile(current_tile16_);</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Fallback: maintain legacy behavior when the selector is unavailable.</span></div>
<div class="line">  <span class="keyword">constexpr</span> <span class="keywordtype">int</span> kTilesPerRow = 8;</div>
<div class="line">  <span class="keyword">constexpr</span> <span class="keywordtype">int</span> kTileDisplaySize = 32;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">int</span> tile_col = current_tile16_ % kTilesPerRow;</div>
<div class="line">  <span class="keywordtype">int</span> tile_row = current_tile16_ / kTilesPerRow;</div>
<div class="line">  <span class="keywordtype">float</span> tile_x = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(tile_col * kTileDisplaySize);</div>
<div class="line">  <span class="keywordtype">float</span> tile_y = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(tile_row * kTileDisplaySize);</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">const</span> ImVec2 window_size = ImGui::GetWindowSize();</div>
<div class="line">  <span class="keywordtype">float</span> scroll_x = tile_x - (window_size.x / 2.0F) + (kTileDisplaySize / 2.0F);</div>
<div class="line">  <span class="keywordtype">float</span> scroll_y = tile_y - (window_size.y / 2.0F) + (kTileDisplaySize / 2.0F);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// ❌ BUG: This scrolls whatever ImGui window is currently active!</span></div>
<div class="line">  <span class="comment">// When called from overworld canvas, it scrolls the overworld instead of tile16 selector!</span></div>
<div class="line">  ImGui::SetScrollX(std::max(0.0f, scroll_x));</div>
<div class="line">  ImGui::SetScrollY(std::max(0.0f, scroll_y));</div>
<div class="line">}</div>
</div><!-- fragment --><p><b>After (FIXED)</b>: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> OverworldEditor::ScrollBlocksetCanvasToCurrentTile() {</div>
<div class="line">  <span class="keywordflow">if</span> (blockset_selector_) {</div>
<div class="line">    blockset_selector_-&gt;ScrollToTile(current_tile16_);  <span class="comment">//  Correct: Targets specific canvas</span></div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//  CRITICAL FIX: Do NOT use fallback scrolling from overworld canvas context!</span></div>
<div class="line">  <span class="comment">// The fallback code uses ImGui::SetScrollX/Y which scrolls the CURRENT window,</span></div>
<div class="line">  <span class="comment">// and when called from CheckForSelectRectangle() during overworld canvas rendering,</span></div>
<div class="line">  <span class="comment">// it incorrectly scrolls the overworld canvas instead of the tile16 selector.</span></div>
<div class="line">  <span class="comment">//</span></div>
<div class="line">  <span class="comment">// The blockset_selector_ should always be available in modern code paths.</span></div>
<div class="line">  <span class="comment">// If it&#39;s not available, we skip scrolling rather than scroll the wrong window.</span></div>
<div class="line">}</div>
</div><!-- fragment --><p><b>Why This Fixes It</b>:</p><ul>
<li>The modern <code>blockset_selector_-&gt;ScrollToTile()</code> targets the specific tile16 selector canvas</li>
<li>The fallback <code>ImGui::SetScrollX/Y()</code> has no context - it just scrolls the active window</li>
<li>By removing the fallback, we prevent scrolling the wrong canvas</li>
<li>If <code>blockset_selector_</code> is null (shouldn't happen in modern builds), we safely do nothing instead of breaking user interaction</li>
</ul>
<h1><a class="anchor" id="autotoc_md1400"></a>
Issue 4: Wrong Hover Check (Line 1403)</h1>
<p><b>File</b>: <code><a class="el" href="../../d9/d8a/overworld__editor_8cc.html">src/app/editor/overworld/overworld_editor.cc</a>:1403</code></p>
<p><b>Problem</b>: The code was using <code>ImGui::IsItemHovered()</code> to check if the mouse was over the canvas, but this checks the <b>last drawn <a class="el" href="../../df/de4/namespaceImGui.html">ImGui</a> item</b>, which could be entities, overlays, or anything drawn after the canvas's InvisibleButton. This meant hover detection was completely broken.</p>
<p><b>Call Stack</b>: </p><div class="fragment"><div class="line">DrawOverworldCanvas()</div>
<div class="line">  └─ DrawBackground() at line 1350            // Creates InvisibleButton (item A)</div>
<div class="line">  └─ DrawExits/Entrances/Items/Sprites()     // Draws entities (items B, C, D...)</div>
<div class="line">  └─ DrawOverlayPreviewOnMap()               // Draws overlay (item E)</div>
<div class="line">  └─ IsItemHovered() at line 1403            // ❌ Checks item E, not item A!</div>
</div><!-- fragment --><p><b>Before (BROKEN)</b>: </p><div class="fragment"><div class="line"><span class="keywordflow">if</span> (current_mode == EditingMode::DRAW_TILE) {</div>
<div class="line">  CheckForOverworldEdits();</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">if</span> (IsItemHovered())  <span class="comment">// ❌ Checks LAST item (overlay/entity), not canvas!</span></div>
<div class="line">  status_ = CheckForCurrentMap();</div>
</div><!-- fragment --><p><b>After (FIXED)</b>: </p><div class="fragment"><div class="line"><span class="keywordflow">if</span> (current_mode == EditingMode::DRAW_TILE) {</div>
<div class="line">  CheckForOverworldEdits();</div>
<div class="line">}</div>
<div class="line"><span class="comment">//  CRITICAL FIX: Use canvas hover state, not ImGui::IsItemHovered()</span></div>
<div class="line"><span class="comment">// IsItemHovered() checks the LAST drawn item, which could be entities/overlay,</span></div>
<div class="line"><span class="comment">// not the canvas InvisibleButton. ow_map_canvas_.IsMouseHovering() correctly</span></div>
<div class="line"><span class="comment">// tracks whether mouse is over the canvas area.</span></div>
<div class="line"><span class="keywordflow">if</span> (ow_map_canvas_.IsMouseHovering())  <span class="comment">//  Checks canvas hover state directly</span></div>
<div class="line">  status_ = CheckForCurrentMap();</div>
</div><!-- fragment --><p><b>Why This Fixes It</b>:</p><ul>
<li><code>IsItemHovered()</code> is context-sensitive - it checks whatever the last <code><a class="el" href="../../df/de4/namespaceImGui.html">ImGui</a>::*()</code> call was</li>
<li>After drawing entities and overlays, the "last item" is NOT the canvas</li>
<li><code>Canvas::IsMouseHovering()</code> tracks the hover state from the InvisibleButton in <code>DrawBackground()</code></li>
<li>This state is set correctly when the InvisibleButton is hovered (line 416 in <a class="el" href="../../da/dbb/canvas_8cc.html">canvas.cc</a>)</li>
</ul>
<h1><a class="anchor" id="autotoc_md1401"></a>
Issue 5: Vanilla Large Map World Offset (Line 1132-1136)</h1>
<p><b>File</b>: <code><a class="el" href="../../d9/d8a/overworld__editor_8cc.html">src/app/editor/overworld/overworld_editor.cc</a>:1132-1136</code></p>
<p><b>Problem</b>: For vanilla ROMs, the large map highlighting logic wasn't accounting for world offsets when calculating parent map coordinates. Dark World maps (0x40-0x7F) and Special World maps (0x80-0x9F) use map IDs with offsets, but the display grid coordinates are 0-7.</p>
<p><b>Before (BROKEN)</b>: </p><div class="fragment"><div class="line"><span class="keywordflow">if</span> (overworld_.overworld_map(current_map_)-&gt;is_large_map() ||</div>
<div class="line">    overworld_.overworld_map(current_map_)-&gt;large_index() != 0) {</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">int</span> highlight_parent =</div>
<div class="line">      overworld_.overworld_map(current_highlighted_map)-&gt;parent();</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">int</span> parent_map_x = highlight_parent % 8;  <span class="comment">// ❌ Wrong for Dark/Special!</span></div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">int</span> parent_map_y = highlight_parent / 8;</div>
<div class="line">  ow_map_canvas_.DrawOutline(parent_map_x * kOverworldMapSize,</div>
<div class="line">                             parent_map_y * kOverworldMapSize,</div>
<div class="line">                             large_map_size, large_map_size);</div>
<div class="line">}</div>
</div><!-- fragment --><p><b>Example Bug</b>:</p><ul>
<li>Dark World map 0x42 (parent) → <code>0x42 % 8 = 2</code>, <code>0x42 / 8 = 8</code></li>
<li>This draws the outline at grid position (2, 8) which is <b>off the screen</b>!</li>
<li>Correct position should be (2, 0) in the Dark World display grid</li>
</ul>
<p><b>After (FIXED)</b>: </p><div class="fragment"><div class="line"><span class="keywordflow">if</span> (overworld_.overworld_map(current_map_)-&gt;is_large_map() ||</div>
<div class="line">    overworld_.overworld_map(current_map_)-&gt;large_index() != 0) {</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">int</span> highlight_parent =</div>
<div class="line">      overworld_.overworld_map(current_highlighted_map)-&gt;parent();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//  CRITICAL FIX: Account for world offset when calculating parent coordinates</span></div>
<div class="line">  <span class="keywordtype">int</span> parent_map_x;</div>
<div class="line">  <span class="keywordtype">int</span> parent_map_y;</div>
<div class="line">  <span class="keywordflow">if</span> (current_world_ == 0) {</div>
<div class="line">    <span class="comment">// Light World (0x00-0x3F)</span></div>
<div class="line">    parent_map_x = highlight_parent % 8;</div>
<div class="line">    parent_map_y = highlight_parent / 8;</div>
<div class="line">  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (current_world_ == 1) {</div>
<div class="line">    <span class="comment">// Dark World (0x40-0x7F) - subtract 0x40 to get display coordinates</span></div>
<div class="line">    parent_map_x = (highlight_parent - 0x40) % 8;</div>
<div class="line">    parent_map_y = (highlight_parent - 0x40) / 8;</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    <span class="comment">// Special World (0x80-0x9F) - subtract 0x80 to get display coordinates</span></div>
<div class="line">    parent_map_x = (highlight_parent - 0x80) % 8;</div>
<div class="line">    parent_map_y = (highlight_parent - 0x80) / 8;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  ow_map_canvas_.DrawOutline(parent_map_x * kOverworldMapSize,</div>
<div class="line">                             parent_map_y * kOverworldMapSize,</div>
<div class="line">                             large_map_size, large_map_size);</div>
<div class="line">}</div>
</div><!-- fragment --><p><b>Why This Fixes It</b>:</p><ul>
<li>Map IDs are <b>absolute</b>: Light World 0x00-0x3F, Dark World 0x40-0x7F, Special 0x80-0x9F</li>
<li>Display coordinates are <b>relative</b>: Each world displays in an 8x8 grid (0-7, 0-7)</li>
<li>Without subtracting the world offset, coordinates overflow the display grid</li>
<li>This matches the same logic used for v3 large maps (lines 1084-1096) and small maps (lines 1141-1172)</li>
</ul>
<h1><a class="anchor" id="autotoc_md1402"></a>
Commit Reference</h1>
<p><b>Canvas Refactoring Commits</b>:</p><ul>
<li><code>f538775954</code> - Organize Canvas Utilities and BPP Format Management</li>
<li><code>60ddf76331</code> - Integrate Canvas Automation API and Simplify Overworld Editor Controls</li>
</ul>
<p>These commits moved canvas utilities to modular components but introduced the regression by not maintaining hover position tracking.</p>
<h1><a class="anchor" id="autotoc_md1403"></a>
Future Improvements</h1>
<ol type="1">
<li><b>Canvas Mode System</b>: Complete the interaction handler modes (tile paint, select, etc.)</li>
<li><b>Persistent Context Menus</b>: Implement mode switching through context menu popups</li>
<li><b>Debugging Visualization</b>: Add canvas coordinate overlay for debugging</li>
<li><b>E2E Tests</b>: Create end-to-end tests for overworld map highlighting workflow</li>
</ol>
<h1><a class="anchor" id="autotoc_md1404"></a>
Related Documentation</h1>
<ul>
<li><code><a class="el" href="../../dc/dee/G1-canvas-guide_8md.html">docs/G1-canvas-guide.md</a></code> - Canvas system architecture</li>
<li><code><a class="el" href="../../d4/d51/E5-debugging-guide_8md.html">docs/E5-debugging-guide.md</a></code> - Debugging techniques</li>
<li><code>docs/debugging-startup-flags.md</code> - CLI flags for editor testing </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
