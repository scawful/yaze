<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>yaze: Canvas System</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript">var page_layout=1;</script>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="side-nav" class="ui-resizable side-nav-resizable"><!-- do not remove this div, it is closed by doxygen! -->
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../yaze.ico"/></td>
  <td id="projectalign">
   <div id="projectname">yaze<span id="projectnumber">&#160;0.3.2</span>
   </div>
   <div id="projectbrief">Link to the Past ROM Editor</div>
  </td>
 </tr>
   <tr><td colspan="2">        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.svg" alt=""/></a>
          </span>
        </div>
</td></tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d0/d7d/md_docs_2G2-canvas-guide.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Canvas System</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md420"></a> </p>
<h1><a class="anchor" id="autotoc_md421"></a>
Overview</h1>
<p>The Canvas class provides a flexible drawing surface for the YAZE ROM editor, supporting tile-based editing, bitmap display, grid overlays, and interactive selection.</p>
<h1><a class="anchor" id="autotoc_md422"></a>
Core Concepts</h1>
<h2><a class="anchor" id="autotoc_md423"></a>
Canvas Structure</h2>
<ul>
<li><b>Background</b>: Drawing surface with border and optional scrolling</li>
<li><b>Content Layer</b>: Bitmaps, tiles, custom graphics</li>
<li><b>Grid Overlay</b>: Optional grid with hex labels</li>
<li><b>Interaction Layer</b>: Hover previews, selection rectangles</li>
</ul>
<h2><a class="anchor" id="autotoc_md424"></a>
Coordinate Systems</h2>
<ul>
<li><b>Screen Space</b>: <a class="el" href="../../df/de4/namespaceImGui.html">ImGui</a> window coordinates</li>
<li><b>Canvas Space</b>: Relative to canvas origin (0,0)</li>
<li><b>Tile Space</b>: Grid-aligned tile indices</li>
<li><b>World Space</b>: Overworld 4096x4096 large map coordinates</li>
</ul>
<h1><a class="anchor" id="autotoc_md425"></a>
Usage Patterns</h1>
<h2><a class="anchor" id="autotoc_md426"></a>
Pattern 1: Basic Bitmap Display</h2>
<div class="fragment"><div class="line">gui::Canvas canvas(<span class="stringliteral">&quot;MyCanvas&quot;</span>, ImVec2(512, 512));</div>
<div class="line"> </div>
<div class="line">canvas.DrawBackground();</div>
<div class="line">canvas.DrawContextMenu();</div>
<div class="line">canvas.DrawBitmap(bitmap, 0, 0, 2.0f);  <span class="comment">// scale 2x</span></div>
<div class="line">canvas.DrawGrid(16.0f);</div>
<div class="line">canvas.DrawOverlay();</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md427"></a>
Pattern 2: Modern Begin/End</h2>
<div class="fragment"><div class="line">canvas.Begin(ImVec2(512, 512));</div>
<div class="line">canvas.DrawBitmap(bitmap, 0, 0, 2.0f);</div>
<div class="line">canvas.End();  <span class="comment">// Automatic grid + overlay</span></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md428"></a>
Pattern 3: RAII ScopedCanvas</h2>
<div class="fragment"><div class="line">gui::ScopedCanvas canvas(<span class="stringliteral">&quot;Editor&quot;</span>, ImVec2(512, 512));</div>
<div class="line">canvas-&gt;DrawBitmap(bitmap, 0, 0, 2.0f);</div>
<div class="line"><span class="comment">// Automatic cleanup</span></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md429"></a>
Feature: Tile Painting</h1>
<h2><a class="anchor" id="autotoc_md430"></a>
Single Tile Painting</h2>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (canvas.DrawTilePainter(current_tile_bitmap, 16, 2.0f)) {</div>
<div class="line">  ImVec2 paint_pos = canvas.drawn_tile_position();</div>
<div class="line">  ApplyTileToMap(paint_pos, current_tile_id);</div>
<div class="line">}</div>
</div><!-- fragment --><p><b>How it works</b>:</p><ul>
<li>Shows preview of tile at mouse position</li>
<li>Aligns to grid</li>
<li>Returns <code>true</code> on left-click + drag</li>
<li>Updates <code>drawn_tile_position()</code> with paint location</li>
</ul>
<h2><a class="anchor" id="autotoc_md431"></a>
Tilemap Painting</h2>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (canvas.DrawTilemapPainter(tilemap, current_tile_id)) {</div>
<div class="line">  ImVec2 paint_pos = canvas.drawn_tile_position();</div>
<div class="line">  ApplyTileToMap(paint_pos, current_tile_id);</div>
<div class="line">}</div>
</div><!-- fragment --><p><b>Use for</b>: Painting from tile atlases (e.g., tile16 blockset)</p>
<h2><a class="anchor" id="autotoc_md432"></a>
Color Painting</h2>
<div class="fragment"><div class="line">ImVec4 paint_color(1.0f, 0.0f, 0.0f, 1.0f);  <span class="comment">// Red</span></div>
<div class="line"><span class="keywordflow">if</span> (canvas.DrawSolidTilePainter(paint_color, 16)) {</div>
<div class="line">  ImVec2 paint_pos = canvas.drawn_tile_position();</div>
<div class="line">  ApplyColorToMap(paint_pos, paint_color);</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md433"></a>
Feature: Tile Selection</h1>
<h2><a class="anchor" id="autotoc_md434"></a>
Single Tile Selection</h2>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (canvas.DrawTileSelector(16)) {</div>
<div class="line">  <span class="comment">// Double-click detected</span></div>
<div class="line">  OpenTileEditor();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Check if tile was clicked (single click)</span></div>
<div class="line"><span class="keywordflow">if</span> (!canvas.points().empty() &amp;&amp; ImGui::IsMouseClicked(ImGuiMouseButton_Left)) {</div>
<div class="line">  ImVec2 selected = canvas.hover_mouse_pos();</div>
<div class="line">  current_tile = CalculateTileId(selected);</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md435"></a>
Multi-Tile Rectangle Selection</h2>
<div class="fragment"><div class="line">canvas.DrawSelectRect(current_map_id, 16, 1.0f);</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">if</span> (canvas.select_rect_active()) {</div>
<div class="line">  <span class="comment">// Get selected tile coordinates</span></div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span>&amp; selected_tiles = canvas.selected_tiles();</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// Get rectangle bounds</span></div>
<div class="line">  <span class="keyword">const</span> <span class="keyword">auto</span>&amp; selected_points = canvas.selected_points();</div>
<div class="line">  ImVec2 start = selected_points[0];</div>
<div class="line">  ImVec2 end = selected_points[1];</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// Process selection</span></div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; tile_pos : selected_tiles) {</div>
<div class="line">    ProcessTile(tile_pos);</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p><b>Selection Flow</b>:</p><ol type="1">
<li>Right-click drag to create rectangle</li>
<li><code>selected_tiles_</code> populated with tile coordinates</li>
<li><code>selected_points_</code> contains rectangle bounds</li>
<li><code>select_rect_active()</code> returns true</li>
</ol>
<h2><a class="anchor" id="autotoc_md436"></a>
Rectangle Drag &amp; Paint</h2>
<p><b>Overworld-Specific</b>: Multi-tile copy/paste pattern</p>
<div class="fragment"><div class="line"><span class="comment">// In CheckForSelectRectangle():</span></div>
<div class="line"><span class="keywordflow">if</span> (canvas.select_rect_active()) {</div>
<div class="line">  <span class="comment">// Pre-compute tile IDs from selection</span></div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">auto</span>&amp; pos : canvas.selected_tiles()) {</div>
<div class="line">    tile_ids.push_back(GetTileIdAt(pos));</div>
<div class="line">  }</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// Show draggable preview</span></div>
<div class="line">  canvas.DrawBitmapGroup(tile_ids, tilemap, 16, scale);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// In CheckForOverworldEdits():</span></div>
<div class="line"><span class="keywordflow">if</span> (canvas.select_rect_active() &amp;&amp; ImGui::IsMouseClicked(ImGuiMouseButton_Left)) {</div>
<div class="line">  <span class="comment">// Paint the tiles at new location</span></div>
<div class="line">  <span class="keyword">auto</span> start = canvas.selected_points()[0];</div>
<div class="line">  <span class="keyword">auto</span> end = canvas.selected_points()[1];</div>
<div class="line">  </div>
<div class="line">  <span class="keywordtype">int</span> i = 0;</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = start_y; y &lt;= end_y; y += 16, ++i) {</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = start_x; x &lt;= end_x; x += 16) {</div>
<div class="line">      PaintTile(x, y, tile_ids[i]);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md437"></a>
Feature: Custom Overlays</h1>
<h2><a class="anchor" id="autotoc_md438"></a>
Manual Points Manipulation</h2>
<div class="fragment"><div class="line"><span class="comment">// Clear previous highlight</span></div>
<div class="line">canvas.mutable_points()-&gt;clear();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Add custom selection box</span></div>
<div class="line">canvas.mutable_points()-&gt;push_back(ImVec2(x, y));</div>
<div class="line">canvas.mutable_points()-&gt;push_back(ImVec2(x + width, y + height));</div>
<div class="line"> </div>
<div class="line"><span class="comment">// DrawOverlay() will render this as a white outline</span></div>
</div><!-- fragment --><p><b>Used for</b>: Custom selection highlights (e.g., blockset current tile indicator)</p>
<h1><a class="anchor" id="autotoc_md439"></a>
Feature: Large Map Support</h1>
<h2><a class="anchor" id="autotoc_md440"></a>
Map Types</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Size   </th><th class="markdownTableHeadNone">Structure   </th><th class="markdownTableHeadNone">Notes    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Small   </td><td class="markdownTableBodyNone">512x512   </td><td class="markdownTableBodyNone">1 local map   </td><td class="markdownTableBodyNone">Standard    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Large   </td><td class="markdownTableBodyNone">1024x1024   </td><td class="markdownTableBodyNone">2x2 grid   </td><td class="markdownTableBodyNone">4 local maps    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Wide   </td><td class="markdownTableBodyNone">1024x512   </td><td class="markdownTableBodyNone">2x1 grid   </td><td class="markdownTableBodyNone">2 local maps    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Tall   </td><td class="markdownTableBodyNone">512x1024   </td><td class="markdownTableBodyNone">1x2 grid   </td><td class="markdownTableBodyNone">2 local maps   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md441"></a>
Boundary Clamping</h2>
<p><b>Problem</b>: Rectangle selection can wrap across 512x512 local map boundaries</p>
<p><b>Solution</b>: Enabled by default </p><div class="fragment"><div class="line">canvas.SetClampRectToLocalMaps(<span class="keyword">true</span>);  <span class="comment">// Default - prevents wrapping</span></div>
</div><!-- fragment --><p><b>How it works</b>:</p><ul>
<li>Detects when rectangle would cross a 512x512 boundary</li>
<li>Clamps preview to stay within current local map</li>
<li>Prevents visual and functional wrapping artifacts</li>
</ul>
<p><b>Revert if needed</b>: </p><div class="fragment"><div class="line">canvas.SetClampRectToLocal Maps(<span class="keyword">false</span>);  <span class="comment">// Old behavior</span></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md442"></a>
Custom Map Sizes</h2>
<div class="fragment"><div class="line"><span class="comment">// For custom ROM hacks with different map structures</span></div>
<div class="line">canvas.DrawBitmapGroup(tiles, tilemap, 16, scale,</div>
<div class="line">                      custom_local_size,            <span class="comment">// e.g., 1024</span></div>
<div class="line">                      ImVec2(custom_width, custom_height));  <span class="comment">// e.g., (2048, 2048)</span></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md443"></a>
Feature: Context Menu</h1>
<h2><a class="anchor" id="autotoc_md444"></a>
Adding Custom Items</h2>
<p><b>Simple</b>: </p><div class="fragment"><div class="line">canvas.AddContextMenuItem({</div>
<div class="line">  <span class="stringliteral">&quot;My Action&quot;</span>,</div>
<div class="line">  [<span class="keyword">this</span>]() { DoAction(); }</div>
<div class="line">});</div>
</div><!-- fragment --><p><b>With Shortcut</b>: </p><div class="fragment"><div class="line">canvas.AddContextMenuItem({</div>
<div class="line">  <span class="stringliteral">&quot;Save&quot;</span>,</div>
<div class="line">  [<span class="keyword">this</span>]() { Save(); },</div>
<div class="line">  <span class="stringliteral">&quot;Ctrl+S&quot;</span></div>
<div class="line">});</div>
</div><!-- fragment --><p><b>Conditional</b>: </p><div class="fragment"><div class="line">canvas.AddContextMenuItem(</div>
<div class="line">  Canvas::ContextMenuItem::Conditional(</div>
<div class="line">    <span class="stringliteral">&quot;Delete&quot;</span>,</div>
<div class="line">    [<span class="keyword">this</span>]() { Delete(); },</div>
<div class="line">    [<span class="keyword">this</span>]() { <span class="keywordflow">return</span> has_selection_; }  <span class="comment">// Only enabled when selection exists</span></div>
<div class="line">  )</div>
<div class="line">);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md445"></a>
Overworld Editor Example</h2>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> SetupOverworldCanvasContextMenu() {</div>
<div class="line">  ow_map_canvas_.ClearContextMenuItems();</div>
<div class="line">  </div>
<div class="line">  ow_map_canvas_.AddContextMenuItem({</div>
<div class="line">    current_map_lock_ ? <span class="stringliteral">&quot;Unlock Map&quot;</span> : <span class="stringliteral">&quot;Lock to This Map&quot;</span>,</div>
<div class="line">    [<span class="keyword">this</span>]() { current_map_lock_ = !current_map_lock_; },</div>
<div class="line">    <span class="stringliteral">&quot;Ctrl+L&quot;</span></div>
<div class="line">  });</div>
<div class="line">  </div>
<div class="line">  ow_map_canvas_.AddContextMenuItem({</div>
<div class="line">    <span class="stringliteral">&quot;Map Properties&quot;</span>,</div>
<div class="line">    [<span class="keyword">this</span>]() { show_map_properties_panel_ = <span class="keyword">true</span>; },</div>
<div class="line">    <span class="stringliteral">&quot;Ctrl+P&quot;</span></div>
<div class="line">  });</div>
<div class="line">  </div>
<div class="line">  ow_map_canvas_.AddContextMenuItem({</div>
<div class="line">    <span class="stringliteral">&quot;Refresh Map&quot;</span>,</div>
<div class="line">    [<span class="keyword">this</span>]() { RefreshOverworldMap(); },</div>
<div class="line">    <span class="stringliteral">&quot;F5&quot;</span></div>
<div class="line">  });</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md446"></a>
Feature: Scratch Space (In Progress)</h1>
<p><b>Concept</b>: Temporary canvas for tile arrangement before pasting to main map</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>ScratchSpaceSlot {</div>
<div class="line">  gfx::Bitmap scratch_bitmap;</div>
<div class="line">  std::array&lt;std::array&lt;int, 32&gt;, 32&gt; tile_data;</div>
<div class="line">  <span class="keywordtype">bool</span> in_use = <span class="keyword">false</span>;</div>
<div class="line">  std::string name;</div>
<div class="line">  <span class="keywordtype">int</span> width = 16;</div>
<div class="line">  <span class="keywordtype">int</span> height = 16;</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// Independent selection</span></div>
<div class="line">  std::vector&lt;ImVec2&gt; selected_tiles;</div>
<div class="line">  <span class="keywordtype">bool</span> select_rect_active = <span class="keyword">false</span>;</div>
<div class="line">};</div>
</div><!-- fragment --><p><b>Status</b>: Data structures exist, UI not yet complete</p>
<h1><a class="anchor" id="autotoc_md447"></a>
Common Workflows</h1>
<h2><a class="anchor" id="autotoc_md448"></a>
Workflow 1: Overworld Tile Painting</h2>
<div class="fragment"><div class="line"><span class="comment">// 1. Setup canvas</span></div>
<div class="line">ow_map_canvas_.Begin();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 2. Draw current map</span></div>
<div class="line">ow_map_canvas_.DrawBitmap(current_map_bitmap, 0, 0);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 3. Handle painting</span></div>
<div class="line"><span class="keywordflow">if</span> (!ow_map_canvas_.select_rect_active() &amp;&amp;</div>
<div class="line">    ow_map_canvas_.DrawTilemapPainter(tile16_blockset_, current_tile16_)) {</div>
<div class="line">  PaintTileToMap(ow_map_canvas_.drawn_tile_position());</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 4. Handle rectangle selection</span></div>
<div class="line">ow_map_canvas_.DrawSelectRect(current_map_);</div>
<div class="line"><span class="keywordflow">if</span> (ow_map_canvas_.select_rect_active()) {</div>
<div class="line">  ShowRectanglePreview();</div>
<div class="line">  <span class="keywordflow">if</span> (ImGui::IsMouseClicked(ImGuiMouseButton_Left)) {</div>
<div class="line">    PaintRectangleToMap();</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 5. Finish</span></div>
<div class="line">ow_map_canvas_.End();</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md449"></a>
Workflow 2: Tile16 Blockset Selection</h2>
<div class="fragment"><div class="line"><span class="comment">// 1. Setup</span></div>
<div class="line">blockset_canvas_.Begin();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 2. Draw blockset</span></div>
<div class="line">blockset_canvas_.DrawBitmap(blockset_bitmap, 0, 0, scale);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 3. Handle selection</span></div>
<div class="line"><span class="keywordflow">if</span> (blockset_canvas_.DrawTileSelector(32)) {</div>
<div class="line">  <span class="comment">// Double-click - open editor</span></div>
<div class="line">  OpenTile16Editor();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">if</span> (!blockset_canvas_.points().empty() &amp;&amp; </div>
<div class="line">    ImGui::IsMouseClicked(ImGuiMouseButton_Left)) {</div>
<div class="line">  <span class="comment">// Single click - select tile</span></div>
<div class="line">  ImVec2 pos = blockset_canvas_.hover_mouse_pos();</div>
<div class="line">  current_tile16_ = CalculateTileIdFromPosition(pos);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 4. Highlight current tile</span></div>
<div class="line">blockset_canvas_.mutable_points()-&gt;clear();</div>
<div class="line">blockset_canvas_.mutable_points()-&gt;push_back(ImVec2(tile_x, tile_y));</div>
<div class="line">blockset_canvas_.mutable_points()-&gt;push_back(ImVec2(tile_x + 32, tile_y + 32));</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 5. Finish</span></div>
<div class="line">blockset_canvas_.End();</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md450"></a>
Workflow 3: Graphics Sheet Display</h2>
<div class="fragment"><div class="line">gui::ScopedCanvas canvas(<span class="stringliteral">&quot;GfxSheet&quot;</span>, ImVec2(128, 256));</div>
<div class="line"> </div>
<div class="line">canvas-&gt;DrawBitmap(graphics_sheet, 0, 0, 1.0f);</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">if</span> (canvas-&gt;DrawTileSelector(8)) {</div>
<div class="line">  EditGraphicsTile(canvas-&gt;hover_mouse_pos());</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Automatic cleanup</span></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md451"></a>
Configuration</h1>
<h2><a class="anchor" id="autotoc_md452"></a>
Grid Settings</h2>
<div class="fragment"><div class="line">canvas.SetGridStep(16.0f);        <span class="comment">// 16x16 grid</span></div>
<div class="line">canvas.SetEnableGrid(<span class="keyword">true</span>);        <span class="comment">// Show grid</span></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md453"></a>
Scale Settings</h2>
<div class="fragment"><div class="line">canvas.SetGlobalScale(2.0f);       <span class="comment">// 2x zoom</span></div>
<div class="line">canvas.SetZoomToFit(bitmap);       <span class="comment">// Auto-fit to window</span></div>
<div class="line">canvas.ResetView();                <span class="comment">// Reset to 1x, (0,0)</span></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md454"></a>
Interaction Settings</h2>
<div class="fragment"><div class="line">canvas.set_draggable(<span class="keyword">true</span>);        <span class="comment">// Enable pan with right-drag</span></div>
<div class="line">canvas.SetContextMenuEnabled(<span class="keyword">true</span>); <span class="comment">// Enable right-click menu</span></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md455"></a>
Large Map Settings</h2>
<div class="fragment"><div class="line">canvas.SetClampRectToLocalMaps(<span class="keyword">true</span>);  <span class="comment">// Prevent boundary wrapping (default)</span></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md456"></a>
Known Issues</h1>
<h2><a class="anchor" id="autotoc_md457"></a>
⚠️ Rectangle Selection Wrapping</h2>
<p>When dragging a multi-tile rectangle selection near 512x512 local map boundaries in large maps, tiles still paint in the wrong location (wrap to left side of map).</p>
<p><b>Root Cause Analysis</b>: The issue involves complex interaction between the original selection coordinates, the clamped preview position while dragging, and the final paint calculation. If the clamped preview is smaller than the original selection, the loop indices can go out of sync, causing tiles to be read from the wrong source position.</p>
<p><b>Status</b>: A fix has been implemented for the painting logic by pre-computing tile IDs, but a visual wrapping artifact may still occur during the drag preview itself. Further investigation is needed to perfectly clamp the preview.</p>
<h1><a class="anchor" id="autotoc_md458"></a>
API Reference</h1>
<h2><a class="anchor" id="autotoc_md459"></a>
Drawing Methods</h2>
<div class="fragment"><div class="line"><span class="comment">// Background and setup</span></div>
<div class="line"><span class="keywordtype">void</span> DrawBackground(ImVec2 size = {0, 0});</div>
<div class="line"><span class="keywordtype">void</span> DrawContextMenu();</div>
<div class="line"><span class="keywordtype">void</span> Begin(ImVec2 size = {0, 0});           <span class="comment">// Modern</span></div>
<div class="line"><span class="keywordtype">void</span> End();                                  <span class="comment">// Modern</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Bitmap drawing</span></div>
<div class="line"><span class="keywordtype">void</span> DrawBitmap(Bitmap&amp; bitmap, <span class="keywordtype">int</span> offset, <span class="keywordtype">float</span> scale);</div>
<div class="line"><span class="keywordtype">void</span> DrawBitmap(Bitmap&amp; bitmap, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">float</span> scale, <span class="keywordtype">int</span> alpha = 255);</div>
<div class="line"><span class="keywordtype">void</span> DrawBitmap(Bitmap&amp; bitmap, ImVec2 dest_pos, ImVec2 dest_size, </div>
<div class="line">               ImVec2 src_pos, ImVec2 src_size);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Tile interaction</span></div>
<div class="line"><span class="keywordtype">bool</span> DrawTilePainter(<span class="keyword">const</span> Bitmap&amp; tile, <span class="keywordtype">int</span> size, <span class="keywordtype">float</span> scale);</div>
<div class="line"><span class="keywordtype">bool</span> DrawTilemapPainter(Tilemap&amp; tilemap, <span class="keywordtype">int</span> current_tile);</div>
<div class="line"><span class="keywordtype">bool</span> DrawSolidTilePainter(<span class="keyword">const</span> ImVec4&amp; color, <span class="keywordtype">int</span> size);</div>
<div class="line"><span class="keywordtype">bool</span> DrawTileSelector(<span class="keywordtype">int</span> size, <span class="keywordtype">int</span> size_y = 0);</div>
<div class="line"><span class="keywordtype">void</span> DrawSelectRect(<span class="keywordtype">int</span> current_map, <span class="keywordtype">int</span> tile_size = 16, <span class="keywordtype">float</span> scale = 1.0f);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Group operations</span></div>
<div class="line"><span class="keywordtype">void</span> DrawBitmapGroup(std::vector&lt;int&gt;&amp; tile_ids, Tilemap&amp; tilemap,</div>
<div class="line">                    <span class="keywordtype">int</span> tile_size, <span class="keywordtype">float</span> scale = 1.0f,</div>
<div class="line">                    <span class="keywordtype">int</span> local_map_size = 0x200,</div>
<div class="line">                    ImVec2 total_map_size = {0x1000, 0x1000});</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Overlays</span></div>
<div class="line"><span class="keywordtype">void</span> DrawGrid(<span class="keywordtype">float</span> step = 64.0f, <span class="keywordtype">int</span> offset = 8);</div>
<div class="line"><span class="keywordtype">void</span> DrawOverlay();</div>
<div class="line"><span class="keywordtype">void</span> DrawOutline(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> w, <span class="keywordtype">int</span> h);</div>
<div class="line"><span class="keywordtype">void</span> DrawRect(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> w, <span class="keywordtype">int</span> h, ImVec4 color);</div>
<div class="line"><span class="keywordtype">void</span> DrawText(std::string text, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md460"></a>
State Accessors</h2>
<div class="fragment"><div class="line"><span class="comment">// Selection state</span></div>
<div class="line"><span class="keywordtype">bool</span> select_rect_active() <span class="keyword">const</span>;</div>
<div class="line"><span class="keyword">const</span> std::vector&lt;ImVec2&gt;&amp; selected_tiles() <span class="keyword">const</span>;</div>
<div class="line"><span class="keyword">const</span> ImVector&lt;ImVec2&gt;&amp; selected_points() <span class="keyword">const</span>;</div>
<div class="line">ImVec2 selected_tile_pos() <span class="keyword">const</span>;</div>
<div class="line"><span class="keywordtype">void</span> set_selected_tile_pos(ImVec2 pos);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Interaction state</span></div>
<div class="line"><span class="keyword">const</span> ImVector&lt;ImVec2&gt;&amp; points() <span class="keyword">const</span>;</div>
<div class="line">ImVector&lt;ImVec2&gt;* mutable_points();</div>
<div class="line">ImVec2 drawn_tile_position() <span class="keyword">const</span>;</div>
<div class="line">ImVec2 hover_mouse_pos() <span class="keyword">const</span>;</div>
<div class="line"><span class="keywordtype">bool</span> IsMouseHovering() <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Canvas properties</span></div>
<div class="line">ImVec2 zero_point() <span class="keyword">const</span>;</div>
<div class="line">ImVec2 scrolling() <span class="keyword">const</span>;</div>
<div class="line"><span class="keywordtype">void</span> set_scrolling(ImVec2 scroll);</div>
<div class="line"><span class="keywordtype">float</span> global_scale() <span class="keyword">const</span>;</div>
<div class="line"><span class="keywordtype">void</span> set_global_scale(<span class="keywordtype">float</span> scale);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md461"></a>
Configuration</h2>
<div class="fragment"><div class="line"><span class="comment">// Grid</span></div>
<div class="line"><span class="keywordtype">void</span> SetGridStep(<span class="keywordtype">float</span> step);</div>
<div class="line"><span class="keywordtype">void</span> SetEnableGrid(<span class="keywordtype">bool</span> enable);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Scale</span></div>
<div class="line"><span class="keywordtype">void</span> SetGlobalScale(<span class="keywordtype">float</span> scale);</div>
<div class="line"><span class="keywordtype">void</span> SetZoomToFit(<span class="keyword">const</span> Bitmap&amp; bitmap);</div>
<div class="line"><span class="keywordtype">void</span> ResetView();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Interaction</span></div>
<div class="line"><span class="keywordtype">void</span> set_draggable(<span class="keywordtype">bool</span> draggable);</div>
<div class="line"><span class="keywordtype">void</span> SetClampRectToLocalMaps(<span class="keywordtype">bool</span> clamp);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Context menu</span></div>
<div class="line"><span class="keywordtype">void</span> AddContextMenuItem(<span class="keyword">const</span> ContextMenuItem&amp; item);</div>
<div class="line"><span class="keywordtype">void</span> ClearContextMenuItems();</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md462"></a>
Implementation Notes</h1>
<h2><a class="anchor" id="autotoc_md463"></a>
Points Management</h2>
<p><b>Two separate point arrays</b>:</p>
<ol type="1">
<li><b>points_</b>: Hover preview (white outline)<ul>
<li>Updated by tile painter methods</li>
<li>Can be manually set for custom highlights</li>
<li>Rendered by <code>DrawOverlay()</code></li>
</ul>
</li>
<li><b>selected_points_</b>: Selection rectangle (white box)<ul>
<li>Updated by <code>DrawSelectRect()</code></li>
<li>Updated by <code>DrawBitmapGroup()</code> during drag</li>
<li>Rendered by <code>DrawOverlay()</code></li>
</ul>
</li>
</ol>
<h2><a class="anchor" id="autotoc_md464"></a>
Selection State</h2>
<p><b>Three pieces of selection data</b>:</p>
<ol type="1">
<li><b>selected_tiles_</b>: Vector of ImVec2 coordinates<ul>
<li>Populated by <code>DrawSelectRect()</code> on right-click drag</li>
<li>Contains tile positions from ORIGINAL selection</li>
<li>Used to fetch tile IDs</li>
</ul>
</li>
<li><b>selected_points_</b>: Rectangle bounds (2 points)<ul>
<li>Start and end of rectangle</li>
<li>Updated during drag by <code>DrawBitmapGroup()</code></li>
<li>Used for painting location</li>
</ul>
</li>
<li><b>selected_tile_pos_</b>: Single tile selection (ImVec2)<ul>
<li>Set by right-click in <code>DrawSelectRect()</code></li>
<li>Used for single tile picker</li>
<li>Reset to (-1, -1) after use</li>
</ul>
</li>
</ol>
<h2><a class="anchor" id="autotoc_md465"></a>
Overworld Rectangle Painting Flow</h2>
<div class="fragment"><div class="line">1. User right-click drags in overworld</div>
<div class="line">   ↓</div>
<div class="line">2. DrawSelectRect() creates selection</div>
<div class="line">   - Populates selected_tiles_ with coordinates</div>
<div class="line">   - Sets selected_points_ to rectangle bounds</div>
<div class="line">   - Sets select_rect_active_ = true</div>
<div class="line">   ↓</div>
<div class="line">3. CheckForSelectRectangle() every frame</div>
<div class="line">   - Gets tile IDs from selected_tiles_ coordinates</div>
<div class="line">   - Stores in selected_tile16_ids_ (pre-computed)</div>
<div class="line">   - Calls DrawBitmapGroup() for preview</div>
<div class="line">   ↓</div>
<div class="line">4. DrawBitmapGroup() updates preview position</div>
<div class="line">   - Follows mouse</div>
<div class="line">   - Clamps to 512x512 boundaries</div>
<div class="line">   - Updates selected_points_ to new position</div>
<div class="line">   ↓</div>
<div class="line">5. User left-clicks to paint</div>
<div class="line">   ↓</div>
<div class="line">6. CheckForOverworldEdits() applies tiles</div>
<div class="line">   - Uses selected_points_ for NEW paint location</div>
<div class="line">   - Uses selected_tile16_ids_ for tile data</div>
<div class="line">   - Paints correctly without recalculation</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md466"></a>
Best Practices</h1>
<h2><a class="anchor" id="autotoc_md467"></a>
DO ✅</h2>
<ul>
<li>Use <code>Begin()/End()</code> for new code (cleaner)</li>
<li>Use <code>ScopedCanvas</code> for exception safety</li>
<li>Check <code>select_rect_active()</code> before accessing selection</li>
<li>Validate array sizes before indexing</li>
<li>Use helper constructors for context menu items</li>
<li>Enable boundary clamping for large maps</li>
</ul>
<h2><a class="anchor" id="autotoc_md468"></a>
DON'T ❌</h2>
<ul>
<li>Don't clear <code>points_</code> if you need the hover preview</li>
<li>Don't assume <code>selected_tiles_.size() == loop iterations</code> after clamping</li>
<li>Don't recalculate tile IDs during painting (use pre-computed)</li>
<li>Don't access <code>selected_tiles_[i]</code> without bounds check</li>
<li>Don't modify <code>points_</code> during tile painter calls (managed internally)</li>
</ul>
<h1><a class="anchor" id="autotoc_md469"></a>
Troubleshooting</h1>
<h2><a class="anchor" id="autotoc_md470"></a>
Issue: Rectangle wraps at boundaries</h2>
<p><b>Fix</b>: Ensure <code>SetClampRectToLocalMaps(true)</code> (default)</p>
<h2><a class="anchor" id="autotoc_md471"></a>
Issue: Painting in wrong location</h2>
<p><b>Fix</b>: Use pre-computed tile IDs, not recalculated from selected_tiles_</p>
<h2><a class="anchor" id="autotoc_md472"></a>
Issue: Array index out of bounds</h2>
<p><b>Fix</b>: Add bounds check: <code>i &lt; selected_tile_ids.size()</code></p>
<h2><a class="anchor" id="autotoc_md473"></a>
Issue: Forgot to call End()</h2>
<p><b>Fix</b>: Use <code>ScopedCanvas</code> for automatic cleanup</p>
<h1><a class="anchor" id="autotoc_md474"></a>
Future: Scratch Space</h1>
<p><b>Planned features</b>:</p><ul>
<li>Temporary tile arrangement canvas</li>
<li>Copy/paste between scratch and main map</li>
<li>Multiple scratch slots (4 available)</li>
<li>Save/load scratch layouts</li>
</ul>
<p><b>Current status</b>: Data structures exist, UI pending</p>
<h1><a class="anchor" id="autotoc_md475"></a>
Summary</h1>
<p>The Canvas system provides:</p><ul>
<li>✅ Flexible bitmap display</li>
<li>✅ Tile painting with preview</li>
<li>✅ Single and multi-tile selection</li>
<li>✅ Large map support with boundary clamping</li>
<li>✅ Custom context menus</li>
<li>✅ Modern Begin/End + RAII patterns</li>
<li>✅ Zero breaking changes</li>
</ul>
<p><b>All features working and tested!</b> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
