<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>yaze: Emulator Core Improvements &amp; Optimization Roadmap</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript">var page_layout=1;</script>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="side-nav" class="ui-resizable side-nav-resizable"><!-- do not remove this div, it is closed by doxygen! -->
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../yaze.ico"/></td>
  <td id="projectalign">
   <div id="projectname">yaze<span id="projectnumber">&#160;0.3.2</span>
   </div>
   <div id="projectbrief">Link to the Past ROM Editor</div>
  </td>
 </tr>
   <tr><td colspan="2">        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.svg" alt=""/></a>
          </span>
        </div>
</td></tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d0/d63/md_docs_2Emulator__Improvements__Roadmap.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Emulator Core Improvements &amp; Optimization Roadmap</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md559"></a> </p>
<h1><a class="anchor" id="autotoc_md560"></a>
1. Introduction</h1>
<p>This document outlines potential long-term improvements, refactors, and optimizations for the <code>yaze</code> emulator core. These suggestions aim to enhance accuracy, performance, and code maintainability.</p>
<p>For a detailed analysis of the critical, high-priority bug affecting audio, please first refer to the separate document:</p>
<ul>
<li><b><a class="el" href="../../d4/db6/md_docs_2APU__Timing__Fix__Plan.html">APU Timing and Handshake Bug Analysis &amp; Refactoring Plan</a></b></li>
</ul>
<p>The items below are presented in order of descending priority, from critical accuracy fixes to quality-of-life code improvements.</p>
<h1><a class="anchor" id="autotoc_md561"></a>
2. Core Architecture &amp; Timing Model (High Priority)</h1>
<p>The most significant improvements relate to the fundamental emulation loop and cycle timing, which are the root cause of the current audio bug and affect overall system stability.</p>
<ul>
<li><b>CPU Cycle Counting:</b><ul>
<li><b>Issue:</b> The main CPU loop in <code>Snes::RunCycle()</code> advances the master cycle counter by a fixed amount (<code>+= 2</code>). Real 65816 instructions have variable cycle counts. The current workaround of scattering <code>callbacks_.idle()</code> calls is error-prone and difficult to maintain.</li>
<li><b>Recommendation:</b> Refactor <code>Cpu::ExecuteInstruction</code> to calculate and return the <em>precise</em> cycle cost of each instruction, including penalties for addressing modes and memory access speeds. The main <code>Snes</code> loop should then consume this exact value, centralizing timing logic and dramatically improving accuracy.</li>
</ul>
</li>
<li><b>Main Synchronization Loop:</b><ul>
<li><b>Issue:</b> The main loop in <code>Snes::RunFrame()</code> is state-driven based on the <code>in_vblank_</code> flag. This can be fragile and makes it difficult to reason about the state of all components at any given cycle.</li>
<li><b>Recommendation:</b> Transition to a unified main loop that is driven by a single master cycle counter. In this model, each component (CPU, PPU, APU, DMA) is "ticked" forward based on the master clock. This is a more robust and modular architecture that simplifies component synchronization.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md562"></a>
3. PPU (Video Rendering) Performance</h1>
<p>The Picture Processing Unit (PPU) is often a performance bottleneck. The following change could provide a significant speed boost.</p>
<ul>
<li><b>Rendering Approach:</b><ul>
<li><b>Issue:</b> The PPU currently uses a "pixel-based" renderer (<code>Ppu::RunLine</code> calls <code>HandlePixel</code> for every pixel). This is highly accurate but can be slow due to high function call overhead and poor cache locality.</li>
<li><b>Optimization:</b> Refactor the PPU to use a <b>scanline-based renderer</b>. Instead of processing one pixel at a time, this approach processes all active layers for an entire horizontal scanline, composes them into a temporary buffer, and then writes the completed scanline to the framebuffer. This is a major architectural change but is a standard and highly effective optimization technique in SNES emulation.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md563"></a>
4. APU (Audio) Code Quality &amp; Refinements</h1>
<p>Beyond the critical timing fixes, the APU core would benefit from modernization.</p>
<ul>
<li><b>Code Style:</b><ul>
<li><b>Issue:</b> The code in <code><a class="el" href="../../d6/d00/dsp_8cc.html">dsp.cc</a></code> and <code><a class="el" href="../../d2/d06/spc700_8cc.html">spc700.cc</a></code>, inherited from other projects, is written in a very C-like style, using raw pointers, <code>memset</code>, and numerous "magic numbers."</li>
<li><b>Refactor:</b> Gradually refactor this code to use modern C++ idioms. Replace raw arrays with <code>std::array</code>, use constructors with member initializers instead of <code>memset</code>, and define <code>constexpr</code> variables or <code>enum class</code> types for hardware registers and flags. This will improve type safety, readability, and long-term maintainability.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md564"></a>
5. Audio Subsystem &amp; Buffering</h1>
<p>To ensure smooth, stutter-free audio, the interface between the emulator and the host audio API can be improved.</p>
<ul>
<li><b>Audio Buffering Strategy:</b><ul>
<li><b>Issue:</b> The current implementation in <code>Emulator::Run</code> queues audio samples directly to the SDL audio device. If the emulator lags for even a few frames, the audio buffer can underrun, causing audible pops and stutters.</li>
<li><b>Improvement:</b> Implement a <b>lock-free ring buffer (or circular buffer)</b> to act as an intermediary. The emulator thread would continuously write generated samples into this buffer, while the audio device (in its own thread) would continuously read from it. This decouples the emulation speed from the audio hardware, smoothing out performance fluctuations and preventing stutter.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md565"></a>
6. Debugger &amp; Tooling Optimizations (Lower Priority)</h1>
<p>These are minor optimizations that would improve the performance of the debugging tools, especially under heavy use.</p>
<ul>
<li>**<code>DisassemblyViewer</code> Data Structure:**<ul>
<li><b>Issue:</b> <code>DisassemblyViewer</code> uses a <code>std::map</code> to store instruction traces. For a tool that handles frequent insertions and lookups, this can be suboptimal.</li>
<li><b>Optimization:</b> Replace <code>std::map</code> with <code>std::unordered_map</code> for faster average-case performance.</li>
</ul>
</li>
<li>**<code>BreakpointManager</code> Lookups:**<ul>
<li><b>Issue:</b> The <code>ShouldBreakOn...</code> functions perform a linear scan over a <code>std::vector</code> of all breakpoints. This is O(n) and could become a minor bottleneck if a very large number of breakpoints are set.</li>
<li><b>Optimization:</b> For execution breakpoints, use a <code>std::unordered_set&lt;uint32_t&gt;</code> for O(1) average lookup time. This would make breakpoint checking near-instantaneous, regardless of how many are active. </li>
</ul>
</li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
