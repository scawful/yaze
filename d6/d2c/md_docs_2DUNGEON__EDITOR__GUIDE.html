<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>yaze: YAZE Dungeon Editor: Complete Guide</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript">var page_layout=1;</script>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="side-nav" class="ui-resizable side-nav-resizable"><!-- do not remove this div, it is closed by doxygen! -->
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../yaze.ico"/></td>
  <td id="projectalign">
   <div id="projectname">yaze<span id="projectnumber">&#160;0.3.2</span>
   </div>
   <div id="projectbrief">Link to the Past ROM Editor</div>
  </td>
 </tr>
   <tr><td colspan="2">        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.svg" alt=""/></a>
          </span>
        </div>
</td></tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d6/d2c/md_docs_2DUNGEON__EDITOR__GUIDE.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">YAZE Dungeon Editor: Complete Guide</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md285"></a> <b>Last Updated</b>: October 9, 2025 <br  />
 <b>Status</b>: PRODUCTION READY - Core features stable, tested, and functional</p>
<hr  />
<h1><a class="anchor" id="autotoc_md287"></a>
Table of Contents</h1>
<ul>
<li>Overview</li>
<li>Current Status</li>
<li>Architecture</li>
<li>Quick Start</li>
<li>Core Features</li>
<li>Technical Details</li>
<li>Testing</li>
<li>Troubleshooting</li>
<li>ROM Internals</li>
<li>Reference</li>
</ul>
<hr  />
<h1><a class="anchor" id="autotoc_md289"></a>
Overview</h1>
<p>The Dungeon Editor uses a modern card-based architecture for editing dungeon rooms in The Legend of Zelda: A Link to the Past. The editor features lazy loading, per-room settings, and a component-based design for maximum flexibility.</p>
<h2><a class="anchor" id="autotoc_md290"></a>
Key Capabilities</h2>
<ul>
<li><b>Visual room editing</b> with 512x512 canvas</li>
<li><b>Object placement</b> with pattern-based rendering</li>
<li><b>Live palette editing</b> with instant preview</li>
<li><b>Independent dockable UI cards</b></li>
<li><b>Multi-room editing</b> support</li>
<li><b>Automatic graphics loading</b></li>
<li><b>Per-room layer visibility</b> settings</li>
<li><b>Command-line quick testing</b> support</li>
</ul>
<hr  />
<h1><a class="anchor" id="autotoc_md292"></a>
Current Status</h1>
<h2><a class="anchor" id="autotoc_md293"></a>
✅ Production Ready Features</h2>
<ul>
<li>Core rendering pipeline (floor, walls, objects, sprites)</li>
<li>Object drawing via ObjectDrawer with pattern-based rendering</li>
<li>Live palette editing with HSV picker</li>
<li>Per-room background buffers (no shared state corruption)</li>
<li>Independent dockable card system</li>
<li>Cross-editor navigation (overworld ↔ dungeon)</li>
<li>Error recovery system</li>
<li>Test suite (29/29 tests passing - 100%)</li>
</ul>
<h2><a class="anchor" id="autotoc_md294"></a>
🔧 Recently Fixed Issues</h2>
<ol type="1">
<li><b>Object Visibility</b> ✅ FIXED<ul>
<li><b>Problem</b>: Objects drawn to bitmaps but not visible on canvas</li>
<li><b>Root Cause</b>: Textures not updated after <code>RenderObjectsToBackground()</code></li>
<li><b>Fix</b>: Added texture UPDATE commands after object rendering</li>
</ul>
</li>
<li><b>Property Change Re-rendering</b> ✅ FIXED<ul>
<li><b>Problem</b>: Changing blockset/palette didn't trigger re-render</li>
<li><b>Fix</b>: Added change detection and automatic re-rendering</li>
</ul>
</li>
<li><b>One-Time Rendering</b> ✅ FIXED<ul>
<li><b>Problem</b>: Objects only rendered once, never updated</li>
<li><b>Fix</b>: Removed restrictive rendering checks</li>
</ul>
</li>
<li><b>Per-Room Layer Settings</b> ✅ IMPLEMENTED<ul>
<li>Each room now has independent BG1/BG2 visibility settings</li>
<li>Layer type controls (Normal, Translucent, Addition, Dark, Off)</li>
</ul>
</li>
<li><b>Canvas Context Menu</b> ✅ IMPLEMENTED<ul>
<li>Dungeon-specific options (Place Object, Delete Selected, Toggle Layers, Re-render)</li>
<li>Dynamic menu based on current selection</li>
</ul>
</li>
</ol>
<hr  />
<h1><a class="anchor" id="autotoc_md296"></a>
Architecture</h1>
<h2><a class="anchor" id="autotoc_md297"></a>
Component Hierarchy</h2>
<div class="fragment"><div class="line">DungeonEditorV2 (Coordinator)</div>
<div class="line">│</div>
<div class="line">├── Dungeon Controls (Collapsible panel)</div>
<div class="line">│   └── Card visibility toggles</div>
<div class="line">│</div>
<div class="line">├── Independent Cards (all fully dockable)</div>
<div class="line">│   ├── Rooms List Card (filterable, searchable)</div>
<div class="line">│   ├── Room Matrix Card (16x19 grid, 296 rooms)</div>
<div class="line">│   ├── Entrances List Card (entrance configuration)</div>
<div class="line">│   ├── Room Graphics Card (blockset graphics display)</div>
<div class="line">│   ├── Object Editor Card (unified object placement)</div>
<div class="line">│   ├── Palette Editor Card (90-color palette editing)</div>
<div class="line">│   └── Room Cards (dynamic, auto-dock together)</div>
<div class="line">│</div>
<div class="line">└── Per-Room Rendering</div>
<div class="line">    └── Room</div>
<div class="line">        ├── bg1_buffer_ (BackgroundBuffer)</div>
<div class="line">        ├── bg2_buffer_ (BackgroundBuffer)</div>
<div class="line">        └── DungeonCanvasViewer</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md298"></a>
Card-Based Architecture Benefits</h2>
<ul>
<li>✅ Full freedom to drag, dock, resize</li>
<li>✅ No layout constraints or inheritance</li>
<li>✅ Can be arranged however user wants</li>
<li>✅ Session-aware card titles</li>
<li>✅ <a class="el" href="../../df/de4/namespaceImGui.html">ImGui</a> handles all docking logic</li>
<li>✅ Independent lifetime (close Dungeon Controls, rooms stay open)</li>
</ul>
<hr  />
<h1><a class="anchor" id="autotoc_md300"></a>
Quick Start</h1>
<h2><a class="anchor" id="autotoc_md301"></a>
Launch from Command Line</h2>
<div class="fragment"><div class="line"># Open specific room</div>
<div class="line">./yaze --rom_file=zelda3.sfc --editor=Dungeon --cards=&quot;Room 0&quot;</div>
<div class="line"> </div>
<div class="line"># Compare multiple rooms</div>
<div class="line">./yaze --rom_file=zelda3.sfc --editor=Dungeon --cards=&quot;Room 0,Room 1,Room 105&quot;</div>
<div class="line"> </div>
<div class="line"># Full workspace</div>
<div class="line">./yaze --rom_file=zelda3.sfc --editor=Dungeon \</div>
<div class="line">  --cards=&quot;Rooms List,Room Matrix,Object Editor,Palette Editor&quot;</div>
<div class="line"> </div>
<div class="line"># Debug mode with logging</div>
<div class="line">./yaze --debug --log_file=debug.log --rom_file=zelda3.sfc --editor=Dungeon</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md302"></a>
From GUI</h2>
<ol type="1">
<li>Launch YAZE</li>
<li>Load ROM (File → Open ROM or drag &amp; drop)</li>
<li>Open Dungeon Editor (Tools → Dungeon Editor)</li>
<li>Toggle cards via "Dungeon Controls" checkboxes</li>
<li>Click room in list/matrix to open</li>
</ol>
<hr  />
<h1><a class="anchor" id="autotoc_md304"></a>
Core Features</h1>
<h2><a class="anchor" id="autotoc_md305"></a>
1. Rooms List Card</h2>
<div class="fragment"><div class="line">Features:</div>
<div class="line">- Filter/search functionality (ICON_MD_SEARCH)</div>
<div class="line">- Format: [HEX_ID] Room Name</div>
<div class="line">- Click to open room card</div>
<div class="line">- Double-click for instant focus</div>
<div class="line">- Shows all 296 rooms (0x00-0x127)</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md306"></a>
2. Room Matrix Card (Visual Navigation)</h2>
<div class="fragment"><div class="line">Layout:</div>
<div class="line">- 16 columns × 19 rows = 304 cells</div>
<div class="line">- Displays all 296 rooms (0x00-0x127)</div>
<div class="line">- 24px cells with 1px spacing (optimized)</div>
<div class="line">- Window size: 440x520</div>
<div class="line"> </div>
<div class="line">Visual Features:</div>
<div class="line">- Deterministic HSV colors (no loading needed)</div>
<div class="line">- Light green outline: Currently selected room</div>
<div class="line">- Green outline: Open rooms</div>
<div class="line">- Gray outline: Inactive rooms</div>
<div class="line"> </div>
<div class="line">Performance:</div>
<div class="line">- Before: 2-4 seconds (lazy loading 296 rooms)</div>
<div class="line">- After: &lt; 50ms (pure math, no I/O)</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md307"></a>
3. Entrances List Card</h2>
<div class="fragment"><div class="line">Configuration UI (ZScream Parity):</div>
<div class="line">- Entrance ID, Room ID, Dungeon ID</div>
<div class="line">- Blockset, Music, Floor</div>
<div class="line">- Player Position (X, Y)</div>
<div class="line">- Camera Trigger (X, Y)</div>
<div class="line">- Scroll Position (X, Y)</div>
<div class="line">- Exit value</div>
<div class="line">- Camera Boundaries (quadrant &amp; full room)</div>
<div class="line"> </div>
<div class="line">List Features:</div>
<div class="line">- Format: [HEX_ID] Entrance Name -&gt; Room Name</div>
<div class="line">- Shows entrance-to-room relationship</div>
<div class="line">- Click to select and open associated room</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md308"></a>
4. Object Editor Card (Unified)</h2>
<div class="fragment"><div class="line">Improved UX:</div>
<div class="line">- Mode controls at top: None | Place | Select | Delete</div>
<div class="line">- Current object info always visible</div>
<div class="line">- 2 tabs:</div>
<div class="line">  - Browser: Object selection with previews</div>
<div class="line">  - Preview: Emulator rendering with controls</div>
<div class="line"> </div>
<div class="line">Object Browser:</div>
<div class="line">- Categorized objects (Floor/Wall/Special)</div>
<div class="line">- 32x32 preview icons</div>
<div class="line">- Filter/search functionality</div>
<div class="line">- Shows object ID and type</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md309"></a>
5. Palette Editor Card</h2>
<div class="fragment"><div class="line">Features:</div>
<div class="line">- Palette selector dropdown (20 dungeon palettes)</div>
<div class="line">- 90-color grid (15 per row)</div>
<div class="line">- Visual selection with yellow border</div>
<div class="line">- Tooltips: color index, SNES BGR555, RGB values</div>
<div class="line">- HSV color wheel picker</div>
<div class="line">- Live RGB display (0-255)</div>
<div class="line">- SNES format display (15-bit BGR555)</div>
<div class="line">- Reset button</div>
<div class="line"> </div>
<div class="line">Live Updates:</div>
<div class="line">- Edit palette → all open rooms re-render automatically</div>
<div class="line">- Callback system decouples palette editor from rooms</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md310"></a>
6. Room Cards (Auto-Loading)</h2>
<div class="fragment"><div class="line">Features:</div>
<div class="line">- Auto-loads graphics when properties change</div>
<div class="line">- Simple status indicator (✓ Loaded / ⏳ Not Loaded)</div>
<div class="line">- Auto-saves with main Save command</div>
<div class="line">- Per-room layer controls (BG1/BG2 visibility, BG2 layer type)</div>
<div class="line"> </div>
<div class="line">Docking Behavior:</div>
<div class="line">- ImGuiWindowClass for automatic tab grouping</div>
<div class="line">- New room cards auto-dock with existing rooms</div>
<div class="line">- Can be undocked independently</div>
<div class="line">- Maintains session state</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md311"></a>
7. Canvas Context Menu (NEW)</h2>
<div class="fragment"><div class="line">Dungeon-Specific Options:</div>
<div class="line">- Place Object (Ctrl+P)</div>
<div class="line">- Delete Selected (Del) - conditional on selection</div>
<div class="line">- Toggle BG1 (1)</div>
<div class="line">- Toggle BG2 (2)</div>
<div class="line">- Re-render Room (Ctrl+R)</div>
<div class="line"> </div>
<div class="line">Integration:</div>
<div class="line">- Dynamic menu based on current state</div>
<div class="line">- Consistent with overworld editor UX</div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="autotoc_md313"></a>
Technical Details</h1>
<h2><a class="anchor" id="autotoc_md314"></a>
Rendering Pipeline</h2>
<div class="fragment"><div class="line">1. Room::CopyRoomGraphicsToBuffer()</div>
<div class="line">   → Loads tile graphics into current_gfx16_ [128×N indexed pixels]</div>
<div class="line"> </div>
<div class="line">2. BackgroundBuffer::DrawFloor()</div>
<div class="line">   → Fills tilemap buffer with floor tile IDs</div>
<div class="line"> </div>
<div class="line">3. BackgroundBuffer::DrawBackground()</div>
<div class="line">   → Renders floor tiles to bitmap (512×512 indexed surface)</div>
<div class="line"> </div>
<div class="line">4. Room::SetPalette()</div>
<div class="line">   → Apply 90-color dungeon palette to SDL surface</div>
<div class="line"> </div>
<div class="line">5. Room::RenderObjectsToBackground()</div>
<div class="line">   → ObjectDrawer writes wall/object tiles to BG1/BG2 buffers</div>
<div class="line"> </div>
<div class="line">6. gfx::Arena::QueueTextureCommand(UPDATE, &amp;bitmap)</div>
<div class="line">   → CRITICAL: Update textures after object rendering</div>
<div class="line"> </div>
<div class="line">7. gfx::Arena::ProcessTextureQueue(renderer)</div>
<div class="line">   → Process queued texture operations</div>
<div class="line"> </div>
<div class="line">8. DungeonCanvasViewer::DrawRoomBackgroundLayers()</div>
<div class="line">   → Draw textures to canvas with ImGui::Image()</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md315"></a>
Critical Fix: Texture Update After Object Rendering</h2>
<p><b>Problem</b>: Objects were drawn to bitmaps but textures were never updated.</p>
<p><b>Solution</b> (in <code><a class="el" href="../../d5/d1b/room_8cc.html">room.cc</a></code>): </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> Room::RenderRoomGraphics() {</div>
<div class="line">  <span class="comment">// 1. Draw floor and background</span></div>
<div class="line">  bg1_buffer_.DrawFloor(...);</div>
<div class="line">  bg1_buffer_.DrawBackground(...);</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// 2. Apply palette and create initial textures</span></div>
<div class="line">  bg1_bmp.SetPalette(bg1_palette);</div>
<div class="line">  gfx::Arena::Get().QueueTextureCommand(CREATE, &amp;bg1_bmp);</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// 3. Render objects to bitmaps</span></div>
<div class="line">  RenderObjectsToBackground();</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// 4. CRITICAL FIX: Update textures with new bitmap data</span></div>
<div class="line">  gfx::Arena::Get().QueueTextureCommand(UPDATE, &amp;bg1_bmp);</div>
<div class="line">  gfx::Arena::Get().QueueTextureCommand(UPDATE, &amp;bg2_bmp);</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md316"></a>
SNES Graphics Format</h2>
<p><b>8-bit Indexed Color (3BPP for dungeons)</b>: </p><div class="fragment"><div class="line"><span class="comment">// Each pixel is a palette index (0-7)</span></div>
<div class="line"><span class="comment">// RGB color comes from applying dungeon palette</span></div>
<div class="line">bg1_bmp.SetPalette(dungeon_pal_group[palette_id]);  <span class="comment">// 90 colors</span></div>
<div class="line">Renderer::Get().RenderBitmap(&amp;bitmap);  <span class="comment">// indexed → RGB</span></div>
</div><!-- fragment --><p><b>Color Format: 15-bit BGR555</b> </p><div class="fragment"><div class="line">Bits: 0BBB BBGG GGGR RRRR</div>
<div class="line">       ││││ ││││ ││││ ││││</div>
<div class="line">       │└──┴─┘└──┴─┘└──┴─┘</div>
<div class="line">       │ Blue  Green  Red</div>
<div class="line">       └─ Unused (always 0)</div>
<div class="line"> </div>
<div class="line">Each channel: 0-31 (5 bits)</div>
<div class="line">Total colors: 32,768 (2^15)</div>
</div><!-- fragment --><p><b>Palette Organization</b>:</p><ul>
<li>20 total palettes (one per dungeon color scheme)</li>
<li>90 colors per palette (full SNES BG palette)</li>
<li>ROM address: <code>kDungeonMainPalettes</code> (0xDD734)</li>
</ul>
<h2><a class="anchor" id="autotoc_md317"></a>
Critical Math Formulas</h2>
<p><b>Tile Position in Tilesheet (128px wide)</b>: </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> tile_x = (tile_id % 16) * 8;</div>
<div class="line"><span class="keywordtype">int</span> tile_y = (tile_id / 16) * 8;</div>
<div class="line"><span class="keywordtype">int</span> pixel_offset = (tile_y * 128) + tile_x;</div>
</div><!-- fragment --><p><b>Tile Position in Canvas (512×512)</b>: </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> canvas_x = (tile_col * 8);</div>
<div class="line"><span class="keywordtype">int</span> canvas_y = (tile_row * 8);</div>
<div class="line"><span class="keywordtype">int</span> pixel_offset = (canvas_y * 512) + canvas_x;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// CRITICAL: For NxN tiles, advance by (tile_row * 8 * width)</span></div>
<div class="line"><span class="keywordtype">int</span> dest_offset = (yy * 8 * 512) + (xx * 8);  <span class="comment">// NOT just (yy * 512)!</span></div>
</div><!-- fragment --><p><b>Palette Index Calculation</b>: </p><div class="fragment"><div class="line"><span class="comment">// 3BPP: 8 colors per subpalette</span></div>
<div class="line"><span class="keywordtype">int</span> final_index = pixel_value + (palette_id * 8);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// NOT 4BPP (× 16)!</span></div>
<div class="line"><span class="comment">// int final_index = pixel_value + (palette_id &lt;&lt; 4);  // WRONG</span></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md318"></a>
Per-Room Buffers</h2>
<p><b>Problem</b>: Multiple rooms shared <code>gfx::Arena::Get().bg1()</code> and corrupted each other.</p>
<p><b>Solution</b>: Each <code>Room</code> has its own buffers: </p><div class="fragment"><div class="line"><span class="comment">// In room.h</span></div>
<div class="line">gfx::BackgroundBuffer bg1_buffer_;</div>
<div class="line">gfx::BackgroundBuffer bg2_buffer_;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// In room.cc</span></div>
<div class="line">bg1_buffer_.DrawFloor(...);</div>
<div class="line">bg1_buffer_.DrawBackground(std::span&lt;uint8_t&gt;(current_gfx16_));</div>
<div class="line">Renderer::Get().RenderBitmap(&amp;bg1_buffer_.bitmap());</div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="autotoc_md320"></a>
Testing</h1>
<h2><a class="anchor" id="autotoc_md321"></a>
Test Suite Status</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Test Type   </th><th class="markdownTableHeadNone">Total   </th><th class="markdownTableHeadNone">Passing   </th><th class="markdownTableHeadNone">Pass Rate    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><b>Unit Tests</b>   </td><td class="markdownTableBodyNone">14   </td><td class="markdownTableBodyNone">14   </td><td class="markdownTableBodyNone">100% ✅    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><b>Integration</b>   </td><td class="markdownTableBodyNone">14   </td><td class="markdownTableBodyNone">14   </td><td class="markdownTableBodyNone">100% ✅    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><b>E2E Tests</b>   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">100% ✅    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><b>TOTAL</b>   </td><td class="markdownTableBodyNone"><b>29</b>   </td><td class="markdownTableBodyNone"><b>29</b>   </td><td class="markdownTableBodyNone"><b>100%</b> ✅   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md322"></a>
Running Tests</h2>
<div class="fragment"><div class="line"># Build tests (mac-ai preset)</div>
<div class="line">cmake --preset mac-ai -B build_ai</div>
<div class="line">cmake --build build_ai --target yaze_test</div>
<div class="line"> </div>
<div class="line"># Run all dungeon tests</div>
<div class="line">./build_ai/bin/yaze_test --gtest_filter=&quot;*Dungeon*&quot;</div>
<div class="line"> </div>
<div class="line"># Run E2E tests with GUI (normal speed)</div>
<div class="line">./build_ai/bin/yaze_test --ui --show-gui --normal --gtest_filter=&quot;*DungeonEditorSmokeTest*&quot;</div>
<div class="line"> </div>
<div class="line"># Run E2E tests in slow-motion (cinematic mode)</div>
<div class="line">./build_ai/bin/yaze_test --ui --show-gui --cinematic --gtest_filter=&quot;*DungeonEditorSmokeTest*&quot;</div>
<div class="line"> </div>
<div class="line"># Run all tests with fast execution</div>
<div class="line">./build_ai/bin/yaze_test --ui --fast</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md323"></a>
Test Speed Modes (NEW)</h2>
<div class="fragment"><div class="line">--fast       # Run tests as fast as possible (teleport mouse, skip delays)</div>
<div class="line">--normal     # Run tests at human watchable speed (for debugging)</div>
<div class="line">--cinematic  # Run tests in slow-motion with pauses (for demos/tutorials)</div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="autotoc_md325"></a>
Troubleshooting</h1>
<h2><a class="anchor" id="autotoc_md326"></a>
Common Issues &amp; Fixes</h2>
<h3><a class="anchor" id="autotoc_md327"></a>
Issue 1: Objects Not Visible</h3>
<p><b>Symptom</b>: Floor/walls render but objects invisible <br  />
 <b>Fix</b>: ✅ RESOLVED - Texture update after object rendering now working</p>
<h3><a class="anchor" id="autotoc_md328"></a>
Issue 2: Wrong Colors</h3>
<p><b>Symptom</b>: Colors don't match expected palette <br  />
 <b>Fix</b>: Use <code>SetPalette()</code> not <code>SetPaletteWithTransparent()</code> for dungeons</p>
<p><b>Reason</b>: </p><div class="fragment"><div class="line"><span class="comment">// WRONG (extracts only 8 colors):</span></div>
<div class="line">bitmap.SetPaletteWithTransparent(palette);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// CORRECT (applies full 90-color palette):</span></div>
<div class="line">bitmap.SetPalette(palette);</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md329"></a>
Issue 3: Bitmap Stretched/Corrupted</h3>
<p><b>Symptom</b>: Graphics only in top portion, repeated/stretched <br  />
 <b>Fix</b>: Wrong offset in DrawBackground()</p>
<div class="fragment"><div class="line"><span class="comment">// WRONG:</span></div>
<div class="line"><span class="keywordtype">int</span> offset = (yy * 512) + (xx * 8);  <span class="comment">// Only advances 512 per row</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// CORRECT:</span></div>
<div class="line"><span class="keywordtype">int</span> offset = (yy * 8 * 512) + (xx * 8);  <span class="comment">// Advances 4096 per row</span></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md330"></a>
Issue 4: Room Properties Don't Update</h3>
<p><b>Symptom</b>: Changing blockset/palette has no effect <br  />
 <b>Fix</b>: ✅ RESOLVED - Property change detection now working</p>
<hr  />
<h1><a class="anchor" id="autotoc_md332"></a>
ROM Internals</h1>
<h2><a class="anchor" id="autotoc_md333"></a>
Object Encoding</h2>
<p>Dungeon objects are stored in one of three formats:</p>
<h3><a class="anchor" id="autotoc_md334"></a>
Type 1: Standard Objects (ID 0x00-0xFF)</h3>
<div class="fragment"><div class="line">Format: xxxxxxss yyyyyyss iiiiiiii</div>
<div class="line">Use: Common geometry like walls and floors</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md335"></a>
Type 2: Large Coordinate Objects (ID 0x100-0x1FF)</h3>
<div class="fragment"><div class="line">Format: 111111xx xxxxyyyy yyiiiiii</div>
<div class="line">Use: More complex or interactive structures</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md336"></a>
Type 3: Special Objects (ID 0x200-0x27F)</h3>
<div class="fragment"><div class="line">Format: xxxxxxii yyyyyyii 11111iii</div>
<div class="line">Use: Critical gameplay elements (chests, switches, bosses)</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md337"></a>
Core Data Tables in ROM</h2>
<ul>
<li>**<code>bank_01.asm</code>**:<ul>
<li>**<code>DrawObjects</code> (0x018000)**: Master tables mapping object ID → drawing routine</li>
<li>**<code>LoadAndBuildRoom</code> (0x01873A)**: Primary routine that reads and draws a room</li>
</ul>
</li>
<li>**<code>rooms.asm</code>**:<ul>
<li>**<code>RoomData_ObjectDataPointers</code> (0x1F8000)**: Table of 3-byte pointers to object data for each of 296 rooms</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md338"></a>
Key ROM Addresses</h2>
<div class="fragment"><div class="line"><span class="keyword">constexpr</span> <span class="keywordtype">int</span> dungeons_palettes = 0xDD734;</div>
<div class="line"><span class="keyword">constexpr</span> <span class="keywordtype">int</span> room_object_pointer = 0x874C;  <span class="comment">// Long pointer</span></div>
<div class="line"><span class="keyword">constexpr</span> <span class="keywordtype">int</span> kRoomHeaderPointer = 0xB5DD;   <span class="comment">// LONG</span></div>
<div class="line"><span class="keyword">constexpr</span> <span class="keywordtype">int</span> tile_address = 0x001B52;</div>
<div class="line"><span class="keyword">constexpr</span> <span class="keywordtype">int</span> tile_address_floor = 0x001B5A;</div>
<div class="line"><span class="keyword">constexpr</span> <span class="keywordtype">int</span> torch_data = 0x2736A;</div>
<div class="line"><span class="keyword">constexpr</span> <span class="keywordtype">int</span> blocks_pointer1 = 0x15AFA;</div>
<div class="line"><span class="keyword">constexpr</span> <span class="keywordtype">int</span> pit_pointer = 0x394AB;</div>
<div class="line"><span class="keyword">constexpr</span> <span class="keywordtype">int</span> doorPointers = 0xF83C0;</div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="autotoc_md340"></a>
Reference</h1>
<h2><a class="anchor" id="autotoc_md341"></a>
File Organization</h2>
<p><b>Core Rendering</b>:</p><ul>
<li><code>src/app/zelda3/dungeon/room.{h,cc}</code> - Room state, buffers</li>
<li><code>src/app/gfx/background_buffer.{h,cc}</code> - Tile → bitmap drawing</li>
<li><code>src/app/core/renderer.cc</code> - Bitmap → texture conversion</li>
<li><code><a class="el" href="../../d1/d35/dungeon__canvas__viewer_8cc.html">src/app/editor/dungeon/dungeon_canvas_viewer.cc</a></code> - Canvas display</li>
</ul>
<p><b>Object Drawing</b>:</p><ul>
<li><code>src/app/zelda3/dungeon/object_drawer.{h,cc}</code> - Native C++ patterns</li>
<li><code>src/app/gui/widgets/dungeon_object_emulator_preview.{h,cc}</code> - Research tool</li>
</ul>
<p><b>Editor UI</b>:</p><ul>
<li><code>src/app/editor/dungeon/dungeon_editor_v2.{h,cc}</code> - Main coordinator</li>
<li><code>src/app/gui/widgets/editor_card.{h,cc}</code> - Independent card system</li>
<li><code>src/app/editor/dungeon/dungeon_object_interaction.{h,cc}</code> - Object selection</li>
</ul>
<p><b>Palette System</b>:</p><ul>
<li><code>src/app/gfx/snes_palette.{h,cc}</code> - Palette loading</li>
<li><code>src/app/gui/widgets/palette_editor_widget.{h,cc}</code> - Visual editor</li>
<li><code><a class="el" href="../../d4/d13/bitmap_8cc.html">src/app/gfx/bitmap.cc</a></code> - SetPalette() implementation</li>
</ul>
<h2><a class="anchor" id="autotoc_md342"></a>
Quick Reference: Key Functions</h2>
<div class="fragment"><div class="line"><span class="comment">// Load dungeon palette</span></div>
<div class="line"><span class="keyword">auto</span>&amp; pal_group = rom-&gt;palette_group().dungeon_main;</div>
<div class="line"><span class="keyword">auto</span> palette = pal_group[palette_id];  <span class="comment">// NOT .palette(id)!</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Apply palette to bitmap</span></div>
<div class="line">bitmap.SetPalette(palette);  <span class="comment">// NOT SetPaletteWithTransparent()!</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Create texture from indexed bitmap</span></div>
<div class="line">Renderer::Get().RenderBitmap(&amp;bitmap);  <span class="comment">// NOT UpdateBitmap()!</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Tile sheet offset (128px wide)</span></div>
<div class="line"><span class="keywordtype">int</span> offset = (tile_id / 16) * 8 * 128 + (tile_id % 16) * 8;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Canvas offset (512px wide)</span></div>
<div class="line"><span class="keywordtype">int</span> offset = (tile_row * 8 * 512) + (tile_col * 8);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Palette offset (3BPP)</span></div>
<div class="line"><span class="keywordtype">int</span> offset = palette_id * 8;  <span class="comment">// NOT &lt;&lt; 4 !</span></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md343"></a>
Performance Metrics</h2>
<p><b>Matrix Loading</b>:</p><ul>
<li>Load time: &lt; 50ms (pure calculation, no I/O)</li>
<li>Memory allocations: ~20 per matrix draw (cached colors)</li>
<li>Frame drops: None</li>
</ul>
<p><b>Room Loading</b>:</p><ul>
<li>Lazy loading: Rooms loaded on-demand</li>
<li>Graphics caching: Reused across room switches</li>
<li>Texture batching: Up to 8 textures processed per frame</li>
</ul>
<hr  />
<h1><a class="anchor" id="autotoc_md345"></a>
Summary</h1>
<p>The Dungeon Editor is production-ready with all core features implemented and tested. Recent fixes ensure objects render correctly, property changes trigger re-renders, and the context menu provides dungeon-specific functionality. The card-based architecture provides maximum flexibility while maintaining stability.</p>
<h2><a class="anchor" id="autotoc_md346"></a>
Critical Points</h2>
<ol type="1">
<li><b>Texture Update</b>: Always call UPDATE after modifying bitmap data</li>
<li><b>Per-Room Buffers</b>: Each room has independent bg1/bg2 buffers</li>
<li><b>Property Changes</b>: Automatically detected and trigger re-renders</li>
<li><b>Palette Format</b>: Use SetPalette() for full 90-color dungeon palettes</li>
<li><b>Context Menu</b>: Dungeon-specific options available via right-click</li>
</ol>
<hr  />
<p><b>For detailed debugging</b>: See <code>QUICK-DEBUG-REFERENCE.txt</code> for command-line shortcuts. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
