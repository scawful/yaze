#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

if [[ -n "${Z3ED_BIN:-}" ]]; then
  exec "${Z3ED_BIN}" "$@"
fi

candidates=(
  "${ROOT}/build_ai/bin/Debug/z3ed"
  "${ROOT}/build_ai/bin/z3ed"
  "${ROOT}/build_agent/bin/Debug/z3ed"
  "${ROOT}/build/bin/z3ed"
)

_mtime() {
  # macOS: stat -f %m, Linux: stat -c %Y
  if stat -f %m "$1" >/dev/null 2>&1; then
    stat -f %m "$1"
  else
    stat -c %Y "$1"
  fi
}

bin=""
best_mtime="-1"
for c in "${candidates[@]}"; do
  if [[ -x "${c}" ]]; then
    m="$(_mtime "${c}" || echo 0)"
    if [[ "${m}" -gt "${best_mtime}" ]]; then
      best_mtime="${m}"
      bin="${c}"
    fi
  fi
done

if [[ -z "${bin}" ]]; then
  cat >&2 <<'EOF'
z3ed binary not found.

Common build:
  cmake --preset mac-ai
  cmake --build build_ai --target z3ed

Or set Z3ED_BIN=/path/to/z3ed.
EOF
  exit 1
fi

if [[ "${bin}" == *"/build/bin/z3ed" ]] && [[ -x "${ROOT}/build_ai/bin/Debug/z3ed" ]] && [[ "${Z3ED_WARN_STALE:-1}" == "1" ]]; then
  echo "warning: using ${bin}, but ${ROOT}/build_ai/bin/Debug/z3ed exists; prefer build_ai for latest CLI features. Set Z3ED_BIN to override." >&2
fi

exec "${bin}" "$@"
