#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

if [[ -n "${Z3ED_BIN:-}" ]]; then
  exec "${Z3ED_BIN}" "$@"
fi

ai_candidates=(
  "${ROOT}/build_ai/bin/Debug/z3ed"
  "${ROOT}/build_ai/bin/RelWithDebInfo/z3ed"
  "${ROOT}/build_ai/bin/Release/z3ed"
  "${ROOT}/build_ai/bin/z3ed"
)
test_candidates=(
  "${ROOT}/build_test/bin/Debug/z3ed"
  "${ROOT}/build_test/bin/RelWithDebInfo/z3ed"
  "${ROOT}/build_test/bin/Release/z3ed"
  "${ROOT}/build_test/bin/z3ed"
)
agent_candidates=(
  "${ROOT}/build_agent/bin/Debug/z3ed"
  "${ROOT}/build_agent/bin/RelWithDebInfo/z3ed"
  "${ROOT}/build_agent/bin/Release/z3ed"
  "${ROOT}/build_agent/bin/z3ed"
)
other_candidates=(
  "${ROOT}/build/bin/Debug/z3ed"
  "${ROOT}/build/bin/RelWithDebInfo/z3ed"
  "${ROOT}/build/bin/Release/z3ed"
  "${ROOT}/build/bin/z3ed"
)

_mtime() {
  # macOS: stat -f %m, Linux: stat -c %Y
  if stat -f %m "$1" >/dev/null 2>&1; then
    stat -f %m "$1"
  else
    stat -c %Y "$1"
  fi
}

pick_newest() {
  local best=""
  local best_mtime="-1"
  local c=""
  local m=""

  for c in "$@"; do
    if [[ -x "${c}" ]]; then
      m="$(_mtime "${c}" || echo 0)"
      if [[ "${m}" -gt "${best_mtime}" ]]; then
        best_mtime="${m}"
        best="${c}"
      fi
    fi
  done

  echo "${best}"
}

# Prefer build_ai whenever it exists, even if build_agent/ or build/ is newer.
bin="$(pick_newest "${ai_candidates[@]}")"
if [[ -z "${bin}" ]]; then
  bin="$(pick_newest "${test_candidates[@]}")"
fi
if [[ -z "${bin}" ]]; then
  bin="$(pick_newest "${agent_candidates[@]}")"
fi
if [[ -z "${bin}" ]]; then
  bin="$(pick_newest "${other_candidates[@]}")"
fi

if [[ -z "${bin}" ]]; then
  cat >&2 <<'EOF'
z3ed binary not found.

Common build:
  cmake --preset mac-ai
  cmake --build build_ai --target z3ed

Or set Z3ED_BIN=/path/to/z3ed.
EOF
  exit 1
fi

exec "${bin}" "$@"
