#!/bin/bash
set -e

# Create macOS bundle script
# Usage: create-macos-bundle.sh <version> <artifact_name>
#
# Creates a DMG with:
#   - Yaze.app (with assets in Resources/)
#   - z3ed (CLI tool)
#   - README.md
#   - LICENSE
#   - assets/ (for CLI tool access)

VERSION_NUM="$1"
ARTIFACT_NAME="$2"
APP_BUNDLE_NAME="yaze.app"
RELEASE_README="docs/public/release/README.md"

if [ -z "$VERSION_NUM" ] || [ -z "$ARTIFACT_NAME" ]; then
    echo "Usage: $0 <version> <artifact_name>"
    exit 1
fi

echo "Creating macOS bundle for version: $VERSION_NUM"

# Clean up any previous artifacts
rm -rf "$APP_BUNDLE_NAME" dmg_staging

# Find the build directory (support both single-config and multi-config generators)
BUILD_DIR="build"
BUILD_BIN_DIRS=(
    "$BUILD_DIR/bin/Release"
    "$BUILD_DIR/bin/RelWithDebInfo"
    "$BUILD_DIR/bin/Debug"
    "$BUILD_DIR/bin"
)

YAZE_APP_DIR=""
YAZE_BIN=""
Z3ED_BIN=""

for bin_dir in "${BUILD_BIN_DIRS[@]}"; do
    if [ -z "$YAZE_APP_DIR" ] && [ -d "$bin_dir/yaze.app" ]; then
        YAZE_APP_DIR="$bin_dir/yaze.app"
    fi
    if [ -z "$YAZE_BIN" ] && [ -f "$bin_dir/yaze" ]; then
        YAZE_BIN="$bin_dir/yaze"
    fi
    if [ -z "$Z3ED_BIN" ] && [ -f "$bin_dir/z3ed" ]; then
        Z3ED_BIN="$bin_dir/z3ed"
    fi
done

if [ -z "$YAZE_APP_DIR" ] && [ -z "$YAZE_BIN" ]; then
    echo "ERROR: Cannot find yaze executable in $BUILD_DIR/bin/"
    ls -la "$BUILD_DIR/bin/" 2>/dev/null || echo "Directory doesn't exist"
    exit 1
fi

# macOS packaging
if [ -n "$YAZE_APP_DIR" ]; then
    echo "Found macOS bundle, using it directly"
    cp -r "$YAZE_APP_DIR" "./$APP_BUNDLE_NAME"
else
    echo "Creating manual bundle from executable"
    mkdir -p "$APP_BUNDLE_NAME/Contents/MacOS"
    mkdir -p "$APP_BUNDLE_NAME/Contents/Resources"
    cp "$YAZE_BIN" "$APP_BUNDLE_NAME/Contents/MacOS/yaze"
fi

# Add assets to the bundle's Resources folder
if [ -d "assets" ]; then
    echo "Copying assets to bundle Resources..."
    cp -r assets "$APP_BUNDLE_NAME/Contents/Resources/"
else
    echo "WARNING: assets directory not found"
fi

# Add icon to bundle
if [ -f "assets/yaze.icns" ]; then
    cp assets/yaze.icns "$APP_BUNDLE_NAME/Contents/Resources/"
fi

# Create/Update Info.plist with correct version
cat > "$APP_BUNDLE_NAME/Contents/Info.plist" <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>CFBundleExecutable</key>
    <string>yaze</string>
    <key>CFBundleIdentifier</key>
    <string>com.yaze.editor</string>
    <key>CFBundleName</key>
    <string>Yaze</string>
    <key>CFBundleDisplayName</key>
    <string>Yaze - Zelda3 Editor</string>
    <key>CFBundleVersion</key>
    <string>$VERSION_NUM</string>
    <key>CFBundleShortVersionString</key>
    <string>$VERSION_NUM</string>
    <key>CFBundlePackageType</key>
    <string>APPL</string>
    <key>CFBundleIconFile</key>
    <string>yaze.icns</string>
    <key>NSHighResolutionCapable</key>
    <true/>
    <key>LSMinimumSystemVersion</key>
    <string>11.0</string>
</dict>
</plist>
EOF

if command -v codesign >/dev/null 2>&1; then
    echo "Signing app bundle..."
    if [ -n "${CODESIGN_IDENTITY:-}" ]; then
        echo "Using CODESIGN_IDENTITY"
        codesign --force --deep --options runtime --sign "${CODESIGN_IDENTITY}" "$APP_BUNDLE_NAME"
    else
        echo "No CODESIGN_IDENTITY provided, applying ad-hoc signature"
        codesign --force --deep --sign - "$APP_BUNDLE_NAME"
    fi
    codesign --verify --deep --strict "$APP_BUNDLE_NAME"
else
    echo "WARNING: codesign not available; app bundle signature not validated"
fi

# Create DMG staging area with FLAT structure
echo "Creating DMG staging area..."
mkdir -p dmg_staging

# Copy the app bundle
cp -r "$APP_BUNDLE_NAME" dmg_staging/

# Copy z3ed CLI tool (if it exists)
if [ -f "$Z3ED_BIN" ]; then
    echo "Including z3ed CLI tool"
    cp "$Z3ED_BIN" dmg_staging/
elif [ -f "$BUILD_DIR/bin/Release/z3ed" ]; then
    echo "Including z3ed CLI tool (Release)"
    cp "$BUILD_DIR/bin/Release/z3ed" dmg_staging/
else
    echo "NOTE: z3ed not found, skipping (may not be built)"
fi

# Copy assets folder for CLI tool access
if [ -d "assets" ]; then
    cp -r assets dmg_staging/
fi

# Copy documentation
cp LICENSE dmg_staging/ 2>/dev/null || echo "LICENSE not found"
if [ -f "$RELEASE_README" ]; then
    cp "$RELEASE_README" dmg_staging/README.md
elif [ -f "README.md" ]; then
    cp README.md dmg_staging/
else
    echo "README not found"
fi

# Copy manifest.json generated by CMake
if [ -f "$BUILD_DIR/manifest.json" ]; then
    cp "$BUILD_DIR/manifest.json" dmg_staging/manifest.json
elif [ -f "manifest.json" ]; then
    cp "manifest.json" dmg_staging/manifest.json
else
    echo "WARNING: manifest.json not found"
fi

echo "=== DMG staging contents ==="
ls -la dmg_staging/

# Create DMG
echo "Creating DMG..."
hdiutil create -srcfolder dmg_staging -format UDZO -volname "Yaze $VERSION_NUM" "$ARTIFACT_NAME.dmg"

# Cleanup
rm -rf "$APP_BUNDLE_NAME" dmg_staging

echo "macOS bundle creation completed successfully!"
echo "Created: $ARTIFACT_NAME.dmg"
