#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

if [[ -n "${YAZE_BIN:-}" ]]; then
  exec "${YAZE_BIN}" "$@"
fi

# Prefer the AI build outputs when available.
candidates=(
  "${ROOT}/build_ai/bin/Debug/yaze.app/Contents/MacOS/yaze"
  "${ROOT}/build_ai/bin/RelWithDebInfo/yaze.app/Contents/MacOS/yaze"
  "${ROOT}/build_ai/bin/Release/yaze.app/Contents/MacOS/yaze"
  "${ROOT}/build_ai/bin/Debug/yaze"
  "${ROOT}/build_ai/bin/RelWithDebInfo/yaze"
  "${ROOT}/build_ai/bin/Release/yaze"
  "${ROOT}/build/bin/Debug/yaze.app/Contents/MacOS/yaze"
  "${ROOT}/build/bin/RelWithDebInfo/yaze.app/Contents/MacOS/yaze"
  "${ROOT}/build/bin/Release/yaze.app/Contents/MacOS/yaze"
  "${ROOT}/build/bin/Debug/yaze"
  "${ROOT}/build/bin/RelWithDebInfo/yaze"
  "${ROOT}/build/bin/Release/yaze"
)

_mtime() {
  # macOS: stat -f %m, Linux: stat -c %Y
  if stat -f %m "$1" >/dev/null 2>&1; then
    stat -f %m "$1"
  else
    stat -c %Y "$1"
  fi
}

bin=""
best_mtime="-1"
for c in "${candidates[@]}"; do
  if [[ -x "${c}" ]]; then
    m="$(_mtime "${c}" || echo 0)"
    if [[ "${m}" -gt "${best_mtime}" ]]; then
      best_mtime="${m}"
      bin="${c}"
    fi
  fi
done

if [[ -z "${bin}" ]]; then
  cat >&2 <<EOF
yaze binary not found.

Common build:
  cmake --preset mac-ai
  cmake --build build_ai --target yaze

Or set YAZE_BIN=/path/to/yaze.
EOF
  exit 1
fi

if [[ "${bin}" == *"/build/bin/"* ]] && [[ -x "${ROOT}/build_ai/bin/Debug/yaze.app/Contents/MacOS/yaze" ]] && [[ "${YAZE_WARN_STALE:-1}" == "1" ]]; then
  echo "warning: using ${bin}, but ${ROOT}/build_ai/bin/Debug/yaze.app/... exists; prefer build_ai for latest AI features. Set YAZE_BIN to override." >&2
fi

exec "${bin}" "$@"

