#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

if [[ -n "${YAZE_BIN:-}" ]]; then
  exec "${YAZE_BIN}" "$@"
fi

ai_candidates=(
  "${ROOT}/build_ai/bin/Debug/yaze.app/Contents/MacOS/yaze"
  "${ROOT}/build_ai/bin/RelWithDebInfo/yaze.app/Contents/MacOS/yaze"
  "${ROOT}/build_ai/bin/Release/yaze.app/Contents/MacOS/yaze"
  "${ROOT}/build_ai/bin/Debug/yaze"
  "${ROOT}/build_ai/bin/RelWithDebInfo/yaze"
  "${ROOT}/build_ai/bin/Release/yaze"
)
other_candidates=(
  "${ROOT}/build/bin/Debug/yaze.app/Contents/MacOS/yaze"
  "${ROOT}/build/bin/RelWithDebInfo/yaze.app/Contents/MacOS/yaze"
  "${ROOT}/build/bin/Release/yaze.app/Contents/MacOS/yaze"
  "${ROOT}/build/bin/Debug/yaze"
  "${ROOT}/build/bin/RelWithDebInfo/yaze"
  "${ROOT}/build/bin/Release/yaze"
)

_mtime() {
  # macOS: stat -f %m, Linux: stat -c %Y
  if stat -f %m "$1" >/dev/null 2>&1; then
    stat -f %m "$1"
  else
    stat -c %Y "$1"
  fi
}

pick_newest() {
  local best=""
  local best_mtime="-1"
  local c=""
  local m=""

  for c in "$@"; do
    if [[ -x "${c}" ]]; then
      m="$(_mtime "${c}" || echo 0)"
      if [[ "${m}" -gt "${best_mtime}" ]]; then
        best_mtime="${m}"
        best="${c}"
      fi
    fi
  done

  echo "${best}"
}

# Prefer build_ai whenever it exists, even if build/ is newer.
bin="$(pick_newest "${ai_candidates[@]}")"
if [[ -z "${bin}" ]]; then
  bin="$(pick_newest "${other_candidates[@]}")"
fi

if [[ -z "${bin}" ]]; then
  cat >&2 <<EOF
yaze binary not found.

Common build:
  cmake --preset mac-ai
  cmake --build build_ai --target yaze

Or set YAZE_BIN=/path/to/yaze.
EOF
  exit 1
fi

exec "${bin}" "$@"
