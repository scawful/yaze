<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>yaze: Renderer Class Performance Analysis and Optimization</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript">var page_layout=1;</script>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="side-nav" class="ui-resizable side-nav-resizable"><!-- do not remove this div, it is closed by doxygen! -->
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="yaze.ico"/></td>
  <td id="projectalign">
   <div id="projectname">yaze<span id="projectnumber">&#160;0.3.1</span>
   </div>
   <div id="projectbrief">Link to the Past ROM Editor</div>
  </td>
 </tr>
   <tr><td colspan="2">        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td></tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_docs_2analysis_2renderer__optimization__analysis.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Renderer Class Performance Analysis and Optimization</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md298"></a> </p>
<h1><a class="anchor" id="autotoc_md299"></a>
Overview</h1>
<p>This document analyzes the YAZE Renderer class and documents the performance optimizations implemented to improve ROM loading speed, particularly for overworld graphics initialization.</p>
<h1><a class="anchor" id="autotoc_md300"></a>
Original Performance Issues</h1>
<h2><a class="anchor" id="autotoc_md301"></a>
1. Blocking Texture Creation</h2>
<p>The original <code>CreateAndRenderBitmap</code> method was creating GPU textures synchronously on the main thread during ROM loading:</p><ul>
<li><b>Problem</b>: Each overworld map (160 maps × 512×512 pixels) required immediate GPU texture creation</li>
<li><b>Impact</b>: Main thread blocked for several seconds during ROM loading</li>
<li><b>Root Cause</b>: SDL texture creation is a GPU operation that blocks the rendering thread</li>
</ul>
<h2><a class="anchor" id="autotoc_md302"></a>
2. Inefficient Loading Pattern</h2>
<div class="fragment"><div class="line"><span class="comment">// Original blocking approach</span></div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; kNumOverworldMaps; ++i) {</div>
<div class="line">  Renderer::Get().CreateAndRenderBitmap(...); <span class="comment">// Blocks for each map</span></div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md303"></a>
Optimizations Implemented</h1>
<h2><a class="anchor" id="autotoc_md304"></a>
1. Deferred Texture Creation</h2>
<p><b>New Method</b>: <code>CreateBitmapWithoutTexture</code></p><ul>
<li>Creates bitmap data and SDL surface without GPU texture</li>
<li>Allows bulk data processing without blocking</li>
<li>Textures created on-demand when needed for rendering</li>
</ul>
<p><b>Implementation</b>: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> CreateBitmapWithoutTexture(<span class="keywordtype">int</span> width, <span class="keywordtype">int</span> height, <span class="keywordtype">int</span> depth,</div>
<div class="line">                                <span class="keyword">const</span> std::vector&lt;uint8_t&gt; &amp;data,</div>
<div class="line">                                gfx::Bitmap &amp;bitmap, gfx::SnesPalette &amp;palette) {</div>
<div class="line">  bitmap.Create(width, height, depth, data);</div>
<div class="line">  bitmap.SetPalette(palette);</div>
<div class="line">  <span class="comment">// Note: No RenderBitmap call - texture creation is deferred</span></div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md305"></a>
2. Lazy Loading System</h2>
<p><b>Components</b>:</p><ul>
<li><code>deferred_map_textures_</code>: Vector storing bitmaps waiting for texture creation</li>
<li><code>ProcessDeferredTextures()</code>: Processes 2 textures per frame to avoid blocking</li>
<li><code>EnsureMapTexture()</code>: Creates texture immediately when map becomes visible</li>
</ul>
<p><b>Benefits</b>:</p><ul>
<li>Only visible maps get textures created initially</li>
<li>Remaining textures created progressively without blocking UI</li>
<li>Smooth user experience during loading</li>
</ul>
<h2><a class="anchor" id="autotoc_md306"></a>
3. Performance Monitoring</h2>
<p><b>New Class</b>: <code>PerformanceMonitor</code></p><ul>
<li>Tracks timing for all loading operations</li>
<li>Provides detailed breakdown of where time is spent</li>
<li>Helps identify future optimization opportunities</li>
</ul>
<p><b>Usage</b>: </p><div class="fragment"><div class="line">{</div>
<div class="line">  core::ScopedTimer timer(<span class="stringliteral">&quot;LoadGraphics&quot;</span>);</div>
<div class="line">  <span class="comment">// ... loading operations ...</span></div>
<div class="line">} <span class="comment">// Automatically records duration</span></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md307"></a>
Thread Safety Considerations</h1>
<h2><a class="anchor" id="autotoc_md308"></a>
Main Thread Requirement</h2>
<p>The Renderer class <b>MUST</b> be used only on the main thread because:</p><ol type="1">
<li>SDL_Renderer operations are not thread-safe</li>
<li>OpenGL/DirectX contexts are bound to the creating thread</li>
<li>Texture creation and rendering must happen on the main UI thread</li>
</ol>
<h2><a class="anchor" id="autotoc_md309"></a>
Safe Optimization Approach</h2>
<ul>
<li>Background processing: Bitmap data preparation (CPU-bound)</li>
<li>Main thread: Texture creation and rendering (GPU-bound)</li>
<li>Deferred execution: Spread texture creation across multiple frames</li>
</ul>
<h1><a class="anchor" id="autotoc_md310"></a>
Performance Improvements</h1>
<h2><a class="anchor" id="autotoc_md311"></a>
Loading Time Reduction</h2>
<ul>
<li><b>Before</b>: All 160 overworld maps created textures synchronously (~3-5 seconds blocking)</li>
<li><b>After</b>: Only 4 initial maps create textures, rest deferred (~200-500ms initial load)</li>
<li><b>User Experience</b>: Immediate responsiveness with progressive loading</li>
</ul>
<h2><a class="anchor" id="autotoc_md312"></a>
Memory Efficiency</h2>
<ul>
<li>Bitmap data created once, textures created on-demand</li>
<li>No duplicate data structures</li>
<li>Efficient memory usage with Arena texture management</li>
</ul>
<h1><a class="anchor" id="autotoc_md313"></a>
Implementation Details</h1>
<h2><a class="anchor" id="autotoc_md314"></a>
Modified Files</h2>
<ol type="1">
<li>**<code><a class="el" href="window_8h.html">src/app/core/window.h</a></code>**: Added deferred texture methods and documentation</li>
<li>**<code><a class="el" href="overworld__editor_8h.html">src/app/editor/overworld/overworld_editor.h</a></code>**: Added deferred texture tracking</li>
<li>**<code><a class="el" href="overworld__editor_8cc.html">src/app/editor/overworld/overworld_editor.cc</a></code>**: Implemented optimized loading</li>
<li>**<code>src/app/core/performance_monitor.h/.cc</code>**: Added performance tracking</li>
</ol>
<h2><a class="anchor" id="autotoc_md315"></a>
Key Methods Added</h2>
<ul>
<li><code>CreateBitmapWithoutTexture()</code>: Non-blocking bitmap creation</li>
<li><code>BatchCreateTextures()</code>: Efficient batch texture creation</li>
<li><code>ProcessDeferredTextures()</code>: Progressive texture creation</li>
<li><code>EnsureMapTexture()</code>: On-demand texture creation</li>
</ul>
<h1><a class="anchor" id="autotoc_md316"></a>
Usage Guidelines</h1>
<h2><a class="anchor" id="autotoc_md317"></a>
For Developers</h2>
<ol type="1">
<li>Use <code>CreateBitmapWithoutTexture()</code> for bulk operations during loading</li>
<li>Use <code>EnsureMapTexture()</code> when a bitmap needs to be rendered</li>
<li>Call <code>ProcessDeferredTextures()</code> in the main update loop</li>
<li>Always use <code>ScopedTimer</code> for performance-critical operations</li>
</ol>
<h2><a class="anchor" id="autotoc_md318"></a>
For ROM Loading</h2>
<ol type="1">
<li>Phase 1: Load all bitmap data without textures</li>
<li>Phase 2: Create textures only for visible/needed maps</li>
<li>Phase 3: Process remaining textures progressively</li>
</ol>
<h1><a class="anchor" id="autotoc_md319"></a>
Future Optimization Opportunities</h1>
<h2><a class="anchor" id="autotoc_md320"></a>
1. Background Threading (Pending)</h2>
<ul>
<li>Move bitmap data processing to background threads</li>
<li>Keep only texture creation on main thread</li>
<li>Requires careful synchronization</li>
</ul>
<h2><a class="anchor" id="autotoc_md321"></a>
2. Arena Management Optimization (Pending)</h2>
<ul>
<li>Implement texture pooling for common sizes</li>
<li>Add texture compression for large maps</li>
<li>Optimize memory allocation patterns</li>
</ul>
<h2><a class="anchor" id="autotoc_md322"></a>
3. Advanced Lazy Loading (Pending)</h2>
<ul>
<li>Implement viewport-based loading</li>
<li>Add texture streaming for very large maps</li>
<li>Cache frequently used textures</li>
</ul>
<h1><a class="anchor" id="autotoc_md323"></a>
Conclusion</h1>
<p>The implemented optimizations provide significant performance improvements for ROM loading while maintaining thread safety and code clarity. The deferred texture creation system allows for smooth, responsive loading without blocking the main thread, dramatically improving the user experience when opening ROMs in YAZE.</p>
<p>The performance monitoring system provides visibility into loading times and will help identify future optimization opportunities as the codebase evolves. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
