<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>yaze: SNES Palette System Overview</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript">var page_layout=1;</script>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="side-nav" class="ui-resizable side-nav-resizable"><!-- do not remove this div, it is closed by doxygen! -->
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../yaze.ico"/></td>
  <td id="projectalign">
   <div id="projectname">yaze<span id="projectnumber">&#160;0.3.2</span>
   </div>
   <div id="projectbrief">Link to the Past ROM Editor</div>
  </td>
 </tr>
   <tr><td colspan="2">        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.svg" alt=""/></a>
          </span>
        </div>
</td></tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('da/dfd/md_docs_2G3-palete-system-overview.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">SNES Palette System Overview</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md792"></a> </p>
<h1><a class="anchor" id="autotoc_md793"></a>
Understanding SNES Color and Palette Organization</h1>
<h2><a class="anchor" id="autotoc_md794"></a>
Core Concepts</h2>
<h3><a class="anchor" id="autotoc_md795"></a>
1. SNES Color Format (15-bit BGR555)</h3>
<ul>
<li><b>Storage</b>: 2 bytes per color (16 bits total, 15 bits used)</li>
<li><b>Format</b>: <code>0BBB BBGG GGGR RRRR</code><ul>
<li>Bits 0-4: Red (5 bits, 0-31)</li>
<li>Bits 5-9: Green (5 bits, 0-31)</li>
<li>Bits 10-14: Blue (5 bits, 0-31)</li>
<li>Bit 15: Unused (always 0)</li>
</ul>
</li>
<li><b>Range</b>: Each channel has 32 levels (0-31)</li>
<li><b>Total Colors</b>: 32,768 possible colors (2^15)</li>
</ul>
<h3><a class="anchor" id="autotoc_md796"></a>
2. Palette Groups in Zelda 3</h3>
<p>Zelda 3 organizes palettes into logical groups for different game areas and entities:</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>PaletteGroupMap {</div>
<div class="line">  PaletteGroup overworld_main;      <span class="comment">// Main overworld graphics (35 colors each)</span></div>
<div class="line">  PaletteGroup overworld_aux;       <span class="comment">// Auxiliary overworld (21 colors each)</span></div>
<div class="line">  PaletteGroup overworld_animated;  <span class="comment">// Animated colors (7 colors each)</span></div>
<div class="line">  PaletteGroup hud;                 <span class="comment">// HUD graphics (32 colors each)</span></div>
<div class="line">  PaletteGroup global_sprites;      <span class="comment">// Sprite palettes (60 colors each)</span></div>
<div class="line">  PaletteGroup armors;              <span class="comment">// Armor colors (15 colors each)</span></div>
<div class="line">  PaletteGroup swords;              <span class="comment">// Sword colors (3 colors each)</span></div>
<div class="line">  PaletteGroup shields;             <span class="comment">// Shield colors (4 colors each)</span></div>
<div class="line">  PaletteGroup sprites_aux1;        <span class="comment">// Auxiliary sprite palette 1 (7 colors each)</span></div>
<div class="line">  PaletteGroup sprites_aux2;        <span class="comment">// Auxiliary sprite palette 2 (7 colors each)</span></div>
<div class="line">  PaletteGroup sprites_aux3;        <span class="comment">// Auxiliary sprite palette 3 (7 colors each)</span></div>
<div class="line">  PaletteGroup dungeon_main;        <span class="comment">// Dungeon palettes (90 colors each)</span></div>
<div class="line">  PaletteGroup grass;               <span class="comment">// Grass colors (special handling)</span></div>
<div class="line">  PaletteGroup object_3d;           <span class="comment">// 3D object palettes (8 colors each)</span></div>
<div class="line">  PaletteGroup overworld_mini_map;  <span class="comment">// Mini-map palettes (128 colors each)</span></div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md797"></a>
Dungeon Palette System</h2>
<h3><a class="anchor" id="autotoc_md798"></a>
Structure</h3>
<ul>
<li><b>20 dungeon palettes</b> in the <code>dungeon_main</code> group</li>
<li><b>90 colors per palette</b> (full SNES palette for BG layers)</li>
<li><b>ROM Location</b>: <code>kDungeonMainPalettes</code> (check <code><a class="el" href="../../de/d89/snes__palette_8cc.html">snes_palette.cc</a></code> for exact address)</li>
</ul>
<h3><a class="anchor" id="autotoc_md799"></a>
Usage</h3>
<div class="fragment"><div class="line"><span class="comment">// Loading a dungeon palette</span></div>
<div class="line"><span class="keyword">auto</span>&amp; dungeon_pal_group = rom-&gt;palette_group().dungeon_main;</div>
<div class="line"><span class="keywordtype">int</span> num_palettes = dungeon_pal_group.size();  <span class="comment">// Should be 20</span></div>
<div class="line"><span class="keywordtype">int</span> palette_id = room.palette;  <span class="comment">// Room&#39;s palette ID (0-19)</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// IMPORTANT: Use operator[] not palette() method!</span></div>
<div class="line"><span class="keyword">auto</span> palette = dungeon_pal_group[palette_id];  <span class="comment">// Returns reference</span></div>
<div class="line"><span class="comment">// NOT: auto palette = dungeon_pal_group.palette(palette_id);  // Returns copy!</span></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md800"></a>
Color Distribution (90 colors)</h3>
<p>The 90 colors are typically distributed as:</p><ul>
<li><b>BG1 Palette</b> (Background Layer 1): First 8-16 subpalettes</li>
<li><b>BG2 Palette</b> (Background Layer 2): Next 8-16 subpalettes</li>
<li><b>Sprite Palettes</b>: Remaining colors (handled separately)</li>
</ul>
<p>Each "subpalette" is 16 colors (one SNES palette unit).</p>
<h2><a class="anchor" id="autotoc_md801"></a>
Overworld Palette System</h2>
<h3><a class="anchor" id="autotoc_md802"></a>
Structure</h3>
<ul>
<li><b>Main Overworld</b>: 35 colors per palette</li>
<li><b>Auxiliary</b>: 21 colors per palette</li>
<li><b>Animated</b>: 7 colors per palette (for water, lava effects)</li>
</ul>
<h3><a class="anchor" id="autotoc_md803"></a>
3BPP Graphics and Left/Right Palettes</h3>
<p>Overworld graphics use 3BPP (3 bits per pixel) format:</p><ul>
<li><b>8 colors per tile</b> (2^3 = 8)</li>
<li><b>Left Side</b>: Uses palette 0-7</li>
<li><b>Right Side</b>: Uses palette 8-15</li>
</ul>
<p>When decompressing 3BPP graphics: </p><div class="fragment"><div class="line"><span class="comment">// Palette assignment for 3BPP overworld tiles</span></div>
<div class="line"><span class="keywordflow">if</span> (tile_position &lt; half_screen_width) {</div>
<div class="line">  <span class="comment">// Left side of screen</span></div>
<div class="line">  tile_palette_offset = 0;  <span class="comment">// Use colors 0-7</span></div>
<div class="line">} <span class="keywordflow">else</span> {</div>
<div class="line">  <span class="comment">// Right side of screen</span></div>
<div class="line">  tile_palette_offset = 8;  <span class="comment">// Use colors 8-15</span></div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md804"></a>
Common Issues and Solutions</h2>
<h3><a class="anchor" id="autotoc_md805"></a>
Issue 1: Empty Palette</h3>
<p><b>Symptom</b>: "Palette size: 0 colors" <b>Cause</b>: Using <code>palette()</code> method instead of <code>operator[]</code> <b>Solution</b>: </p><div class="fragment"><div class="line"><span class="comment">// WRONG:</span></div>
<div class="line"><span class="keyword">auto</span> palette = group.palette(<span class="keywordtype">id</span>);  <span class="comment">// Returns copy, may be empty</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// CORRECT:</span></div>
<div class="line"><span class="keyword">auto</span> palette = group[id];  <span class="comment">// Returns reference</span></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md806"></a>
Issue 2: Bitmap Corruption</h3>
<p><b>Symptom</b>: Graphics render only in top portion of image <b>Cause</b>: Wrong depth parameter in <code>CreateAndRenderBitmap</code> <b>Solution</b>: </p><div class="fragment"><div class="line"><span class="comment">// WRONG:</span></div>
<div class="line">CreateAndRenderBitmap(0x200, 0x200, 0x200, data, bitmap, palette);</div>
<div class="line"><span class="comment">//                              depth ^^^^ should be 8!</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// CORRECT:</span></div>
<div class="line">CreateAndRenderBitmap(0x200, 0x200, 8, data, bitmap, palette);</div>
<div class="line"><span class="comment">//                              width, height, depth=8 bits</span></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md807"></a>
Issue 3: ROM Not Loaded in Preview</h3>
<p><b>Symptom</b>: "ROM not loaded" error in emulator preview <b>Cause</b>: Initializing before ROM is set <b>Solution</b>: </p><div class="fragment"><div class="line"><span class="comment">// Initialize emulator preview AFTER ROM is loaded and set</span></div>
<div class="line"><span class="keywordtype">void</span> Load() {</div>
<div class="line">  <span class="comment">// ... load ROM data ...</span></div>
<div class="line">  <span class="comment">// ... set up other components ...</span></div>
<div class="line">  </div>
<div class="line">  <span class="comment">// NOW initialize emulator preview with loaded ROM</span></div>
<div class="line">  object_emulator_preview_.Initialize(rom_);</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md808"></a>
Palette Editor Integration</h2>
<h3><a class="anchor" id="autotoc_md809"></a>
Key Functions for UI</h3>
<div class="fragment"><div class="line"><span class="comment">// Reading a color from ROM</span></div>
<div class="line">absl::StatusOr&lt;uint16_t&gt; ReadColorFromRom(uint32_t address, <span class="keyword">const</span> uint8_t* rom);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Converting SNES color to RGB</span></div>
<div class="line">SnesColor color(snes_value);  <span class="comment">// snes_value is uint16_t</span></div>
<div class="line">uint8_t r = color.red();      <span class="comment">// 0-255 (converted from 0-31)</span></div>
<div class="line">uint8_t g = color.green();    <span class="comment">// 0-255</span></div>
<div class="line">uint8_t b = color.blue();     <span class="comment">// 0-255</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Writing color back to ROM</span></div>
<div class="line">uint16_t snes_value = color.snes();  <span class="comment">// Get 15-bit BGR555 value</span></div>
<div class="line">rom-&gt;WriteByte(address, snes_value &amp; 0xFF);        <span class="comment">// Low byte</span></div>
<div class="line">rom-&gt;WriteByte(address + 1, (snes_value &gt;&gt; 8) &amp; 0xFF);  <span class="comment">// High byte</span></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md810"></a>
Palette Widget Requirements</h3>
<ol type="1">
<li><b>Display</b>: Show colors in organized grids (16 colors per row for SNES standard)</li>
<li><b>Selection</b>: Allow clicking to select a color</li>
<li><b>Editing</b>: Provide RGB sliders (0-255) or color picker</li>
<li><b>Conversion</b>: Auto-convert RGB (0-255) ↔ SNES (0-31) values</li>
<li><b>Preview</b>: Show before/after comparison</li>
<li><b>Save</b>: Write modified palette back to ROM</li>
</ol>
<h2><a class="anchor" id="autotoc_md811"></a>
Graphics Manager Integration</h2>
<h3><a class="anchor" id="autotoc_md812"></a>
Sheet Palette Assignment</h3>
<div class="fragment"><div class="line"><span class="comment">// Assigning palette to graphics sheet</span></div>
<div class="line"><span class="keywordflow">if</span> (sheet_id &gt; 115) {</div>
<div class="line">  <span class="comment">// Sprite sheets use sprite palette</span></div>
<div class="line">  graphics_sheet.SetPaletteWithTransparent(</div>
<div class="line">      rom.palette_group().global_sprites[0], 0);</div>
<div class="line">} <span class="keywordflow">else</span> {</div>
<div class="line">  <span class="comment">// Dungeon sheets use dungeon palette</span></div>
<div class="line">  graphics_sheet.SetPaletteWithTransparent(</div>
<div class="line">      rom.palette_group().dungeon_main[0], 0);</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md813"></a>
Best Practices</h2>
<ol type="1">
<li><b>Always use <code>operator[]</code> for palette access</b> - returns reference, not copy</li>
<li><b>Validate palette IDs</b> before accessing: <div class="fragment"><div class="line"><span class="keywordflow">if</span> (palette_id &gt;= 0 &amp;&amp; palette_id &lt; group.size()) {</div>
<div class="line">  <span class="keyword">auto</span> palette = group[palette_id];</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li><b>Use correct depth parameter</b> when creating bitmaps (usually 8 for indexed color)</li>
<li><b>Initialize ROM-dependent components</b> only after ROM is fully loaded</li>
<li><b>Cache palettes</b> when repeatedly accessing the same palette</li>
<li><b>Update textures</b> after changing palettes (textures don't auto-update)</li>
</ol>
<h2><a class="anchor" id="autotoc_md814"></a>
ROM Addresses (for reference)</h2>
<div class="fragment"><div class="line"><span class="comment">// From snes_palette.cc</span></div>
<div class="line"><span class="keyword">constexpr</span> uint32_t kOverworldPaletteMain = 0xDE6C8;</div>
<div class="line"><span class="keyword">constexpr</span> uint32_t kOverworldPaletteAux = 0xDE86C;</div>
<div class="line"><span class="keyword">constexpr</span> uint32_t kOverworldPaletteAnimated = 0xDE604;</div>
<div class="line"><span class="keyword">constexpr</span> uint32_t kHudPalettes = 0xDD218;</div>
<div class="line"><span class="keyword">constexpr</span> uint32_t kGlobalSpritesLW = 0xDD308;</div>
<div class="line"><span class="keyword">constexpr</span> uint32_t kArmorPalettes = 0xDD630;</div>
<div class="line"><span class="keyword">constexpr</span> uint32_t kSwordPalettes = 0xDD630;</div>
<div class="line"><span class="keyword">constexpr</span> uint32_t kShieldPalettes = 0xDD648;</div>
<div class="line"><span class="keyword">constexpr</span> uint32_t kSpritesPalettesAux1 = 0xDD39E;</div>
<div class="line"><span class="keyword">constexpr</span> uint32_t kSpritesPalettesAux2 = 0xDD446;</div>
<div class="line"><span class="keyword">constexpr</span> uint32_t kSpritesPalettesAux3 = 0xDD4E0;</div>
<div class="line"><span class="keyword">constexpr</span> uint32_t kDungeonMainPalettes = 0xDD734;</div>
<div class="line"><span class="keyword">constexpr</span> uint32_t kHardcodedGrassLW = 0x5FEA9;</div>
<div class="line"><span class="keyword">constexpr</span> uint32_t kTriforcePalette = 0xF4CD0;</div>
<div class="line"><span class="keyword">constexpr</span> uint32_t kOverworldMiniMapPalettes = 0x55B27;</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md815"></a>
Graphics Sheet Palette Application</h1>
<h2><a class="anchor" id="autotoc_md816"></a>
Default Palette Assignment</h2>
<p>Graphics sheets receive default palettes during ROM loading based on their index:</p>
<div class="fragment"><div class="line"><span class="comment">// In LoadAllGraphicsData() - rom.cc</span></div>
<div class="line"><span class="keywordflow">if</span> (i &lt; 113) {</div>
<div class="line">  <span class="comment">// Sheets 0-112: Overworld/Dungeon graphics</span></div>
<div class="line">  graphics_sheets[i].SetPalette(rom.palette_group().dungeon_main[0]);</div>
<div class="line">} <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i &lt; 128) {</div>
<div class="line">  <span class="comment">// Sheets 113-127: Sprite graphics</span></div>
<div class="line">  graphics_sheets[i].SetPalette(rom.palette_group().sprites_aux1[0]);</div>
<div class="line">} <span class="keywordflow">else</span> {</div>
<div class="line">  <span class="comment">// Sheets 128-222: Auxiliary/HUD graphics</span></div>
<div class="line">  graphics_sheets[i].SetPalette(rom.palette_group().hud.palette(0));</div>
<div class="line">}</div>
</div><!-- fragment --><p>This ensures graphics are visible immediately after loading rather than appearing white.</p>
<h2><a class="anchor" id="autotoc_md817"></a>
Palette Update Workflow</h2>
<p>When changing a palette in any editor:</p>
<ol type="1">
<li>Apply the palette: <code>bitmap.SetPalette(new_palette)</code></li>
<li>Notify Arena: <code>gfx::Arena::Get().NotifySheetModified(sheet_index)</code></li>
<li>Changes propagate to all editors automatically</li>
</ol>
<h2><a class="anchor" id="autotoc_md818"></a>
Common Pitfalls</h2>
<p><b>Wrong Palette Access</b>: </p><div class="fragment"><div class="line"><span class="comment">// WRONG - Returns copy, may be empty</span></div>
<div class="line"><span class="keyword">auto</span> palette = group.palette(<span class="keywordtype">id</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// CORRECT - Returns reference</span></div>
<div class="line"><span class="keyword">auto</span> palette = group[id];</div>
</div><!-- fragment --><p><b>Missing Surface Update</b>: </p><div class="fragment"><div class="line"><span class="comment">// WRONG - Only updates vector, not SDL surface</span></div>
<div class="line">bitmap.mutable_data() = new_data;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// CORRECT - Updates both vector and surface</span></div>
<div class="line">bitmap.set_data(new_data);</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
