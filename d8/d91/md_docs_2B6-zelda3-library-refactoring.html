<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>yaze: B6-zelda3-library-refactoring</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript">var page_layout=1;</script>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="side-nav" class="ui-resizable side-nav-resizable"><!-- do not remove this div, it is closed by doxygen! -->
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../yaze.ico"/></td>
  <td id="projectalign">
   <div id="projectname">yaze<span id="projectnumber">&#160;0.3.2</span>
   </div>
   <div id="projectbrief">Link to the Past ROM Editor</div>
  </td>
 </tr>
   <tr><td colspan="2">        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.svg" alt=""/></a>
          </span>
        </div>
</td></tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d8/d91/md_docs_2B6-zelda3-library-refactoring.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">B6-zelda3-library-refactoring</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>YAZE <code>zelda3</code> Library Refactoring &amp; Migration Plan</p>
<p>Author: Gemini Date: 2025-10-11 Status: Proposed</p>
<ol type="1">
<li>Introduction &amp; Motivation</li>
</ol>
<p>The zelda3 library, currently located at src/app/zelda3, encapsulates all the data models and logic specific to "A Link
to the Past." It serves as the foundational data layer for both the yaze GUI application and the z3ed command-line tool.</p>
<p>Its current structure and location present two primary challenges:</p>
<ol type="1">
<li>Monolithic Design: Like the gfx and gui libraries, zelda3 is a single, large static library. This creates a tightly-coupled module where a change to any single component (e.g., dungeon objects) forces a relink of the entire library and all its dependents.</li>
<li>Incorrect Location: The library resides within src/app/, which is designated for the GUI application's specific code. However, its logic is shared with the cli target. This violates architectural principles and creates an improper dependency from the cli module into the app module's subdirectory.</li>
</ol>
<p>This document proposes a comprehensive plan to both refactor the zelda3 library into logical sub-modules and migrate it to a top-level directory (src/zelda3) to correctly establish it as a shared, core component.</p>
<ol type="1">
<li>Goals<ul>
<li>Establish as a Core Shared Library: Physically and logically move the library to src/zelda3 to reflect its role as a foundational component for both the application and the CLI.</li>
<li>Improve Incremental Build Times: Decompose the library into smaller, focused modules to minimize the scope of rebuilds and relinks.</li>
<li>Clarify Domain Boundaries: Create a clear separation between the major game systems (Overworld, Dungeon, Sprites, etc.) to improve code organization and maintainability.</li>
<li>Isolate Legacy Code: Encapsulate the legacy Hyrule Magic music tracker code into its own module to separate it from the modern C++ codebase.</li>
</ul>
</li>
<li>Proposed Architecture</li>
</ol>
<p>The zelda3 library will be moved to src/zelda3/ and broken down into six distinct, layered libraries.</p>
<div class="fragment"><div class="line">1 +-----------------------------------------------------------------+</div>
<div class="line">2 | Executables (yaze, z3ed, tests)                                 |</div>
<div class="line">3 +-----------------------------------------------------------------+</div>
<div class="line">4       ^</div>
<div class="line">5       | Links against</div>
<div class="line">6       v</div>
<div class="line">7 +-----------------------------------------------------------------+</div>
<div class="line">8 | zelda3 (INTERFACE Library)                                      |</div>
<div class="line">9 +-----------------------------------------------------------------+</div>
<div class="line">10       ^</div>
<div class="line">11       | Aggregates</div>
<div class="line">12       |-----------------------------------------------------------|</div>
<div class="line">13       |                           |                               |</div>
<div class="line">14       v                           v                               v</div>
<div class="line">15 +-----------------+   +-----------------+   +---------------------+</div>
<div class="line">16 | zelda3_screen   |--&gt;| zelda3_dungeon  |--&gt;| zelda3_overworld    |</div>
<div class="line">17 +-----------------+   +-----------------+   +---------------------+</div>
<div class="line">18       |                 |         ^         |         ^</div>
<div class="line">19       |                 |         |         |         |</div>
<div class="line">20       |-----------------|---------|---------|---------|</div>
<div class="line">21       |                 |         |         |         |</div>
<div class="line">22       v                 v         |         v         v</div>
<div class="line">23 +-----------------+   +-----------------+   +---------------------+</div>
<div class="line">24 | zelda3_music    |--&gt;| zelda3_sprite   |--&gt;| zelda3_core         |</div>
<div class="line">25 +-----------------+   +-----------------+   +---------------------+</div>
</div><!-- fragment --><p>3.1. zelda3_core (Foundation)</p><ul>
<li>Responsibility: Contains fundamental data structures, constants, and labels used across all other zelda3 modules.</li>
<li>Contents: common.h, <a class="el" href="../../d3/d0f/zelda3__labels_8h.html">zelda3_labels.h</a>/.cc, <a class="el" href="../../d8/d89/dungeon__rom__addresses_8h.html">dungeon/dungeon_rom_addresses.h</a>.</li>
<li>Dependencies: yaze_util.</li>
</ul>
<p>3.2. zelda3_sprite (Shared Game Entity)</p><ul>
<li>Responsibility: Manages the logic and data for sprites, which are used in both dungeons and the overworld.</li>
<li>Contents: <a class="el" href="../../db/d08/sprite_8h.html">sprite/sprite.h</a>/.cc, <a class="el" href="../../d3/d37/sprite__builder_8h.html">sprite/sprite_builder.h</a>/.cc, <a class="el" href="../../dd/dd4/overlord_8h.html">sprite/overlord.h</a>.</li>
<li>Dependencies: zelda3_core.</li>
</ul>
<p>3.3. zelda3_dungeon (Dungeon System)</p><ul>
<li>Responsibility: The complete, self-contained system for all dungeon-related data and logic.</li>
<li>Contents: All files from dungeon/ (<a class="el" href="../../d9/dc0/room_8h.html">room.h</a>/.cc, <a class="el" href="../../d0/dff/room__object_8h.html">room_object.h</a>/.cc, <a class="el" href="../../db/d07/dungeon__editor__system_8h.html">dungeon_editor_system.h</a>/.cc, etc.).</li>
<li>Dependencies: zelda3_core, zelda3_sprite.</li>
</ul>
<p>3.4. <a class="el" href="../../d4/dbf/structzelda3__overworld.html" title="Complete overworld data.">zelda3_overworld</a> (Overworld System)</p><ul>
<li>Responsibility: The complete, self-contained system for all overworld-related data and logic.</li>
<li>Contents: All files from overworld/ (<a class="el" href="../../d7/d9c/overworld_8h.html">overworld.h</a>/.cc, <a class="el" href="../../d1/d4f/overworld__map_8h.html">overworld_map.h</a>/.cc, etc.).</li>
<li>Dependencies: zelda3_core, zelda3_sprite.</li>
</ul>
<p>3.5. zelda3_screen (Specific Game Screens)</p><ul>
<li>Responsibility: High-level components representing specific, non-gameplay screens.</li>
<li>Contents: All files from screen/ (<a class="el" href="../../d2/dba/dungeon__map_8h.html">dungeon_map.h</a>/.cc, <a class="el" href="../../da/dab/inventory_8h.html">inventory.h</a>/.cc, <a class="el" href="../../d4/dea/title__screen_8h.html">title_screen.h</a>/.cc).</li>
<li>Dependencies: zelda3_dungeon, <a class="el" href="../../d4/dbf/structzelda3__overworld.html" title="Complete overworld data.">zelda3_overworld</a>.</li>
</ul>
<p>3.6. zelda3_music (Legacy Isolation)</p><ul>
<li>Responsibility: Encapsulates the legacy Hyrule Magic music tracker code.</li>
<li>Contents: <a class="el" href="../../dc/ded/tracker_8h.html">music/tracker.h</a>/.cc.</li>
<li>Dependencies: zelda3_core.</li>
</ul>
<p>Migration Plan</p>
<p>This plan details the steps to move the library from src/app/zelda3 to src/zelda3.</p>
<ol type="1">
<li>Physical File Move:<ul>
<li>Move the directory /Users/scawful/Code/yaze/src/app/zelda3 to /Users/scawful/Code/yaze/src/zelda3.</li>
</ul>
</li>
<li>Update CMake Configuration:<ul>
<li>In src/CMakeLists.txt, change the line include(zelda3/zelda3_library.cmake) to include(zelda3/zelda3_library.cmake).</li>
<li>In the newly moved src/zelda3/zelda3_library.cmake, update all target_include_directories paths to remove the app/ prefix (e.g., change ${CMAKE_SOURCE_DIR}/src/app to ${CMAKE_SOURCE_DIR}/src).</li>
</ul>
</li>
<li>Update Include Directives (Global):<ul>
<li>Perform a project-wide search-and-replace for all occurrences of #include "zelda3/ and change them to #include
        "zelda3/.</li>
<li>This will be the most extensive step, touching files in src/app/, src/cli/, and test/.</li>
</ul>
</li>
<li>Verification:<ul>
<li>After the changes, run a full CMake configure and build (cmake &ndash;preset mac-dev -B build_ai &amp;&amp; cmake &ndash;build build_ai) to ensure all paths are correctly resolved and the project compiles successfully.</li>
</ul>
</li>
</ol>
<p>Implementation Plan (CMake)</p>
<p>The refactoring will be implemented within the new src/zelda3/zelda3_library.cmake file.</p>
<ol type="1">
<li>Define Source Groups: Create set() commands for each new library (ZELDA3_CORE_SRC, ZELDA3_DUNGEON_SRC, etc.).</li>
<li>Create Static Libraries: Use add_library(yaze_zelda3_core STATIC ...) for each module.</li>
<li>Establish Link Dependencies: Use target_link_libraries to define the dependencies outlined in section 3.</li>
<li>Create Aggregate Interface Library: The yaze_zelda3 target will be converted to an INTERFACE library that links against all the new sub-libraries, providing a single, convenient link target for yaze_gui, yaze_cli, and the test suites.</li>
</ol>
<p>Expected Outcomes</p>
<p>This refactoring and migration will establish the zelda3 library as a true core component of the application. The result will be a more logical and maintainable architecture, significantly faster incremental build times, and a clear separation of concerns that will benefit future development. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
