name: CI/CD Pipeline

on:
  push:
    branches: [ "master", "develop" ]
    paths:
      - 'src/**'
      - 'test/**'
      - 'cmake/**'
      - 'CMakeLists.txt'
      - '.github/workflows/**'
  pull_request:
    branches: [ "master", "develop" ]
    paths:
      - 'src/**'
      - 'test/**'
      - 'cmake/**'
      - 'CMakeLists.txt'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build Type (Debug, Release, RelWithDebInfo)'
        required: false
        default: 'RelWithDebInfo'
        type: choice
        options:
          - Debug
          - Release
          - RelWithDebInfo
      run_sanitizers:
        description: 'Run memory sanitizers'
        required: false
        default: false
        type: boolean
      upload_artifacts:
        description: 'Upload build artifacts'
        required: false
        default: false
        type: boolean

env:
  BUILD_TYPE: ${{ github.event.inputs.build_type || 'RelWithDebInfo' }}

jobs:
  build:
    name: "Build - ${{ matrix.name }}"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "Ubuntu 22.04 (GCC-12)"
            os: ubuntu-22.04
            platform: linux
            preset: ci
          - name: "macOS 14 (Clang)"
            os: macos-14
            platform: macos
            preset: ci
          - name: "Windows 2022 (MSVC)"
            os: windows-2022
            platform: windows
            preset: ci

    steps:
      - name: Setup build environment
        uses: ./.github/actions/setup-build
        with:
          platform: ${{ matrix.platform }}
          preset: ${{ matrix.preset }}
          cache-key: ${{ hashFiles('cmake/dependencies.lock') }}

      - name: Build project
        uses: ./.github/actions/build-project
        with:
          platform: ${{ matrix.platform }}
          preset: ${{ matrix.preset }}
          build-type: ${{ env.BUILD_TYPE }}

      - name: Upload build artifacts (Windows)
        if: matrix.platform == 'windows' && (github.event.inputs.upload_artifacts == 'true' || github.event_name == 'push')
        uses: actions/upload-artifact@v4
        with:
          name: yaze-windows-ci-${{ github.run_number }}
          path: |
            build/bin/*.exe
            build/bin/*.dll
            build/bin/${{ env.BUILD_TYPE }}/*.exe
            build/bin/${{ env.BUILD_TYPE }}/*.dll
          if-no-files-found: warn
          retention-days: 3

  test:
    name: "Test - ${{ matrix.name }}"
    needs: build
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "Ubuntu 22.04"
            os: ubuntu-22.04
            platform: linux
            preset: ci
          - name: "macOS 14"
            os: macos-14
            platform: macos
            preset: ci
          - name: "Windows 2022"
            os: windows-2022
            platform: windows
            preset: ci

    steps:
      - name: Setup build environment
        uses: ./.github/actions/setup-build
        with:
          platform: ${{ matrix.platform }}
          preset: ${{ matrix.preset }}
          cache-key: ${{ hashFiles('cmake/dependencies.lock') }}

      - name: Build project
        uses: ./.github/actions/build-project
        with:
          platform: ${{ matrix.platform }}
          preset: ${{ matrix.preset }}
          build-type: ${{ env.BUILD_TYPE }}

      - name: Run stable tests
        uses: ./.github/actions/run-tests
        with:
          test-type: stable
          preset: ${{ matrix.preset }}

      - name: Run unit tests
        uses: ./.github/actions/run-tests
        with:
          test-type: unit
          preset: ${{ matrix.preset }}

  code-quality:
    name: "Code Quality"
    runs-on: ubuntu-22.04
    continue-on-error: ${{ github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/') }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format-14 clang-tidy-14 cppcheck
    
    - name: Check Formatting
      run: find src test -name "*.cc" -o -name "*.h" | xargs clang-format-14 --dry-run --Werror
    
    - name: Run cppcheck
      run: |
        cppcheck --enable=warning,style,performance --error-exitcode=0 \
          --suppress=missingIncludeSystem --suppress=unusedFunction --inconclusive src/
    
    - name: Run clang-tidy
      run: |
        find src -name "*.cc" -not -path "*/lib/*" | head -20 | \
          xargs clang-tidy-14 --header-filter='src/.*\.(h|hpp)$'

  memory-sanitizer:
    name: "Memory Sanitizer"
    runs-on: ubuntu-22.04
    if: |
      github.event_name == 'pull_request' || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.run_sanitizers == 'true')
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential ninja-build clang-14 libc++-14-dev libc++abi-14-dev \
          libglew-dev libxext-dev libwavpack-dev libpng-dev libgtk-3-dev libdbus-1-dev
    
    - name: Configure with AddressSanitizer
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_C_COMPILER=clang-14 \
          -DCMAKE_CXX_COMPILER=clang++-14 \
          -DCMAKE_CXX_FLAGS="-fsanitize=address -fno-omit-frame-pointer" \
          -DYAZE_BUILD_TESTS=ON
    
    - name: Build
      run: cmake --build build --parallel
    
    - name: Test
      working-directory: build
      env:
        ASAN_OPTIONS: detect_leaks=1:abort_on_error=1
      run: ctest --output-on-failure

  z3ed-agent-test:
    name: "z3ed Agent"
    runs-on: macos-14
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install Dependencies
      run: brew install ollama ninja
    
    - name: Build z3ed
      run: |
        cmake -B build_test -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DZ3ED_AI=ON \
          -DYAZE_BUILD_Z3ED=ON
        cmake --build build_test --target z3ed
    
    - name: Start Ollama
      run: |
        ollama serve & 
        sleep 10
        ollama pull qwen2.5-coder:7b
    
    - name: Run Test Suite
      run: |
        chmod +x ./scripts/agent_test_suite.sh
        ./scripts/agent_test_suite.sh ollama