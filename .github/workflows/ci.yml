name: CI/CD Pipeline

# Test Strategy:
# - PR/Push: Run lean test set (stable tests + smoke tests) for fast feedback
# - Nightly: Run comprehensive suite including ROM-dependent, experimental, benchmarks
# - See .github/workflows/nightly.yml for extended test coverage
#
# Test Labels:
# - stable: Core functionality tests that should always pass
# - unit: Fast isolated component tests (subset of stable)
# - integration: Multi-component tests (subset of stable)
# - rom_dependent: Tests requiring Zelda3 ROM file (nightly only)
# - experimental: AI and experimental feature tests (nightly only)
# - gui: GUI/E2E tests with ImGuiTestEngine (nightly only)
# - benchmark: Performance benchmarks (nightly only)

on:
  push:
    branches: [ "master", "develop" ]
    paths:
      - 'src/**'
      - 'test/**'
      - 'cmake/**'
      - 'CMakeLists.txt'
      - '.github/workflows/**'
  pull_request:
    branches: [ "master", "develop" ]
    paths:
      - 'src/**'
      - 'test/**'
      - 'cmake/**'
      - 'CMakeLists.txt'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build Type (Debug, Release, RelWithDebInfo)'
        required: false
        default: 'RelWithDebInfo'
        type: choice
        options:
          - Debug
          - Release
          - RelWithDebInfo
      run_sanitizers:
        description: 'Run memory sanitizers'
        required: false
        default: false
        type: boolean
      upload_artifacts:
        description: 'Upload build artifacts'
        required: false
        default: false
        type: boolean
      enable_http_api_tests:
        description: 'Enable HTTP API tests'
        required: false
        default: false
        type: boolean

env:
  BUILD_TYPE: ${{ github.event.inputs.build_type || 'RelWithDebInfo' }}

jobs:
  build:
    name: "Build - ${{ matrix.name }}"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "Ubuntu 22.04 (GCC-12)"
            os: ubuntu-22.04
            platform: linux
            preset: ci-linux
          - name: "macOS 14 (Clang)"
            os: macos-14
            platform: macos
            preset: ci-macos
          - name: "Windows 2022 (Core)"
            os: windows-2022
            platform: windows
            preset: ci-windows

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Free up disk space (Linux)
        if: matrix.platform == 'linux'
        run: |
          echo "=== Disk space before cleanup ==="
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          echo "=== Disk space after cleanup ==="
          df -h

      - name: Setup build environment
        uses: ./.github/actions/setup-build
        with:
          platform: ${{ matrix.platform }}
          preset: ${{ matrix.preset }}
          cache-key: ${{ github.sha }}

      - name: Build project
        uses: ./.github/actions/build-project
        with:
          platform: ${{ matrix.platform }}
          preset: ${{ matrix.preset }}
          build-type: ${{ env.BUILD_TYPE }}

      - name: Upload build artifacts (Windows)
        if: matrix.platform == 'windows' && (github.event.inputs.upload_artifacts == 'true' || github.event_name == 'push')
        uses: actions/upload-artifact@v4
        with:
          name: yaze-windows-ci-${{ github.run_number }}
          path: |
            build/bin/*.exe
            build/bin/*.dll
            build/bin/${{ env.BUILD_TYPE }}/*.exe
            build/bin/${{ env.BUILD_TYPE }}/*.dll
          if-no-files-found: warn
          retention-days: 3

  test:
    name: "Test - ${{ matrix.name }}"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "Ubuntu 22.04"
            os: ubuntu-22.04
            platform: linux
            preset: ci-linux
          - name: "macOS 14"
            os: macos-14
            platform: macos
            preset: ci-macos
          - name: "Windows 2022 (Core)"
            os: windows-2022
            platform: windows
            preset: ci-windows

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Free up disk space (Linux)
        if: matrix.platform == 'linux'
        run: |
          echo "=== Disk space before cleanup ==="
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          echo "=== Disk space after cleanup ==="
          df -h

      - name: Setup build environment
        uses: ./.github/actions/setup-build
        with:
          platform: ${{ matrix.platform }}
          preset: ${{ matrix.preset }}
          cache-key: ${{ github.sha }}

      - name: Build project
        uses: ./.github/actions/build-project
        with:
          platform: ${{ matrix.platform }}
          preset: ${{ matrix.preset }}
          build-type: ${{ env.BUILD_TYPE }}

      - name: Run stable tests only
        uses: ./.github/actions/run-tests
        with:
          test-type: stable
          preset: ${{ matrix.preset }}

      - name: Run smoke tests (GUI framework validation)
        if: matrix.platform == 'linux'
        run: |
          cd build
          # Run just the smoke tests to validate GUI framework is working
          ./bin/yaze_test_gui -nogui --gtest_filter="*Smoke*" || true
        continue-on-error: true

      - name: Run HTTP API tests
        if: github.event.inputs.enable_http_api_tests == 'true'
        run: scripts/agents/test-http-api.sh

  windows-agent:
    name: "Windows Agent (Full Stack)"
    runs-on: windows-2022
    needs: [build, test]
    if: github.event_name != 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup build environment
        uses: ./.github/actions/setup-build
        with:
          platform: windows
          preset: ci-windows-ai
          cache-key: ${{ github.sha }}

      - name: Build project
        uses: ./.github/actions/build-project
        with:
          platform: windows
          preset: ci-windows-ai
          build-type: ${{ env.BUILD_TYPE }}

      - name: Run stable tests only (agent stack)
        uses: ./.github/actions/run-tests
        with:
          test-type: stable
          preset: ci-windows-ai

  wasm-smoke-test:
    name: "WASM Build Smoke Test"
    runs-on: ubuntu-22.04
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: 3.1.51
          actions-cache-folder: 'emsdk-cache'

      - name: Setup Ninja
        uses: seanmiddleditch/gha-setup-ninja@v4

      - name: Quick WASM build test
        run: |
          emcmake cmake --preset wasm-debug
          cmake --build build-wasm-debug --target yaze --parallel
          # Verify output exists
          test -f build-wasm-debug/bin/yaze.wasm
          echo "WASM build successful!"

  code-quality:
    name: "Code Quality"
    runs-on: ubuntu-22.04
    continue-on-error: ${{ github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/') }}
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format-14 clang-tidy-14 cppcheck

    - name: Collect changed files
      id: changed
      run: |
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          base="${{ github.event.pull_request.base.sha }}"
          head="${{ github.event.pull_request.head.sha }}"
        else
          base="${{ github.event.before }}"
          head="${{ github.sha }}"
        fi

        if [ -z "$base" ] || [ "$base" = "0000000000000000000000000000000000000000" ]; then
          if git rev-parse HEAD^ >/dev/null 2>&1; then
            base="$(git rev-parse HEAD^)"
          else
            base="$head"
          fi
        fi

        files=$(git diff --name-only "$base" "$head" | grep -E '^(src|test)/.*\.(cc|h)$' || true)
        echo "files<<EOF" >> "$GITHUB_OUTPUT"
        echo "$files" >> "$GITHUB_OUTPUT"
        echo "EOF" >> "$GITHUB_OUTPUT"
    
    - name: Check Formatting
      run: |
        if [ -z "${{ steps.changed.outputs.files }}" ]; then
          echo "No C/C++ sources changed."
          exit 0
        fi
        echo "${{ steps.changed.outputs.files }}" | xargs clang-format-14 --dry-run --Werror
    
    - name: Run cppcheck
      run: |
        cppcheck --enable=warning,style,performance --error-exitcode=0 \
          --suppress=missingIncludeSystem --suppress=unusedFunction --inconclusive src/
    
    - name: Run clang-tidy
      continue-on-error: true
      run: |
        find src -name "*.cc" -not -path "*/lib/*" | head -20 | \
          xargs clang-tidy-14 --header-filter='src/.*\.(h|hpp)$'

  memory-sanitizer:
    name: "Memory Sanitizer"
    runs-on: ubuntu-22.04
    if: |
      github.event_name == 'pull_request' || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.run_sanitizers == 'true')
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential ninja-build clang-14 libc++-14-dev libc++abi-14-dev \
          libglew-dev libxext-dev libwavpack-dev libpng-dev libgtk-3-dev libdbus-1-dev
    
    - name: Configure with AddressSanitizer
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_C_COMPILER=clang-14 \
          -DCMAKE_CXX_COMPILER=clang++-14 \
          -DCMAKE_CXX_FLAGS="-fsanitize=address -fno-omit-frame-pointer" \
          -DYAZE_BUILD_TESTS=ON
    
    - name: Build
      run: cmake --build build --parallel
    
    - name: Test
      working-directory: build
      env:
        ASAN_OPTIONS: detect_leaks=1:abort_on_error=1
      run: ctest --output-on-failure

  z3ed-agent-test:
    name: "z3ed Agent"
    runs-on: macos-14
    # Only run on master/develop push, not on PRs (moved to nightly for PRs)
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop')

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install Dependencies
      run: brew install ollama ninja
    
    - name: Build z3ed
      run: |
        cmake -B build_test -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DZ3ED_AI=ON \
          -DYAZE_BUILD_Z3ED=ON \
          -DYAZE_ENABLE_AI_RUNTIME=ON \
          -DYAZE_ENABLE_GRPC=ON \
          -DYAZE_ENABLE_REMOTE_AUTOMATION=ON \
          -DYAZE_BUILD_AGENT_UI=ON
        cmake --build build_test --target z3ed
    
    - name: Start Ollama
      env:
        OLLAMA_MODEL: qwen2.5-coder:0.5b
      run: |
        ollama serve & 
        sleep 10
        ollama pull "$OLLAMA_MODEL"
    
    - name: Run Test Suite
      env:
        OLLAMA_MODEL: qwen2.5-coder:0.5b
      run: |
        chmod +x ./scripts/agent_test_suite.sh
        ./scripts/agent_test_suite.sh ollama
