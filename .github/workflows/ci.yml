name: CI/CD Pipeline

on:
  push:
    branches: [ "master", "develop" ]
    paths:
      - 'src/**'
      - 'test/**'
      - 'cmake/**'
      - 'CMakeLists.txt'
      - '.github/workflows/**'
  pull_request:
    branches: [ "master", "develop" ]
    paths:
      - 'src/**'
      - 'test/**'
      - 'cmake/**'
      - 'CMakeLists.txt'
      - '.github/workflows/**'

env:
  BUILD_TYPE: RelWithDebInfo

jobs:
  build-and-test:
    name: "${{ matrix.name }}"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "Ubuntu 22.04 (GCC-12)"
            os: ubuntu-22.04
            cc: gcc-12
            cxx: g++-12
          - name: "macOS 14 (Clang)"
            os: macos-14
            cc: clang
            cxx: clang++
          - name: "Windows 2022 (MSVC)"
            os: windows-2022
            cc: cl
            cxx: cl

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
      
    - name: Set up vcpkg (Windows only)
      if: runner.os == 'Windows'
      uses: lukka/run-vcpkg@v11
      id: vcpkg
      continue-on-error: true
      with:
        vcpkgDirectory: '${{ github.workspace }}/vcpkg'
        vcpkgGitCommitId: 'a42af01b72c28a8e1d7b48107b33e4f286a55ef6'  # 2024.07.12 release
        runVcpkgInstall: true
    
    - name: Retry vcpkg setup (Windows only)
      if: runner.os == 'Windows' && steps.vcpkg.outcome == 'failure'
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgDirectory: '${{ github.workspace }}/vcpkg'
        vcpkgGitCommitId: 'a42af01b72c28a8e1d7b48107b33e4f286a55ef6'
        runVcpkgInstall: true
        doNotUpdateVcpkg: true  # Use existing clone on retry

    - name: Install Dependencies
      id: deps
      shell: bash
      continue-on-error: true
      run: |
        if [[ "${{ runner.os }}" == "Linux" ]]; then
          sudo apt-get update
          sudo apt-get install -y \
            build-essential ninja-build pkg-config \
            libglew-dev libxext-dev libwavpack-dev libboost-all-dev \
            libpng-dev python3-dev libpython3-dev \
            libasound2-dev libpulse-dev libaudio-dev \
            libx11-dev libxrandr-dev libxcursor-dev libxinerama-dev libxi-dev \
            libxss-dev libxxf86vm-dev libxkbcommon-dev libwayland-dev libdecor-0-dev \
            libgtk-3-dev libdbus-1-dev \
            ${{ matrix.cc }} ${{ matrix.cxx }}
          # Note: libabsl-dev removed - gRPC uses bundled Abseil via FetchContent when enabled
        elif [[ "${{ runner.os }}" == "macOS" ]]; then
          brew install ninja pkg-config
        fi
    
    - name: Retry Dependencies (if failed)
      if: steps.deps.outcome == 'failure'
      shell: bash
      run: |
        echo "::warning::First dependency install failed, retrying..."
        if [[ "${{ runner.os }}" == "Linux" ]]; then
          sudo apt-get clean
          sudo apt-get update --fix-missing
          sudo apt-get install -y \
            build-essential ninja-build pkg-config \
            libglew-dev libxext-dev libwavpack-dev libboost-all-dev \
            libpng-dev python3-dev libpython3-dev \
            libasound2-dev libpulse-dev libaudio-dev \
            libx11-dev libxrandr-dev libxcursor-dev libxinerama-dev libxi-dev \
            libxss-dev libxxf86vm-dev libxkbcommon-dev libwayland-dev libdecor-0-dev \
            libgtk-3-dev libdbus-1-dev \
            ${{ matrix.cc }} ${{ matrix.cxx }}
        elif [[ "${{ runner.os }}" == "macOS" ]]; then
          brew update
          brew install ninja pkg-config
        fi

    - name: Configure
      id: configure
      shell: bash
      run: |
        set -e
        echo "::group::CMake Configuration"
        if [[ "${{ runner.os }}" == "Windows" ]]; then
          cmake -B build -G "Visual Studio 17 2022" -A x64 \
            -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
            -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake \
            -DYAZE_MINIMAL_BUILD=ON \
            -DYAZE_ENABLE_ROM_TESTS=OFF 2>&1 | tee cmake_config.log
        else
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
            -DCMAKE_C_COMPILER=${{ matrix.cc }} \
            -DCMAKE_CXX_COMPILER=${{ matrix.cxx }} \
            -DYAZE_MINIMAL_BUILD=ON \
            -DYAZE_ENABLE_ROM_TESTS=OFF 2>&1 | tee cmake_config.log
        fi
        echo "::endgroup::"
    
    - name: Report Configure Failure
      if: failure() && steps.configure.outcome == 'failure'
      shell: bash
      run: |
        echo "::error::CMake configuration failed. Check cmake_config.log for details."
        if [ -f cmake_config.log ]; then
          echo "::group::CMake Configuration Log (last 50 lines)"
          tail -50 cmake_config.log
          echo "::endgroup::"
        fi
        if [ -f build/CMakeFiles/CMakeError.log ]; then
          echo "::group::CMake Error Log"
          cat build/CMakeFiles/CMakeError.log
          echo "::endgroup::"
        fi
    
    - name: Build
      id: build
      run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel 2>&1 | tee build.log
    
    - name: Report Build Failure
      if: failure() && steps.build.outcome == 'failure'
      shell: bash
      run: |
        echo "::error::Build failed. Check build.log for details."
        if [ -f build.log ]; then
          echo "::group::Build Log (last 100 lines)"
          tail -100 build.log
          echo "::endgroup::"
          
          # Extract and highlight actual errors
          echo "::group::Build Errors"
          grep -i "error" build.log | head -20 || true
          echo "::endgroup::"
        fi

    - name: Test (Core)
      id: test_core
      working-directory: build
      run: |
        ctest --build-config ${{ env.BUILD_TYPE }} --output-on-failure -j1 \
          -R "AsarWrapperTest|SnesTileTest|CompressionTest|SnesPaletteTest|HexTest|MessageTest" \
          --output-junit core_test_results.xml 2>&1 | tee ../core_test.log
    
    - name: Test (Additional - Informational)
      id: test_additional
      working-directory: build
      continue-on-error: true
      run: |
        ctest --build-config ${{ env.BUILD_TYPE }} --output-on-failure --parallel \
          -R ".*Test" -E ".*RomTest.*|.*E2E.*|.*ZSCustomOverworld.*|.*IntegrationTest.*|CpuTest|Spc700Test|ApuTest" \
          --output-junit additional_test_results.xml 2>&1 | tee ../additional_test.log
    
    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.name }}
        path: |
          build/*test_results.xml
          core_test.log
          additional_test.log
        retention-days: 7
    
    - name: Upload Build Logs on Failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ matrix.name }}
        path: |
          cmake_config.log
          build.log
          build/CMakeFiles/CMakeError.log
          build/CMakeFiles/CMakeOutput.log
        if-no-files-found: ignore
        retention-days: 7
    
    - name: Generate Job Summary
      if: always()
      shell: bash
      run: |
        echo "## Build Summary - ${{ matrix.name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Configuration info
        echo "### Configuration" >> $GITHUB_STEP_SUMMARY
        echo "- **Platform**: ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Compiler**: ${{ matrix.cc }}/${{ matrix.cxx }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Type**: ${{ env.BUILD_TYPE }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Minimal Build**: ON" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Build status
        echo "### Build Status" >> $GITHUB_STEP_SUMMARY
        if [[ "${{ steps.configure.outcome }}" == "success" ]]; then
          echo "- âœ… Configure: Success" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ Configure: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [[ "${{ steps.build.outcome }}" == "success" ]]; then
          echo "- âœ… Build: Success" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ Build: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [[ "${{ steps.test_core.outcome }}" == "success" ]]; then
          echo "- âœ… Core Tests: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ Core Tests: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [[ "${{ steps.test_additional.outcome }}" == "success" ]]; then
          echo "- âœ… Additional Tests: Passed" >> $GITHUB_STEP_SUMMARY
        elif [[ "${{ steps.test_additional.outcome }}" == "failure" ]]; then
          echo "- âš ï¸ Additional Tests: Failed (informational)" >> $GITHUB_STEP_SUMMARY
        else
          echo "- â­ï¸ Additional Tests: Skipped" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Test results
        if [ -f build/core_test_results.xml ]; then
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          grep -E "tests=|failures=|errors=" build/core_test_results.xml | head -1 || echo "Test summary not available"
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi

  code-quality:
    name: "âœ¨ Code Quality"
    runs-on: ubuntu-22.04
    continue-on-error: ${{ github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/') }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format-14 clang-tidy-14 cppcheck
    
    - name: Check Formatting
      run: find src test -name "*.cc" -o -name "*.h" | xargs clang-format-14 --dry-run --Werror
    
    - name: Run cppcheck
      run: |
        cppcheck --enable=warning,style,performance --error-exitcode=0 \
          --suppress=missingIncludeSystem --suppress=unusedFunction --inconclusive src/
    
    - name: Run clang-tidy
      run: |
        find src -name "*.cc" -not -path "*/lib/*" | head -20 | \
          xargs clang-tidy-14 --header-filter='src/.*\.(h|hpp)$'

  memory-sanitizer:
    name: "ðŸ”¬ Memory Sanitizer"
    runs-on: ubuntu-22.04
    if: github.event_name == 'pull_request'
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential ninja-build clang-14 libc++-14-dev libc++abi-14-dev \
          libglew-dev libxext-dev libwavpack-dev libpng-dev libgtk-3-dev libdbus-1-dev
    
    - name: Configure with AddressSanitizer
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_C_COMPILER=clang-14 \
          -DCMAKE_CXX_COMPILER=clang++-14 \
          -DCMAKE_CXX_FLAGS="-fsanitize=address -fno-omit-frame-pointer" \
          -DYAZE_MINIMAL_BUILD=ON
    
    - name: Build
      run: cmake --build build --parallel
    
    - name: Test
      working-directory: build
      env:
        ASAN_OPTIONS: detect_leaks=1:abort_on_error=1
      run: ctest --output-on-failure

  z3ed-agent-test:
    name: "ðŸ¤– z3ed Agent"
    runs-on: macos-14
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install Dependencies
      run: brew install ollama ninja
    
    - name: Build z3ed
      run: |
        cmake -B build_test -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DZ3ED_AI=ON \
          -DYAZE_BUILD_Z3ED=ON
        cmake --build build_test --target z3ed
    
    - name: Start Ollama
      run: |
        ollama serve & 
        sleep 10
        ollama pull qwen2.5-coder:7b
    
    - name: Run Test Suite
      run: |
        chmod +x scripts/agent_test_suite.sh
        ./scripts/agent_test_suite.sh ollama
