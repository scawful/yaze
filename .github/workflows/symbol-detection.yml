name: Symbol Conflict Detection

on:
  push:
    branches: [ "master", "develop" ]
    paths:
      - 'src/**/*.cc'
      - 'src/**/*.h'
      - 'test/**/*.cc'
      - 'test/**/*.h'
      - '.github/workflows/symbol-detection.yml'
  pull_request:
    branches: [ "master", "develop" ]
    paths:
      - 'src/**/*.cc'
      - 'src/**/*.h'
      - 'test/**/*.cc'
      - 'test/**/*.h'
      - '.github/workflows/symbol-detection.yml'
  workflow_dispatch:

jobs:
  symbol-detection:
    name: "Symbol Conflict Detection"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "Linux"
            os: ubuntu-22.04
            platform: linux
            preset: ci-linux
          - name: "macOS"
            os: macos-14
            platform: macos
            preset: ci-macos
          - name: "Windows"
            os: windows-2022
            platform: windows
            preset: ci-windows

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup build environment
        uses: ./.github/actions/setup-build
        with:
          platform: ${{ matrix.platform }}
          preset: ${{ matrix.preset }}
          cache-key: ${{ hashFiles('cmake/dependencies.lock') }}

      - name: Build project (Release)
        uses: ./.github/actions/build-project
        with:
          platform: ${{ matrix.platform }}
          preset: ${{ matrix.preset }}
          build-type: Release

      - name: Extract symbols (Unix/macOS)
        if: runner.os != 'Windows'
        run: |
          echo "Extracting symbols from object files..."
          ./scripts/extract-symbols.sh build

      - name: Extract symbols (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          echo "Extracting symbols from object files..."
          # Note: Windows version uses dumpbin, may require Visual Studio
          bash ./scripts/extract-symbols.sh build

      - name: Check for duplicate symbols
        if: always()
        run: |
          echo "Checking for symbol conflicts..."
          ./scripts/check-duplicate-symbols.sh build/symbol_database.json || {
            echo "Symbol conflicts detected!"
            exit 1
          }

      - name: Upload symbol database
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: symbol-database-${{ matrix.platform }}
          path: build/symbol_database.json
          if-no-files-found: warn
          retention-days: 30

      - name: Generate symbol report
        if: always()
        run: |
          python3 << 'EOF'
          import json
          import sys

          try:
              with open("build/symbol_database.json") as f:
                  data = json.load(f)
          except FileNotFoundError:
              print("Symbol database not found")
              sys.exit(0)

          meta = data.get("metadata", {})
          conflicts = data.get("conflicts", [])

          print("\n=== Symbol Analysis Report ===")
          print(f"Platform: {meta.get('platform', '?')}")
          print(f"Object files scanned: {meta.get('object_files_scanned', 0)}")
          print(f"Total symbols: {meta.get('total_symbols', 0)}")
          print(f"Total conflicts: {len(conflicts)}")

          if conflicts:
              print("\nSymbol Conflicts:")
              for i, conflict in enumerate(conflicts[:10], 1):
                  symbol = conflict.get("symbol", "?")
                  count = conflict.get("count", 0)
                  defs = conflict.get("definitions", [])
                  print(f"\n  {i}. {symbol} (defined {count} times)")
                  for d in defs:
                      obj = d.get("object_file", "?")
                      print(f"     - {obj}")
              if len(conflicts) > 10:
                  print(f"\n  ... and {len(conflicts) - 10} more conflicts")
          else:
              print("\nNo symbol conflicts detected - symbol table is clean!")

          print("\n" + "="*40)
          EOF

      - name: Fail on conflicts
        if: always()
        run: |
          python3 << 'EOF'
          import json
          import sys

          try:
              with open("build/symbol_database.json") as f:
                  data = json.load(f)
          except FileNotFoundError:
              sys.exit(0)

          conflicts = data.get("conflicts", [])
          if conflicts:
              print(f"\nFAILED: Found {len(conflicts)} symbol conflicts")
              print("See artifact for detailed symbol database")
              sys.exit(1)
          else:
              print("\nPASSED: No symbol conflicts detected")
              sys.exit(0)
          EOF
