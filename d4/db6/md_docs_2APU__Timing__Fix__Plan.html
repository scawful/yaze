<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>yaze: APU Timing and Handshake Bug Analysis &amp; Refactoring Plan</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript">var page_layout=1;</script>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="side-nav" class="ui-resizable side-nav-resizable"><!-- do not remove this div, it is closed by doxygen! -->
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../yaze.ico"/></td>
  <td id="projectalign">
   <div id="projectname">yaze<span id="projectnumber">&#160;0.3.2</span>
   </div>
   <div id="projectbrief">Link to the Past ROM Editor</div>
  </td>
 </tr>
   <tr><td colspan="2">        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.svg" alt=""/></a>
          </span>
        </div>
</td></tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d4/db6/md_docs_2APU__Timing__Fix__Plan.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">APU Timing and Handshake Bug Analysis &amp; Refactoring Plan</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md24"></a> </p>
<h1><a class="anchor" id="autotoc_md25"></a>
1. Problem Statement</h1>
<p>The emulator's Audio Processing Unit (APU) currently fails to load and play music. Analysis of the execution flow indicates that the SPC700 processor gets "stuck" during the initial handshake sequence with the main CPU. This handshake is responsible for uploading the sound driver from the ROM to the APU's RAM. The failure of this timing-sensitive process prevents the sound driver from ever running, thus no music is played.</p>
<p>This document outlines the cause of this timing failure and proposes a refactoring plan to achieve cycle-accurate emulation required for a stable APU.</p>
<h1><a class="anchor" id="autotoc_md26"></a>
2. Analysis of the CPU-APU Handshake</h1>
<p>The process of starting the APU and loading a sound bank is not a simple data transfer; it is a tightly synchronized conversation between the main CPU (65816) and the APU's CPU (SPC700).</p>
<h2><a class="anchor" id="autotoc_md27"></a>
2.1. The Conversation Protocol</h2>
<p>The main CPU, executing the <code>LoadSongBank</code> routine (<code>#_008888</code> in <code>bank_00.asm</code>), and the SPC700, executing its internal IPL ROM (<code>bootRom</code> in <code><a class="el" href="../../da/ddf/apu_8cc.html">apu.cc</a></code>), follow a strict protocol:</p>
<ol type="1">
<li><b>APU Ready</b>: The SPC700 boots, initializes itself, and signals it is ready by writing <code>$AA</code> to its port <code>$F4</code> and <code>$BB</code> to port <code>$F5</code>.</li>
<li><b>CPU Waits</b>: The main CPU waits in a tight loop, reading the combined 16-bit value from its I/O ports until it sees <code>$BBAA</code>. This confirms the APU is alive.</li>
<li><b>CPU Initiates</b>: The CPU writes the command code <code>$CC</code> to the APU's input port.</li>
<li><b>APU Acknowledges</b>: The SPC700, which was waiting for this command, sees <code>$CC</code> and prepares to receive a block of data.</li>
<li><b>Synchronized Byte Transfer</b>: The CPU and APU then enter a lock-step loop to transfer the sound driver byte-by-byte. For each byte:<ul>
<li>The CPU sends the data.</li>
<li>The CPU waits for the APU to read the data and echo back a confirmation value.</li>
<li>Only upon receiving the confirmation does the CPU send the next byte.</li>
</ul>
</li>
</ol>
<h2><a class="anchor" id="autotoc_md28"></a>
2.2. Point of Failure</h2>
<p>The "stuck" behavior occurs because one side of this conversation fails to meet the other's expectation. Due to timing desynchronization, either:</p><ul>
<li>The SPC700 is waiting for a byte that the CPU has not yet sent (or sent too early).</li>
<li>The CPU is waiting for an acknowledgment that the SPC700 has already sent (or has not yet sent).</li>
</ul>
<p>The result is an infinite loop on the SPC700, which is what the watchdog timer in <code>Apu::RunCycles</code> detects.</p>
<h1><a class="anchor" id="autotoc_md29"></a>
3. Root Cause: Cycle Inaccuracy in SPC700 Emulation</h1>
<p>The handshake's reliance on precise timing exposes inaccuracies in the current SPC700 emulation model. The core issue is that the emulator does not calculate the <em>exact</em> number of cycles each SPC700 instruction consumes.</p>
<h2><a class="anchor" id="autotoc_md30"></a>
3.1. Incomplete Opcode Timing</h2>
<p>The emulator uses a static lookup table (<code><a class="el" href="../../d8/d16/spc700__cycles_8h.html">spc700_cycles.h</a></code>) for instruction cycle counts. This provides a <em>base</em> value but fails to account for critical variations:</p><ul>
<li><b>Addressing Modes</b>: Different addressing modes have different cycle costs.</li>
<li><b>Page Boundaries</b>: Memory accesses that cross a 256-byte page boundary take an extra cycle.</li>
<li><b>Branching</b>: Conditional branches take a different number of cycles depending on whether the branch is taken or not.</li>
</ul>
<p>While some of this is handled (e.g., <code>DoBranch</code>), it is not applied universally, leading to small, cumulative errors.</p>
<h2><a class="anchor" id="autotoc_md31"></a>
3.2. Fragile Multi-Step Execution Model</h2>
<p>The <code>step</code>/<code>bstep</code> mechanism in <code>Spc700::RunOpcode</code> is a significant source of fragility. It attempts to model complex instructions by spreading their execution across multiple calls. This means the full cycle cost of an instruction is not consumed atomically. An off-by-one error in any step, or an incorrect transition, can corrupt the timing of the entire APU, causing the handshake to fail.</p>
<h2><a class="anchor" id="autotoc_md32"></a>
3.3. Floating-Point Precision</h2>
<p>The use of a <code>double</code> for the <code>apuCyclesPerMaster</code> ratio can introduce minute floating-point precision errors. Over the thousands of cycles required for the handshake, these small errors can accumulate and contribute to the overall timing drift between the CPU and APU.</p>
<h1><a class="anchor" id="autotoc_md33"></a>
4. Proposed Refactoring Plan</h1>
<p>To resolve this, the APU emulation must be refactored from its current instruction-based timing model to a more robust <b>cycle-accurate model</b>. This is the standard approach for emulating timing-sensitive hardware.</p>
<h2><a class="anchor" id="autotoc_md34"></a>
Step 1: Implement Cycle-Accurate Instruction Execution</h2>
<p>The <code>Spc700::RunOpcode</code> function must be refactored to calculate and consume the <em>exact</em> cycle count for each instruction <em>before</em> execution.</p>
<ul>
<li><b>Calculate Exact Cost</b>: Before running an opcode, determine its precise cycle cost by analyzing its opcode, addressing mode, and potential page-boundary penalties. The <code><a class="el" href="../../d8/d16/spc700__cycles_8h.html">spc700_cycles.h</a></code> table should be used as a base, with additional cycles added as needed.</li>
<li><b>Atomic Execution</b>: The <code>bstep</code> mechanism should be removed. An instruction, no matter how complex, should be fully executed within a single call to a new <code>Spc700::Step()</code> function. This function will be responsible for consuming the exact number of cycles it calculated.</li>
</ul>
<h2><a class="anchor" id="autotoc_md35"></a>
Step 2: Centralize the APU Execution Loop</h2>
<p>The main <code>Apu::RunCycles</code> loop should be the sole driver of APU time.</p>
<ul>
<li><b>Cycle Budget</b>: At the start of a frame, <code>Apu::RunCycles</code> will calculate the total "budget" of APU cycles it needs to execute.</li>
<li><b>Cycle-by-Cycle Stepping</b>: It will then loop, calling <code>Spc700::Step()</code> and <code>Dsp::Cycle()</code> and decrementing its cycle budget, until the budget is exhausted. This ensures the SPC700 and DSP are always perfectly synchronized.</li>
</ul>
<p><b>Example of the new loop in <code>Apu::RunCycles</code>:</b> </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> Apu::RunCycles(uint64_t master_cycles) {</div>
<div class="line">  <span class="comment">// 1. Calculate cycle budget for this frame</span></div>
<div class="line">  <span class="keyword">const</span> uint64_t target_apu_cycles = ...; </div>
<div class="line"> </div>
<div class="line">  <span class="comment">// 2. Run the APU until the budget is met</span></div>
<div class="line">  <span class="keywordflow">while</span> (cycles_ &lt; target_apu_cycles) {</div>
<div class="line">    <span class="comment">// 3. Execute one SPC700 cycle/instruction and get its true cost</span></div>
<div class="line">    <span class="keywordtype">int</span> spc_cycles_consumed = spc700_.Step();</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// 4. Advance DSP and Timers for each cycle consumed</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; spc_cycles_consumed; ++i) {</div>
<div class="line">      Cycle(); <span class="comment">// This ticks the DSP and timers</span></div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md36"></a>
Step 3: Use Integer-Based Cycle Ratios</h2>
<p>To eliminate floating-point errors, the <code>apuCyclesPerMaster</code> ratio should be converted to a fixed-point integer ratio. This provides perfect, drift-free conversion between main CPU and APU cycles over long periods.</p>
<h1><a class="anchor" id="autotoc_md37"></a>
5. Conclusion</h1>
<p>The APU handshake failure is a classic and challenging emulation problem that stems directly from timing inaccuracies. By refactoring the SPC700 execution loop to be cycle-accurate, we can ensure the emulated CPU and APU remain perfectly synchronized, allowing the handshake to complete successfully and enabling music playback. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
