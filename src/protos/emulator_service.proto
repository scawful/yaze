syntax = "proto3";

package yaze.agent;

// The consolidated service for controlling the yaze emulator
service EmulatorService {
  // --- Core Lifecycle & Control ---
  // action: "start", "stop", "pause", "resume", "reset"
  rpc ControlEmulator(ControlRequest) returns (CommandResponse);
  
  // mode: "instruction", "over", "out"
  rpc StepEmulator(StepControlRequest) returns (StepResponse);
  
  rpc RunToBreakpoint(Empty) returns (BreakpointHitResponse);

  // --- Input & State ---
  rpc PressButtons(ButtonRequest) returns (CommandResponse);
  rpc HoldButtons(ButtonHoldRequest) returns (CommandResponse);
  rpc GetGameState(GameStateRequest) returns (GameStateResponse);
  rpc ReadMemory(MemoryRequest) returns (MemoryResponse);
  rpc WriteMemory(MemoryWriteRequest) returns (CommandResponse);

  // --- Debugging Management ---
  // action: "add", "remove", "list", "toggle"
  rpc BreakpointControl(BreakpointControlRequest) returns (BreakpointControlResponse);
  
  // action: "add", "remove", "list", "history"
  rpc WatchpointControl(WatchpointControlRequest) returns (WatchpointControlResponse);

  // --- Analysis & Symbols ---
  rpc GetDisassembly(DisassemblyRequest) returns (DisassemblyResponse);
  rpc GetExecutionTrace(TraceRequest) returns (TraceResponse);
  rpc ResolveSymbol(SymbolLookupRequest) returns (SymbolLookupResponse);
  rpc GetSymbolAt(AddressRequest) returns (SymbolLookupResponse);
  rpc LoadSymbols(SymbolFileRequest) returns (CommandResponse);

  // --- Session & Experiments ---
  rpc GetDebugStatus(Empty) returns (DebugStatusResponse);
  rpc TestRun(TestRunRequest) returns (TestRunResponse);
}

// --- Message Definitions ---

message Empty {}

message CommandResponse {
  bool success = 1;
  string message = 2;
}

message ControlRequest {
  string action = 1; // "start", "stop", "pause", "resume", "reset"
}

enum Button {
  BUTTON_UNSPECIFIED = 0;
  A = 1; B = 2; X = 3; Y = 4;
  L = 5; R = 6; SELECT = 7; START = 8;
  UP = 9; DOWN = 10; LEFT = 11; RIGHT = 12;
}

message ButtonRequest {
  repeated Button buttons = 1;
}

message ButtonHoldRequest {
  repeated Button buttons = 1;
  uint32 duration_ms = 2;
}

message GameStateRequest {
  bool include_screenshot = 1;
  repeated MemoryRequest memory_reads = 2;
}

message GameStateResponse {
  uint32 game_mode = 1;
  uint32 link_state = 2;
  uint32 link_pos_x = 3;
  uint32 link_pos_y = 4;
  uint32 link_health = 5;
  bytes screenshot_png = 6;
  repeated MemoryResponse memory_responses = 7;
}

message MemoryRequest {
  uint32 address = 1;
  uint32 size = 2;
}

message MemoryResponse {
  uint32 address = 1;
  bytes data = 2;
}

message MemoryWriteRequest {
  uint32 address = 1;
  bytes data = 2;
}

// --- Breakpoint Control ---

enum BreakpointType {
  BREAKPOINT_TYPE_UNSPECIFIED = 0;
  EXECUTE = 1; READ = 2; WRITE = 3; ACCESS = 4; CONDITIONAL = 5;
}

enum CpuType {
  CPU_TYPE_UNSPECIFIED = 0;
  CPU_65816 = 1;
  SPC700 = 2;
}

message BreakpointControlRequest {
  string action = 1; // "add", "remove", "list", "toggle"
  uint32 id = 2;     // For remove/toggle
  uint32 address = 3; // For add
  BreakpointType type = 4;
  CpuType cpu = 5;
  string condition = 6;
  string description = 7;
  bool enabled = 8;
}

message BreakpointInfo {
  uint32 id = 1;
  uint32 address = 2;
  BreakpointType type = 3;
  CpuType cpu = 4;
  bool enabled = 5;
  string condition = 6;
  string description = 7;
  uint32 hit_count = 8;
}

message BreakpointControlResponse {
  bool success = 1;
  string message = 2;
  uint32 breakpoint_id = 3; // For newly added
  repeated BreakpointInfo breakpoints = 4; // For list
}

// --- Watchpoint Control ---

message WatchpointControlRequest {
  string action = 1; // "add", "remove", "list", "history"
  uint32 id = 2;
  uint32 start_address = 3;
  uint32 end_address = 4;
  bool track_reads = 5;
  bool track_writes = 6;
  bool break_on_access = 7;
  string description = 8;
  uint32 max_entries = 9; // For history
}

message WatchpointInfo {
  uint32 id = 1;
  uint32 start_address = 2;
  uint32 end_address = 3;
  bool track_reads = 4;
  bool track_writes = 5;
  bool break_on_access = 6;
  bool enabled = 7;
  string description = 8;
}

message AccessLogEntry {
  uint32 pc = 1;
  uint32 address = 2;
  uint32 old_value = 3;
  uint32 new_value = 4;
  bool is_write = 5;
  uint64 cycle_count = 6;
}

message WatchpointControlResponse {
  bool success = 1;
  string message = 2;
  uint32 watchpoint_id = 3;
  repeated WatchpointInfo watchpoints = 4;
  repeated AccessLogEntry history = 5;
}

// --- Stepping & Status ---

message StepControlRequest {
  string mode = 1; // "instruction", "over", "out"
}

message CPUState {
  uint32 a = 1; uint32 x = 2; uint32 y = 3; uint32 sp = 4;
  uint32 pc = 5; uint32 db = 6; uint32 pb = 7; uint32 d = 8;
  uint32 status = 9;
  bool flag_n = 10; bool flag_v = 11; bool flag_z = 12; bool flag_c = 13;
  uint64 cycles = 14;
}

message StepResponse {
  bool success = 1;
  string message = 2;
  CPUState cpu_state = 3;
}

message BreakpointHitResponse {
  bool hit = 1;
  BreakpointInfo breakpoint = 2;
  CPUState cpu_state = 3;
}

message DisassemblyRequest {
  uint32 start_address = 1;
  uint32 count = 2;
}

message DisassemblyLine {
  uint32 address = 1;
  string mnemonic = 2;
  string operand_str = 3;
  bool is_breakpoint = 4;
}

message DisassemblyResponse {
  repeated DisassemblyLine lines = 1;
}

message TraceRequest { uint32 max_entries = 1; }
message TraceResponse { 
    message Entry { uint32 address = 1; string instruction = 2; uint32 opcode = 3; }
    repeated Entry entries = 1; 
}

message SymbolFileRequest {
  string filepath = 1;
  enum Format { AUTO = 0; ASAR = 1; WLA_DX = 2; MESEN = 3; }
  Format format = 2;
}

message SymbolLookupRequest { string symbol_name = 1; }
message AddressRequest { uint32 address = 1; }
message SymbolLookupResponse {
  bool found = 1;
  string symbol_name = 2;
  uint32 address = 3;
  string type = 4;
}

message DebugStatusResponse {
  bool is_running = 1;
  CPUState cpu_state = 2;
  uint32 active_breakpoints = 3;
}

message TestRunRequest {
  uint32 address = 1;
  bytes data = 2;
  uint32 frame_count = 3;
  bool reset_after = 4;
}

message TestRunResponse {
  bool success = 1;
  string message = 2;
  CPUState final_cpu_state = 3;
  bool crashed = 4;
}