#include "app/editor/layout_designer/theme_properties.h"

#include "absl/strings/str_format.h"
#include "app/gui/core/icons.h"

namespace yaze {
namespace editor {
namespace layout_designer {

void ThemeProperties::Apply() const {
  ImGuiStyle& style = ImGui::GetStyle();
  
  // Padding
  style.WindowPadding = window_padding;
  style.FramePadding = frame_padding;
  style.CellPadding = cell_padding;
  style.ItemSpacing = item_spacing;
  style.ItemInnerSpacing = item_inner_spacing;
  
  // Rounding
  style.WindowRounding = window_rounding;
  style.ChildRounding = child_rounding;
  style.FrameRounding = frame_rounding;
  style.PopupRounding = popup_rounding;
  style.ScrollbarRounding = scrollbar_rounding;
  style.GrabRounding = grab_rounding;
  style.TabRounding = tab_rounding;
  
  // Borders
  style.WindowBorderSize = window_border_size;
  style.ChildBorderSize = child_border_size;
  style.PopupBorderSize = popup_border_size;
  style.FrameBorderSize = frame_border_size;
  style.TabBorderSize = tab_border_size;
  
  // Sizes
  style.IndentSpacing = indent_spacing;
  style.ScrollbarSize = scrollbar_size;
  style.GrabMinSize = grab_min_size;
}

void ThemeProperties::LoadFromCurrent() {
  const ImGuiStyle& style = ImGui::GetStyle();
  
  window_padding = style.WindowPadding;
  frame_padding = style.FramePadding;
  cell_padding = style.CellPadding;
  item_spacing = style.ItemSpacing;
  item_inner_spacing = style.ItemInnerSpacing;
  
  window_rounding = style.WindowRounding;
  child_rounding = style.ChildRounding;
  frame_rounding = style.FrameRounding;
  popup_rounding = style.PopupRounding;
  scrollbar_rounding = style.ScrollbarRounding;
  grab_rounding = style.GrabRounding;
  tab_rounding = style.TabRounding;
  
  window_border_size = style.WindowBorderSize;
  child_border_size = style.ChildBorderSize;
  popup_border_size = style.PopupBorderSize;
  frame_border_size = style.FrameBorderSize;
  tab_border_size = style.TabBorderSize;
  
  indent_spacing = style.IndentSpacing;
  scrollbar_size = style.ScrollbarSize;
  grab_min_size = style.GrabMinSize;
}

void ThemeProperties::Reset() {
  *this = ThemeProperties();  // Reset to default values
}

std::string ThemeProperties::GenerateStyleCode() const {
  std::string code;
  
  code += "// Theme Configuration - Generated by Layout Designer\n";
  code += "void ApplyTheme() {\n";
  code += "  ImGuiStyle& style = ImGui::GetStyle();\n\n";
  
  code += "  // Padding\n";
  code += absl::StrFormat("  style.WindowPadding = ImVec2(%.1ff, %.1ff);\n",
                          window_padding.x, window_padding.y);
  code += absl::StrFormat("  style.FramePadding = ImVec2(%.1ff, %.1ff);\n",
                          frame_padding.x, frame_padding.y);
  code += absl::StrFormat("  style.CellPadding = ImVec2(%.1ff, %.1ff);\n",
                          cell_padding.x, cell_padding.y);
  code += absl::StrFormat("  style.ItemSpacing = ImVec2(%.1ff, %.1ff);\n",
                          item_spacing.x, item_spacing.y);
  code += absl::StrFormat("  style.ItemInnerSpacing = ImVec2(%.1ff, %.1ff);\n\n",
                          item_inner_spacing.x, item_inner_spacing.y);
  
  code += "  // Rounding\n";
  code += absl::StrFormat("  style.WindowRounding = %.1ff;\n", window_rounding);
  code += absl::StrFormat("  style.ChildRounding = %.1ff;\n", child_rounding);
  code += absl::StrFormat("  style.FrameRounding = %.1ff;\n", frame_rounding);
  code += absl::StrFormat("  style.PopupRounding = %.1ff;\n", popup_rounding);
  code += absl::StrFormat("  style.ScrollbarRounding = %.1ff;\n", scrollbar_rounding);
  code += absl::StrFormat("  style.GrabRounding = %.1ff;\n", grab_rounding);
  code += absl::StrFormat("  style.TabRounding = %.1ff;\n\n", tab_rounding);
  
  code += "  // Borders\n";
  code += absl::StrFormat("  style.WindowBorderSize = %.1ff;\n", window_border_size);
  code += absl::StrFormat("  style.ChildBorderSize = %.1ff;\n", child_border_size);
  code += absl::StrFormat("  style.PopupBorderSize = %.1ff;\n", popup_border_size);
  code += absl::StrFormat("  style.FrameBorderSize = %.1ff;\n", frame_border_size);
  code += absl::StrFormat("  style.TabBorderSize = %.1ff;\n\n", tab_border_size);
  
  code += "  // Sizes\n";
  code += absl::StrFormat("  style.IndentSpacing = %.1ff;\n", indent_spacing);
  code += absl::StrFormat("  style.ScrollbarSize = %.1ff;\n", scrollbar_size);
  code += absl::StrFormat("  style.GrabMinSize = %.1ff;\n", grab_min_size);
  
  code += "}\n";
  
  return code;
}

// ============================================================================
// ThemePropertiesPanel Implementation
// ============================================================================

bool ThemePropertiesPanel::Draw(ThemeProperties& properties) {
  bool modified = false;
  
  ImGui::Text(ICON_MD_PALETTE " Theme Properties");
  ImGui::TextDisabled("Configure visual styling");
  ImGui::Separator();
  
  if (ImGui::Button("Load from Current")) {
    properties.LoadFromCurrent();
    modified = true;
  }
  ImGui::SameLine();
  if (ImGui::Button("Apply to App")) {
    properties.Apply();
  }
  ImGui::SameLine();
  if (ImGui::Button("Reset")) {
    properties.Reset();
    modified = true;
  }
  
  ImGui::Spacing();
  ImGui::Separator();
  
  // Sections
  DrawPaddingSection(properties);
  DrawRoundingSection(properties);
  DrawBordersSection(properties);
  DrawSizesSection(properties);
  
  return modified;
}

void ThemePropertiesPanel::DrawPaddingSection(ThemeProperties& properties) {
  if (ImGui::CollapsingHeader(ICON_MD_SPACE_BAR " Padding", 
                              show_padding_ ? ImGuiTreeNodeFlags_DefaultOpen : 0)) {
    ImGui::SliderFloat2("Window Padding", &properties.window_padding.x, 0.0f, 20.0f, "%.0f");
    ImGui::SliderFloat2("Frame Padding", &properties.frame_padding.x, 0.0f, 20.0f, "%.0f");
    ImGui::SliderFloat2("Cell Padding", &properties.cell_padding.x, 0.0f, 20.0f, "%.0f");
    ImGui::SliderFloat2("Item Spacing", &properties.item_spacing.x, 0.0f, 20.0f, "%.0f");
    ImGui::SliderFloat2("Item Inner Spacing", &properties.item_inner_spacing.x, 0.0f, 20.0f, "%.0f");
  }
}

void ThemePropertiesPanel::DrawRoundingSection(ThemeProperties& properties) {
  if (ImGui::CollapsingHeader(ICON_MD_ROUNDED_CORNER " Rounding",
                              show_rounding_ ? ImGuiTreeNodeFlags_DefaultOpen : 0)) {
    ImGui::SliderFloat("Window Rounding", &properties.window_rounding, 0.0f, 12.0f, "%.0f");
    ImGui::SliderFloat("Child Rounding", &properties.child_rounding, 0.0f, 12.0f, "%.0f");
    ImGui::SliderFloat("Frame Rounding", &properties.frame_rounding, 0.0f, 12.0f, "%.0f");
    ImGui::SliderFloat("Popup Rounding", &properties.popup_rounding, 0.0f, 12.0f, "%.0f");
    ImGui::SliderFloat("Scrollbar Rounding", &properties.scrollbar_rounding, 0.0f, 12.0f, "%.0f");
    ImGui::SliderFloat("Grab Rounding", &properties.grab_rounding, 0.0f, 12.0f, "%.0f");
    ImGui::SliderFloat("Tab Rounding", &properties.tab_rounding, 0.0f, 12.0f, "%.0f");
  }
}

void ThemePropertiesPanel::DrawBordersSection(ThemeProperties& properties) {
  if (ImGui::CollapsingHeader(ICON_MD_BORDER_ALL " Borders",
                              show_borders_ ? ImGuiTreeNodeFlags_DefaultOpen : 0)) {
    ImGui::SliderFloat("Window Border", &properties.window_border_size, 0.0f, 2.0f, "%.0f");
    ImGui::SliderFloat("Child Border", &properties.child_border_size, 0.0f, 2.0f, "%.0f");
    ImGui::SliderFloat("Popup Border", &properties.popup_border_size, 0.0f, 2.0f, "%.0f");
    ImGui::SliderFloat("Frame Border", &properties.frame_border_size, 0.0f, 2.0f, "%.0f");
    ImGui::SliderFloat("Tab Border", &properties.tab_border_size, 0.0f, 2.0f, "%.0f");
  }
}

void ThemePropertiesPanel::DrawSizesSection(ThemeProperties& properties) {
  if (ImGui::CollapsingHeader(ICON_MD_STRAIGHTEN " Sizes",
                              show_sizes_ ? ImGuiTreeNodeFlags_DefaultOpen : 0)) {
    ImGui::SliderFloat("Indent Spacing", &properties.indent_spacing, 0.0f, 30.0f, "%.0f");
    ImGui::SliderFloat("Scrollbar Size", &properties.scrollbar_size, 1.0f, 20.0f, "%.0f");
    ImGui::SliderFloat("Grab Min Size", &properties.grab_min_size, 1.0f, 20.0f, "%.0f");
  }
}

}  // namespace layout_designer
}  // namespace editor
}  // namespace yaze

