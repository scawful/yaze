import Foundation

struct YazeProjectBundleManifest: Codable {
  var version: Int = 1
  var createdAt: String
  var projectName: String
  var romName: String
  var notes: String
}

final class YazeProjectBundleService {
  static func exportBundle(settingsStore: YazeSettingsStore) -> URL? {
    let fileManager = FileManager.default
    let temp = fileManager.temporaryDirectory
    let timestamp = ISO8601DateFormatter().string(from: Date())
    let bundleName = "yaze_\(timestamp.replacingOccurrences(of: ":", with: "-"))"
    let bundleURL = temp.appendingPathComponent("\(bundleName).yazeproj", isDirectory: true)

    do {
      if fileManager.fileExists(atPath: bundleURL.path) {
        try fileManager.removeItem(at: bundleURL)
      }
      try fileManager.createDirectory(at: bundleURL, withIntermediateDirectories: true)

      let settingsURL = settingsStore.settingsFileURL
      if fileManager.fileExists(atPath: settingsURL.path) {
        try fileManager.copyItem(at: settingsURL, to: bundleURL.appendingPathComponent("settings.json"))
      }

      var projectName = ""
      var romName = ""

      if !settingsStore.settings.general.lastProjectPath.isEmpty {
        let projectURL = URL(fileURLWithPath: settingsStore.settings.general.lastProjectPath)
        if projectURL.pathExtension == "yazeproj" {
          // New unified bundle format: the "project" folder inside the bundle
          // is the code snapshot. Prefer `project/`, fallback to `code/`.
          projectName = projectURL.deletingPathExtension().lastPathComponent
          let codeA = projectURL.appendingPathComponent("project", isDirectory: true)
          let codeB = projectURL.appendingPathComponent("code", isDirectory: true)
          let codeSrc = fileManager.fileExists(atPath: codeA.path) ? codeA : codeB
          if fileManager.fileExists(atPath: codeSrc.path) {
            let dest = bundleURL.appendingPathComponent("project", isDirectory: true)
            try copyDirectory(from: codeSrc, to: dest)
          }

          let romSrc = projectURL.appendingPathComponent("rom")
          if fileManager.fileExists(atPath: romSrc.path) {
            romName = romSrc.lastPathComponent
            let dest = bundleURL.appendingPathComponent("rom")
            if fileManager.fileExists(atPath: dest.path) {
              try fileManager.removeItem(at: dest)
            }
            try fileManager.copyItem(at: romSrc, to: dest)
          }
        } else {
          projectName = projectURL.lastPathComponent
          let dest = bundleURL.appendingPathComponent("project", isDirectory: true)
          try copyDirectory(from: projectURL, to: dest)
        }
      }

      if !settingsStore.settings.general.lastRomPath.isEmpty && romName.isEmpty {
        let romURL = URL(fileURLWithPath: settingsStore.settings.general.lastRomPath)
        romName = romURL.lastPathComponent
        let dest = bundleURL.appendingPathComponent("rom")
        try fileManager.copyItem(at: romURL, to: dest)
      }

      let manifest = YazeProjectBundleManifest(
        createdAt: timestamp,
        projectName: projectName,
        romName: romName,
        notes: "Generated by Yaze iOS"
      )
      let manifestData = try JSONEncoder().encode(manifest)
      try manifestData.write(to: bundleURL.appendingPathComponent("manifest.json"))

      return bundleURL
    } catch {
      return nil
    }
  }

  static func importBundle(from url: URL, settingsStore: YazeSettingsStore) -> URL? {
    let fileManager = FileManager.default
    let documents = FileManager.default.urls(for: .documentDirectory, in: .userDomainMask).first
    let root = documents?.appendingPathComponent("Yaze", isDirectory: true)
    guard let root else { return nil }

    let importRoot = root.appendingPathComponent("Imports", isDirectory: true)
    do {
      try fileManager.createDirectory(at: importRoot, withIntermediateDirectories: true)
    } catch {
      return nil
    }

    let bundleName = url.deletingPathExtension().lastPathComponent
    let destination = importRoot.appendingPathComponent("\(bundleName).yazeproj")

    do {
      if fileManager.fileExists(atPath: destination.path) {
        try fileManager.removeItem(at: destination)
      }
      try fileManager.copyItem(at: url, to: destination)

      let romFile = destination.appendingPathComponent("rom")
      if fileManager.fileExists(atPath: romFile.path) {
        settingsStore.updateCurrentRomPath(romFile.path)
      }
      // Prefer opening the bundle root; core resolves `project.yaze` + paths.
      settingsStore.updateCurrentProjectPath(destination.path)

      return destination
    } catch {
      return nil
    }
  }

  private static func copyDirectory(from source: URL, to destination: URL) throws {
    let fileManager = FileManager.default
    if fileManager.fileExists(atPath: destination.path) {
      try fileManager.removeItem(at: destination)
    }
    try fileManager.createDirectory(at: destination, withIntermediateDirectories: true)

    let enumerator = fileManager.enumerator(at: source, includingPropertiesForKeys: nil)
    while let file = enumerator?.nextObject() as? URL {
      let relativePath = file.path.replacingOccurrences(of: source.path, with: "")
      let destURL = destination.appendingPathComponent(relativePath)
      if file.hasDirectoryPath {
        try fileManager.createDirectory(at: destURL, withIntermediateDirectories: true)
      } else {
        try fileManager.copyItem(at: file, to: destURL)
      }
    }
  }
}
