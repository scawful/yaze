<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>yaze: E4 - Emulator Development Guide</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript">var page_layout=1;</script>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="side-nav" class="ui-resizable side-nav-resizable"><!-- do not remove this div, it is closed by doxygen! -->
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../yaze.ico"/></td>
  <td id="projectalign">
   <div id="projectname">yaze<span id="projectnumber">&#160;0.3.2</span>
   </div>
   <div id="projectbrief">Link to the Past ROM Editor</div>
  </td>
 </tr>
   <tr><td colspan="2">        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.svg" alt=""/></a>
          </span>
        </div>
</td></tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d7/d44/md_docs_2E4-Emulator-Development-Guide.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">E4 - Emulator Development Guide</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md287"></a> <b>Last Updated</b>: October 6, 2025 <b>Status</b>: ✅ <b>FUNCTIONAL &amp; STABLE</b></p>
<p>This document provides a comprehensive overview of the YAZE SNES emulator subsystem, consolidating all development notes, bug fixes, and architectural decisions. It serves as the single source of truth for understanding and developing the emulator.</p>
<h1><a class="anchor" id="autotoc_md288"></a>
1. Current Status</h1>
<p>The YAZE SNES emulator is <b>fully functional and stable</b>. All critical timing, synchronization, and instruction execution bugs in the APU/SPC700 and CPU have been resolved. The emulator can successfully boot and run "The Legend of Zelda: A Link to the Past" and other SNES games.</p>
<ul>
<li>✅ <b>CPU-APU Synchronization</b>: Cycle-accurate.</li>
<li>✅ <b>SPC700 Emulation</b>: All instructions and timing are correct.</li>
<li>✅ <b>IPL ROM Protocol</b>: Handshake and data transfers work as expected.</li>
<li>✅ <b>Memory System</b>: Stable and consolidated.</li>
<li>✅ <b>UI Integration</b>: Runs smoothly within the YAZE GUI.</li>
</ul>
<p>The main remaining work involves UI/UX enhancements and adding advanced debugging features, rather than fixing core emulation bugs.</p>
<h1><a class="anchor" id="autotoc_md289"></a>
2. How to Use the Emulator</h1>
<h2><a class="anchor" id="autotoc_md290"></a>
Method 1: Main Yaze Application (GUI)</h2>
<ol type="1">
<li><b>Build YAZE</b>: <code>bash cmake --build build --target yaze -j8 </code></li>
<li><b>Run YAZE</b>: <code>bash ./build/bin/yaze.app/Contents/MacOS/yaze </code></li>
<li><b>Open a ROM</b>: Use <code>File &gt; Open ROM</code> or drag and drop a ROM file onto the window.</li>
<li><b>Start Emulation</b>:<ul>
<li>Navigate to <code>View &gt; Emulator</code> from the menu.</li>
<li>Click the <b>Play (▶)</b> button in the emulator toolbar.</li>
</ul>
</li>
</ol>
<h2><a class="anchor" id="autotoc_md291"></a>
Method 2: Standalone Emulator (&lt;tt&gt;yaze_emu&lt;/tt&gt;)</h2>
<p>For headless testing and debugging, use the standalone <code>yaze_emu</code> executable.</p>
<div class="fragment"><div class="line"># Run for a specific number of frames and then exit</div>
<div class="line">./build/bin/yaze_emu.app/Contents/MacOS/yaze_emu --emu_max_frames=600</div>
<div class="line"> </div>
<div class="line"># Run with a specific ROM</div>
<div class="line">./build/bin/yaze_emu.app/Contents/MacOS/yaze_emu --emu_rom=path/to/rom.sfc</div>
<div class="line"> </div>
<div class="line"># Enable APU and CPU debug logging</div>
<div class="line">./build/bin/yaze_emu.app/Contents/MacOS/yaze_emu --emu_debug_apu=true --emu_debug_cpu=true</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md292"></a>
3. Architecture</h1>
<h2><a class="anchor" id="autotoc_md293"></a>
Memory System</h2>
<p>The emulator's memory architecture was consolidated to resolve critical bugs and improve clarity.</p>
<ul>
<li>**<code>rom_</code>**: A <code>std::vector&lt;uint8_t&gt;</code> that holds the cartridge ROM data. This is the source of truth for the emulator core's read path (<code>cart_read()</code>).</li>
<li>**<code>ram_</code>**: A <code>std::vector&lt;uint8_t&gt;</code> for SRAM.</li>
<li>**<code>memory_</code>**: A 16MB flat address space used <em>only</em> by the editor interface for direct memory inspection, not by the emulator core during execution.</li>
</ul>
<p>This separation fixed a critical bug where the editor and emulator were reading from different, inconsistent memory sources.</p>
<h2><a class="anchor" id="autotoc_md294"></a>
CPU-APU-SPC700 Interaction</h2>
<p>The SNES audio subsystem is complex and requires precise timing.</p>
<ol type="1">
<li><b>Initialization</b>: The SNES CPU boots and initializes the APU.</li>
<li><b>IPL ROM Boot</b>: The SPC700 (the APU's CPU) executes its 64-byte internal IPL ROM.</li>
<li><b>Handshake</b>: The SPC700 writes <code>$AA</code> and <code>$BB</code> to its output ports. The CPU reads these values and writes back <code>$CC</code> to initiate a data transfer.</li>
<li><b>Data Transfer</b>: The CPU uploads the audio driver and data to the SPC700's RAM in blocks. This involves a counter-based acknowledgment protocol.</li>
<li><b>Execution</b>: Once the audio driver is uploaded, the SPC700 jumps to the new code and begins handling audio processing independently.</li>
</ol>
<h1><a class="anchor" id="autotoc_md295"></a>
4. The Debugging Journey: A Summary of Critical Fixes</h1>
<p>The path to a functional emulator involved fixing a cascade of 9 critical, interconnected bugs.</p>
<ol type="1">
<li><b>APU Cycle Synchronization</b>: The APU was not advancing its cycles in sync with the master clock, causing an immediate deadlock.<ul>
<li><b>Fix</b>: Implemented a delta-based calculation in <code>Apu::RunCycles()</code> using <code>g_last_master_cycles</code>.</li>
</ul>
</li>
<li><b>SPC700 <code>read_word</code> Address Truncation</b>: 16-bit addresses were being truncated to 8 bits, causing the SPC700 to read its reset vector from the wrong location ($00C0 instead of $FFC0).<ul>
<li><b>Fix</b>: Changed function parameters in <code><a class="el" href="../../df/dea/spc700_8h.html">spc700.h</a></code> from <code>uint8_t</code> to <code>uint16_t</code>.</li>
</ul>
</li>
<li><b>Multi-Step Instruction <code>bstep</code> Increment</b>: Instructions like <code>MOVS</code> were only executing their first step because the internal step counter (<code>bstep</code>) was never incremented.<ul>
<li><b>Fix</b>: Added <code>bstep++</code> to the first step of all multi-step instructions.</li>
</ul>
</li>
<li><b>Step Reset Logic</b>: The main instruction loop was resetting the step counter unconditionally, breaking multi-step instructions.<ul>
<li><b>Fix</b>: Guarded the step reset with <code>if (bstep == 0)</code>.</li>
</ul>
</li>
<li><b>Opcode Re-Read</b>: A new opcode was being fetched before the previous multi-step instruction had completed.<ul>
<li><b>Fix</b>: Guarded the opcode read with <code>if (bstep == 0)</code>.</li>
</ul>
</li>
<li><b>Address Re-Calculation</b>: Address mode functions were being called on each step of a multi-step instruction, advancing the PC incorrectly.<ul>
<li><b>Fix</b>: Cached the calculated address in <code>this-&gt;adr</code> on the first step and reused it.</li>
</ul>
</li>
<li><b>CMP Z-Flag Calculation</b>: <code>CMP</code> instructions were checking the 16-bit result for zero, causing incorrect flag calculations for 8-bit operations.<ul>
<li><b>Fix</b>: Changed all <code>CMP</code> functions to check <code>(result &amp; 0xFF) == 0</code>.</li>
</ul>
</li>
<li><b>IPL ROM Counter Write</b>: The IPL ROM was missing a key instruction to echo the transfer counter back to the CPU.<ul>
<li><b>Fix</b>: Corrected the IPL ROM byte array in <code><a class="el" href="../../da/ddf/apu_8cc.html">apu.cc</a></code> to include <code>CB F4</code> (<code>MOV ($F4),Y</code>).</li>
</ul>
</li>
<li><b>SDL Event Loop Blocking</b>: The main application loop used <code>SDL_WaitEvent</code>, which blocked rendering unless the user moved the mouse.<ul>
<li><b>Fix</b>: Switched to <code>SDL_PollEvent</code> to enable continuous rendering at 60 FPS.</li>
</ul>
</li>
</ol>
<h1><a class="anchor" id="autotoc_md296"></a>
5. Logging System</h1>
<p>A structured logging system (<code><a class="el" href="../../d7/d7f/log_8h.html">util/log.h</a></code>) was integrated to replace all <code>printf</code> statements.</p>
<ul>
<li><b>Categories</b>: <code>APU</code>, <code>SNES</code>, <code>CPU</code>, <code>Memory</code>, <code>SPC700</code>.</li>
<li><b>Levels</b>: <code>DEBUG</code>, <code>INFO</code>, <code>WARN</code>, <code>ERROR</code>.</li>
<li><b>Usage</b>: <code>LOG_INFO("APU", "Reset complete");</code></li>
</ul>
<h2><a class="anchor" id="autotoc_md297"></a>
How to Enable</h2>
<div class="fragment"><div class="line"># Run with debug logging for specific categories</div>
<div class="line">./build/bin/yaze --log-level=DEBUG --log-categories=APU,SNES</div>
<div class="line"> </div>
<div class="line"># Log to a file</div>
<div class="line">./build/bin/yaze --log-level=DEBUG --log-file=emulator.log</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md298"></a>
6. Testing</h1>
<p>The emulator subsystem has a growing suite of tests.</p>
<ul>
<li><b>Unit Tests</b>: Located in <code>test/unit/emu/</code>, these verify specific components like the APU handshake (<code><a class="el" href="../../d4/dbb/apu__ipl__handshake__test_8cc.html">apu_ipl_handshake_test.cc</a></code>).</li>
<li><b>Standalone Emulator</b>: <code>yaze_emu</code> provides a headless way to run the emulator for a fixed number of frames, perfect for regression testing.</li>
</ul>
<h2><a class="anchor" id="autotoc_md299"></a>
Running Tests</h2>
<div class="fragment"><div class="line"># Build the test runner</div>
<div class="line">cmake --build build --target yaze_test</div>
<div class="line"> </div>
<div class="line"># Run all emulator-related tests</div>
<div class="line">./build/bin/yaze_test --gtest_filter=&quot;*Apu*&quot;:&quot;*Spc700*&quot;</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md300"></a>
7. Future Work &amp; Enhancements</h1>
<p>While the core is stable, future work can focus on:</p>
<ul>
<li><b>UI Enhancements</b>: Create a dedicated debugger panel in the UI with register views, memory editors, and breakpoints.</li>
<li>**<code>z3ed</code> Integration**: Expose emulator controls (start, stop, step, save state) to the <code>z3ed</code> CLI for automated testing and AI-driven debugging.</li>
<li><b>Audio Output</b>: Connect the S-DSP's output buffer to SDL audio to enable sound.</li>
<li><b>Performance Optimization</b>: Profile and optimize hot paths, potentially with a JIT compiler for the CPU.</li>
<li><b>Expanded Test Coverage</b>: Add comprehensive tests for all CPU and PPU instructions. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
