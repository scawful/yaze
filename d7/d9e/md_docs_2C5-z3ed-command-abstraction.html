<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>yaze: z3ed Command Abstraction Layer Guide</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript">var page_layout=1;</script>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="side-nav" class="ui-resizable side-nav-resizable"><!-- do not remove this div, it is closed by doxygen! -->
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../yaze.ico"/></td>
  <td id="projectalign">
   <div id="projectname">yaze<span id="projectnumber">&#160;0.3.2</span>
   </div>
   <div id="projectbrief">Link to the Past ROM Editor</div>
  </td>
 </tr>
   <tr><td colspan="2">        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.svg" alt=""/></a>
          </span>
        </div>
</td></tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d7/d9e/md_docs_2C5-z3ed-command-abstraction.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">z3ed Command Abstraction Layer Guide</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md495"></a> <b>Created</b>: October 11, 2025 <br  />
 <b>Status</b>: Implementation Complete</p>
<h1><a class="anchor" id="autotoc_md496"></a>
Overview</h1>
<p>This guide documents the new command abstraction layer for z3ed CLI commands. The abstraction layer eliminates ~500+ lines of duplicated code across tool commands and provides a consistent, maintainable architecture for future command development.</p>
<h1><a class="anchor" id="autotoc_md497"></a>
Problem Statement</h1>
<h2><a class="anchor" id="autotoc_md498"></a>
Before Abstraction</h2>
<p>The original <code>tool_commands.cc</code> (1549 lines) had severe code duplication:</p>
<ol type="1">
<li><b>ROM Loading</b>: Every command had 20-30 lines of identical ROM loading logic</li>
<li><b>Argument Parsing</b>: Each command manually parsed <code>--format</code>, <code>--rom</code>, <code>--type</code>, etc.</li>
<li><b>Output Formatting</b>: JSON vs text formatting was duplicated across every command</li>
<li><b>Label Initialization</b>: Resource label loading was repeated in every handler</li>
<li><b>Error Handling</b>: Inconsistent error messages and validation patterns</li>
</ol>
<h2><a class="anchor" id="autotoc_md499"></a>
Code Duplication Example</h2>
<div class="fragment"><div class="line"><span class="comment">// Repeated in EVERY command (30+ times):</span></div>
<div class="line">Rom rom_storage;</div>
<div class="line">Rom* rom = <span class="keyword">nullptr</span>;</div>
<div class="line"><span class="keywordflow">if</span> (rom_context != <span class="keyword">nullptr</span> &amp;&amp; rom_context-&gt;is_loaded()) {</div>
<div class="line">  rom = rom_context;</div>
<div class="line">} <span class="keywordflow">else</span> {</div>
<div class="line">  <span class="keyword">auto</span> rom_or = LoadRomFromFlag();</div>
<div class="line">  <span class="keywordflow">if</span> (!rom_or.ok()) {</div>
<div class="line">    <span class="keywordflow">return</span> rom_or.status();</div>
<div class="line">  }</div>
<div class="line">  rom_storage = std::move(rom_or.value());</div>
<div class="line">  rom = &amp;rom_storage;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Initialize labels (repeated in every command that needs labels)</span></div>
<div class="line"><span class="keywordflow">if</span> (rom-&gt;resource_label()) {</div>
<div class="line">  <span class="keywordflow">if</span> (!rom-&gt;resource_label()-&gt;labels_loaded_) {</div>
<div class="line">    core::YazeProject project;</div>
<div class="line">    project.use_embedded_labels = <span class="keyword">true</span>;</div>
<div class="line">    <span class="keyword">auto</span> labels_status = project.InitializeEmbeddedLabels();</div>
<div class="line">    <span class="comment">// ... more boilerplate ...</span></div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Manual argument parsing (repeated everywhere)</span></div>
<div class="line">std::string format = <span class="stringliteral">&quot;json&quot;</span>;</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; arg_vec.size(); ++i) {</div>
<div class="line">  <span class="keyword">const</span> std::string&amp; token = arg_vec[i];</div>
<div class="line">  <span class="keywordflow">if</span> (token == <span class="stringliteral">&quot;--format&quot;</span>) {</div>
<div class="line">    <span class="keywordflow">if</span> (i + 1 &gt;= arg_vec.size()) {</div>
<div class="line">      <span class="keywordflow">return</span> absl::InvalidArgumentError(<span class="stringliteral">&quot;--format requires a value.&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    format = arg_vec[++i];</div>
<div class="line">  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (absl::StartsWith(token, <span class="stringliteral">&quot;--format=&quot;</span>)) {</div>
<div class="line">    format = token.substr(9);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Manual output formatting (repeated everywhere)</span></div>
<div class="line"><span class="keywordflow">if</span> (format == <span class="stringliteral">&quot;json&quot;</span>) {</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;{\n&quot;</span>;</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;  \&quot;field\&quot;: \&quot;value\&quot;,\n&quot;</span>;</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;}\n&quot;</span>;</div>
<div class="line">} <span class="keywordflow">else</span> {</div>
<div class="line">  std::cout &lt;&lt; <span class="stringliteral">&quot;Field: value\n&quot;</span>;</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md500"></a>
Solution Architecture</h1>
<h2><a class="anchor" id="autotoc_md501"></a>
Three-Layer Abstraction</h2>
<ol type="1">
<li><b>CommandContext</b> - ROM loading, context management</li>
<li><b>ArgumentParser</b> - Unified argument parsing</li>
<li><b>OutputFormatter</b> - Consistent output formatting</li>
<li><b>CommandHandler</b> (Optional) - Base class for structured commands</li>
</ol>
<h2><a class="anchor" id="autotoc_md502"></a>
File Structure</h2>
<div class="fragment"><div class="line">src/cli/service/resources/</div>
<div class="line">├── command_context.h          # Context management</div>
<div class="line">├── command_context.cc</div>
<div class="line">├── command_handler.h          # Base handler class</div>
<div class="line">├── command_handler.cc</div>
<div class="line">└── (existing files...)</div>
<div class="line"> </div>
<div class="line">src/cli/handlers/agent/</div>
<div class="line">├── tool_commands.cc           # Original (to be refactored)</div>
<div class="line">├── tool_commands_refactored.cc # Example refactored commands</div>
<div class="line">└── (other handlers...)</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md503"></a>
Core Components</h1>
<h2><a class="anchor" id="autotoc_md504"></a>
1. CommandContext</h2>
<p>Encapsulates ROM loading and common context:</p>
<div class="fragment"><div class="line"><span class="comment">// Create context</span></div>
<div class="line">CommandContext::Config config;</div>
<div class="line">config.external_rom_context = rom_context;  <span class="comment">// Optional: use existing ROM</span></div>
<div class="line">config.rom_path = <span class="stringliteral">&quot;/path/to/rom.sfc&quot;</span>;       <span class="comment">// Optional: override ROM path</span></div>
<div class="line">config.use_mock_rom = <span class="keyword">false</span>;                <span class="comment">// Optional: use mock for testing</span></div>
<div class="line">config.format = <span class="stringliteral">&quot;json&quot;</span>;</div>
<div class="line"> </div>
<div class="line">CommandContext context(config);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Get ROM (auto-loads if needed)</span></div>
<div class="line"><a class="code hl_define" href="../../d4/d9e/macro_8h.html#a9a548e9537ecb0675b887fec6654d2d3">ASSIGN_OR_RETURN</a>(Rom* rom, context.GetRom());</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Ensure labels loaded</span></div>
<div class="line"><a class="code hl_define" href="../../d4/d9e/macro_8h.html#a755e0e0d964b4d81ae730d174c5fa3ce">RETURN_IF_ERROR</a>(context.EnsureLabelsLoaded(rom));</div>
<div class="ttc" id="amacro_8h_html_a755e0e0d964b4d81ae730d174c5fa3ce"><div class="ttname"><a href="../../d4/d9e/macro_8h.html#a755e0e0d964b4d81ae730d174c5fa3ce">RETURN_IF_ERROR</a></div><div class="ttdeci">#define RETURN_IF_ERROR(expression)</div><div class="ttdef"><b>Definition</b> <a href="../../d4/d9e/macro_8h_source.html#l00053">macro.h:53</a></div></div>
<div class="ttc" id="amacro_8h_html_a9a548e9537ecb0675b887fec6654d2d3"><div class="ttname"><a href="../../d4/d9e/macro_8h.html#a9a548e9537ecb0675b887fec6654d2d3">ASSIGN_OR_RETURN</a></div><div class="ttdeci">#define ASSIGN_OR_RETURN(type_variable_name, expression)</div><div class="ttdef"><b>Definition</b> <a href="../../d4/d9e/macro_8h_source.html#l00061">macro.h:61</a></div></div>
</div><!-- fragment --><p><b>Benefits</b>:</p><ul>
<li>Single location for ROM loading logic</li>
<li>Automatic error handling</li>
<li>Mock ROM support for testing</li>
<li>Label management abstraction</li>
</ul>
<h2><a class="anchor" id="autotoc_md505"></a>
2. ArgumentParser</h2>
<p>Unified argument parsing with type safety:</p>
<div class="fragment"><div class="line">ArgumentParser parser(arg_vec);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// String arguments</span></div>
<div class="line"><span class="keyword">auto</span> type = parser.GetString(<span class="stringliteral">&quot;type&quot;</span>);        <span class="comment">// Returns std::optional&lt;string&gt;</span></div>
<div class="line"><span class="keyword">auto</span> format = parser.GetString(<span class="stringliteral">&quot;format&quot;</span>).value_or(<span class="stringliteral">&quot;json&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Integer arguments (supports hex with 0x prefix)</span></div>
<div class="line"><a class="code hl_define" href="../../d4/d9e/macro_8h.html#a9a548e9537ecb0675b887fec6654d2d3">ASSIGN_OR_RETURN</a>(<span class="keywordtype">int</span> room_id, parser.GetInt(<span class="stringliteral">&quot;room&quot;</span>));</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Hex-only arguments</span></div>
<div class="line"><a class="code hl_define" href="../../d4/d9e/macro_8h.html#a9a548e9537ecb0675b887fec6654d2d3">ASSIGN_OR_RETURN</a>(<span class="keywordtype">int</span> tile_id, parser.GetHex(<span class="stringliteral">&quot;tile&quot;</span>));</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Flags</span></div>
<div class="line"><span class="keywordflow">if</span> (parser.HasFlag(<span class="stringliteral">&quot;verbose&quot;</span>)) {</div>
<div class="line">  <span class="comment">// ...</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Validation</span></div>
<div class="line"><a class="code hl_define" href="../../d4/d9e/macro_8h.html#a755e0e0d964b4d81ae730d174c5fa3ce">RETURN_IF_ERROR</a>(parser.RequireArgs({<span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;query&quot;</span>}));</div>
</div><!-- fragment --><p><b>Benefits</b>:</p><ul>
<li>Consistent argument parsing across all commands</li>
<li>Type-safe with proper error handling</li>
<li>Supports both <code>--arg=value</code> and <code>--arg value</code> forms</li>
<li>Built-in hex parsing for ROM addresses</li>
</ul>
<h2><a class="anchor" id="autotoc_md506"></a>
3. OutputFormatter</h2>
<p>Consistent JSON/text output:</p>
<div class="fragment"><div class="line"><a class="code hl_define" href="../../d4/d9e/macro_8h.html#a9a548e9537ecb0675b887fec6654d2d3">ASSIGN_OR_RETURN</a>(<span class="keyword">auto</span> formatter, OutputFormatter::FromString(<span class="stringliteral">&quot;json&quot;</span>));</div>
<div class="line"> </div>
<div class="line">formatter.BeginObject(<span class="stringliteral">&quot;Room Information&quot;</span>);</div>
<div class="line">formatter.AddField(<span class="stringliteral">&quot;room_id&quot;</span>, <span class="stringliteral">&quot;0x12&quot;</span>);</div>
<div class="line">formatter.AddHexField(<span class="stringliteral">&quot;address&quot;</span>, 0x1234, 4);  <span class="comment">// Formats as &quot;0x1234&quot;</span></div>
<div class="line">formatter.AddField(<span class="stringliteral">&quot;sprite_count&quot;</span>, 5);</div>
<div class="line"> </div>
<div class="line">formatter.BeginArray(<span class="stringliteral">&quot;sprites&quot;</span>);</div>
<div class="line">formatter.AddArrayItem(<span class="stringliteral">&quot;Sprite 1&quot;</span>);</div>
<div class="line">formatter.AddArrayItem(<span class="stringliteral">&quot;Sprite 2&quot;</span>);</div>
<div class="line">formatter.EndArray();</div>
<div class="line"> </div>
<div class="line">formatter.EndObject();</div>
<div class="line">formatter.Print();</div>
</div><!-- fragment --><p><b>Output (JSON)</b>: </p><div class="fragment"><div class="line">{</div>
<div class="line">  &quot;room_id&quot;: &quot;0x12&quot;,</div>
<div class="line">  &quot;address&quot;: &quot;0x1234&quot;,</div>
<div class="line">  &quot;sprite_count&quot;: 5,</div>
<div class="line">  &quot;sprites&quot;: [</div>
<div class="line">    &quot;Sprite 1&quot;,</div>
<div class="line">    &quot;Sprite 2&quot;</div>
<div class="line">  ]</div>
<div class="line">}</div>
</div><!-- fragment --><p><b>Output (Text)</b>: </p><div class="fragment"><div class="line">=== Room Information ===</div>
<div class="line">  room_id              : 0x12</div>
<div class="line">  address              : 0x1234</div>
<div class="line">  sprite_count         : 5</div>
<div class="line">  sprites:</div>
<div class="line">    - Sprite 1</div>
<div class="line">    - Sprite 2</div>
</div><!-- fragment --><p><b>Benefits</b>:</p><ul>
<li>No manual JSON escaping</li>
<li>Consistent formatting rules</li>
<li>Easy to switch between JSON and text</li>
<li>Proper indentation handling</li>
</ul>
<h2><a class="anchor" id="autotoc_md507"></a>
4. CommandHandler (Optional Base Class)</h2>
<p>For more complex commands, use the base class pattern:</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>MyCommandHandler : <span class="keyword">public</span> CommandHandler {</div>
<div class="line"> <span class="keyword">protected</span>:</div>
<div class="line">  std::string GetUsage()<span class="keyword"> const override </span>{</div>
<div class="line">    <span class="keywordflow">return</span> <span class="stringliteral">&quot;agent my-command --required &lt;value&gt; [--format &lt;json|text&gt;]&quot;</span>;</div>
<div class="line">  }</div>
<div class="line">  </div>
<div class="line">  absl::Status ValidateArgs(<span class="keyword">const</span> ArgumentParser&amp; parser)<span class="keyword"> override </span>{</div>
<div class="line">    <span class="keywordflow">return</span> parser.RequireArgs({<span class="stringliteral">&quot;required&quot;</span>});</div>
<div class="line">  }</div>
<div class="line">  </div>
<div class="line">  absl::Status Execute(Rom* rom, <span class="keyword">const</span> ArgumentParser&amp; parser,</div>
<div class="line">                      OutputFormatter&amp; formatter)<span class="keyword"> override </span>{</div>
<div class="line">    <span class="keyword">auto</span> value = parser.GetString(<span class="stringliteral">&quot;required&quot;</span>).value();</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Business logic here</span></div>
<div class="line">    formatter.AddField(<span class="stringliteral">&quot;result&quot;</span>, value);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> absl::OkStatus();</div>
<div class="line">  }</div>
<div class="line">  </div>
<div class="line">  <span class="keywordtype">bool</span> RequiresLabels()<span class="keyword"> const override </span>{ <span class="keywordflow">return</span> <span class="keyword">true</span>; }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Usage:</span></div>
<div class="line">absl::Status HandleMyCommand(<span class="keyword">const</span> std::vector&lt;std::string&gt;&amp; args, Rom* rom) {</div>
<div class="line">  MyCommandHandler handler;</div>
<div class="line">  <span class="keywordflow">return</span> handler.Run(args, rom);</div>
<div class="line">}</div>
</div><!-- fragment --><p><b>Benefits</b>:</p><ul>
<li>Enforces consistent structure</li>
<li>Automatic context setup and teardown</li>
<li>Built-in error handling</li>
<li>Easy to test individual components</li>
</ul>
<h1><a class="anchor" id="autotoc_md508"></a>
Migration Guide</h1>
<h2><a class="anchor" id="autotoc_md509"></a>
Step-by-Step Refactoring</h2>
<h3><a class="anchor" id="autotoc_md510"></a>
Before (80 lines):</h3>
<div class="fragment"><div class="line">absl::Status HandleResourceListCommand(</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;std::string&gt;&amp; arg_vec, Rom* rom_context) {</div>
<div class="line">  std::string type;</div>
<div class="line">  std::string format = <span class="stringliteral">&quot;table&quot;</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Manual argument parsing (20 lines)</span></div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; arg_vec.size(); ++i) {</div>
<div class="line">    <span class="keyword">const</span> std::string&amp; token = arg_vec[i];</div>
<div class="line">    <span class="keywordflow">if</span> (token == <span class="stringliteral">&quot;--type&quot;</span>) {</div>
<div class="line">      <span class="keywordflow">if</span> (i + 1 &gt;= arg_vec.size()) {</div>
<div class="line">        <span class="keywordflow">return</span> absl::InvalidArgumentError(<span class="stringliteral">&quot;--type requires a value.&quot;</span>);</div>
<div class="line">      }</div>
<div class="line">      type = arg_vec[++i];</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (absl::StartsWith(token, <span class="stringliteral">&quot;--type=&quot;</span>)) {</div>
<div class="line">      type = token.substr(7);</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// ... repeat for --format ...</span></div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (type.empty()) {</div>
<div class="line">    <span class="keywordflow">return</span> absl::InvalidArgumentError(<span class="stringliteral">&quot;Usage: ...&quot;</span>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// ROM loading (30 lines)</span></div>
<div class="line">  Rom rom_storage;</div>
<div class="line">  Rom* rom = <span class="keyword">nullptr</span>;</div>
<div class="line">  <span class="keywordflow">if</span> (rom_context != <span class="keyword">nullptr</span> &amp;&amp; rom_context-&gt;is_loaded()) {</div>
<div class="line">    rom = rom_context;</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    <span class="keyword">auto</span> rom_or = <a class="code hl_function" href="../../d6/da3/namespaceyaze_1_1cli_1_1message_1_1anonymous__namespace_02message_8cc_03.html#ad10a3c76cee8c40cee517334f011ebe1">LoadRomFromFlag</a>();</div>
<div class="line">    <span class="keywordflow">if</span> (!rom_or.ok()) {</div>
<div class="line">      <span class="keywordflow">return</span> rom_or.status();</div>
<div class="line">    }</div>
<div class="line">    rom_storage = std::move(rom_or.value());</div>
<div class="line">    rom = &amp;rom_storage;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Label initialization (15 lines)</span></div>
<div class="line">  <span class="keywordflow">if</span> (rom-&gt;resource_label()) {</div>
<div class="line">    <span class="keywordflow">if</span> (!rom-&gt;resource_label()-&gt;labels_loaded_) {</div>
<div class="line">      core::YazeProject project;</div>
<div class="line">      project.use_embedded_labels = <span class="keyword">true</span>;</div>
<div class="line">      <span class="keyword">auto</span> labels_status = project.InitializeEmbeddedLabels();</div>
<div class="line">      <span class="keywordflow">if</span> (labels_status.ok()) {</div>
<div class="line">        rom-&gt;resource_label()-&gt;labels_ = project.resource_labels;</div>
<div class="line">        rom-&gt;resource_label()-&gt;labels_loaded_ = <span class="keyword">true</span>;</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Business logic</span></div>
<div class="line">  ResourceContextBuilder context_builder(rom);</div>
<div class="line">  <span class="keyword">auto</span> labels_or = context_builder.GetLabels(type);</div>
<div class="line">  <span class="keywordflow">if</span> (!labels_or.ok()) {</div>
<div class="line">    <span class="keywordflow">return</span> labels_or.status();</div>
<div class="line">  }</div>
<div class="line">  <span class="keyword">auto</span> labels = std::move(labels_or.value());</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Manual output formatting (15 lines)</span></div>
<div class="line">  <span class="keywordflow">if</span> (format == <span class="stringliteral">&quot;json&quot;</span>) {</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;{\n&quot;</span>;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; [key, value] : labels) {</div>
<div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;  \&quot;&quot;</span> &lt;&lt; key &lt;&lt; <span class="stringliteral">&quot;\&quot;: \&quot;&quot;</span> &lt;&lt; value &lt;&lt; <span class="stringliteral">&quot;\&quot;,\n&quot;</span>;</div>
<div class="line">    }</div>
<div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;}\n&quot;</span>;</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; [key, value] : labels) {</div>
<div class="line">      std::cout &lt;&lt; key &lt;&lt; <span class="stringliteral">&quot;: &quot;</span> &lt;&lt; value &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> absl::OkStatus();</div>
<div class="line">}</div>
<div class="ttc" id="anamespaceyaze_1_1cli_1_1message_1_1anonymous__namespace_02message_8cc_03_html_ad10a3c76cee8c40cee517334f011ebe1"><div class="ttname"><a href="../../d6/da3/namespaceyaze_1_1cli_1_1message_1_1anonymous__namespace_02message_8cc_03.html#ad10a3c76cee8c40cee517334f011ebe1">yaze::cli::message::anonymous_namespace{message.cc}::LoadRomFromFlag</a></div><div class="ttdeci">absl::StatusOr&lt; Rom &gt; LoadRomFromFlag()</div><div class="ttdef"><b>Definition</b> <a href="../../d4/d7a/message_8cc_source.html#l00028">message.cc:28</a></div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md511"></a>
After (30 lines):</h3>
<div class="fragment"><div class="line">absl::Status HandleResourceListCommand(</div>
<div class="line">    <span class="keyword">const</span> std::vector&lt;std::string&gt;&amp; arg_vec, Rom* rom_context) {</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// Parse arguments</span></div>
<div class="line">  ArgumentParser parser(arg_vec);</div>
<div class="line">  <span class="keyword">auto</span> type = parser.GetString(<span class="stringliteral">&quot;type&quot;</span>);</div>
<div class="line">  <span class="keyword">auto</span> format_str = parser.GetString(<span class="stringliteral">&quot;format&quot;</span>).value_or(<span class="stringliteral">&quot;table&quot;</span>);</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">if</span> (!type.has_value()) {</div>
<div class="line">    <span class="keywordflow">return</span> absl::InvalidArgumentError(</div>
<div class="line">        <span class="stringliteral">&quot;Usage: agent resource-list --type &lt;type&gt; [--format &lt;table|json&gt;]&quot;</span>);</div>
<div class="line">  }</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// Create formatter</span></div>
<div class="line">  <a class="code hl_define" href="../../d4/d9e/macro_8h.html#a9a548e9537ecb0675b887fec6654d2d3">ASSIGN_OR_RETURN</a>(<span class="keyword">auto</span> formatter, OutputFormatter::FromString(format_str));</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// Setup context</span></div>
<div class="line">  CommandContext::Config config;</div>
<div class="line">  config.external_rom_context = rom_context;</div>
<div class="line">  CommandContext context(config);</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// Get ROM and labels</span></div>
<div class="line">  <a class="code hl_define" href="../../d4/d9e/macro_8h.html#a9a548e9537ecb0675b887fec6654d2d3">ASSIGN_OR_RETURN</a>(Rom* rom, context.GetRom());</div>
<div class="line">  <a class="code hl_define" href="../../d4/d9e/macro_8h.html#a755e0e0d964b4d81ae730d174c5fa3ce">RETURN_IF_ERROR</a>(context.EnsureLabelsLoaded(rom));</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// Execute business logic</span></div>
<div class="line">  ResourceContextBuilder builder(rom);</div>
<div class="line">  <a class="code hl_define" href="../../d4/d9e/macro_8h.html#a9a548e9537ecb0675b887fec6654d2d3">ASSIGN_OR_RETURN</a>(<span class="keyword">auto</span> labels, builder.GetLabels(*type));</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// Format output</span></div>
<div class="line">  formatter.BeginObject(<span class="stringliteral">&quot;Labels&quot;</span>);</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; [key, value] : labels) {</div>
<div class="line">    formatter.AddField(key, value);</div>
<div class="line">  }</div>
<div class="line">  formatter.EndObject();</div>
<div class="line">  formatter.Print();</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">return</span> absl::OkStatus();</div>
<div class="line">}</div>
</div><!-- fragment --><p><b>Savings</b>: 50+ lines eliminated, clearer intent, easier to maintain</p>
<h2><a class="anchor" id="autotoc_md512"></a>
Commands to Refactor</h2>
<p>Priority order for refactoring (based on duplication level):</p>
<ol type="1">
<li><b>High Priority</b> (Heavy duplication):<ul>
<li><code>HandleResourceListCommand</code> - Example provided ✓</li>
<li><code>HandleResourceSearchCommand</code> - Example provided ✓</li>
<li><code>HandleDungeonDescribeRoomCommand</code> - 80 lines → ~35 lines</li>
<li><code>HandleOverworldDescribeMapCommand</code> - 100 lines → ~40 lines</li>
<li><code>HandleOverworldListWarpsCommand</code> - 120 lines → ~45 lines</li>
</ul>
</li>
<li><b>Medium Priority</b> (Moderate duplication):<ul>
<li><code>HandleDungeonListSpritesCommand</code></li>
<li><code>HandleOverworldFindTileCommand</code></li>
<li><code>HandleOverworldListSpritesCommand</code></li>
<li><code>HandleOverworldGetEntranceCommand</code></li>
<li><code>HandleOverworldTileStatsCommand</code></li>
</ul>
</li>
<li><b>Low Priority</b> (Simple commands, less duplication):<ul>
<li><code>HandleMessageListCommand</code> (delegates to message handler)</li>
<li><code>HandleMessageReadCommand</code> (delegates to message handler)</li>
<li><code>HandleMessageSearchCommand</code> (delegates to message handler)</li>
</ul>
</li>
</ol>
<h2><a class="anchor" id="autotoc_md513"></a>
Estimated Impact</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Metric   </th><th class="markdownTableHeadNone">Before   </th><th class="markdownTableHeadNone">After   </th><th class="markdownTableHeadNone">Savings    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Lines of code (tool_commands.cc)   </td><td class="markdownTableBodyNone">1549   </td><td class="markdownTableBodyNone">~800   </td><td class="markdownTableBodyNone"><b>48%</b>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Duplicated ROM loading   </td><td class="markdownTableBodyNone">~600 lines   </td><td class="markdownTableBodyNone">0   </td><td class="markdownTableBodyNone"><b>600 lines</b>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Duplicated arg parsing   </td><td class="markdownTableBodyNone">~400 lines   </td><td class="markdownTableBodyNone">0   </td><td class="markdownTableBodyNone"><b>400 lines</b>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Duplicated formatting   </td><td class="markdownTableBodyNone">~300 lines   </td><td class="markdownTableBodyNone">0   </td><td class="markdownTableBodyNone"><b>300 lines</b>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><b>Total Duplication Removed</b>   </td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">**~1300 lines**   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md514"></a>
Testing Strategy</h1>
<h2><a class="anchor" id="autotoc_md515"></a>
Unit Testing</h2>
<div class="fragment"><div class="line">TEST(CommandContextTest, LoadsRomFromConfig) {</div>
<div class="line">  CommandContext::Config config;</div>
<div class="line">  config.rom_path = <span class="stringliteral">&quot;test.sfc&quot;</span>;</div>
<div class="line">  CommandContext context(config);</div>
<div class="line">  </div>
<div class="line">  <span class="keyword">auto</span> rom_or = context.GetRom();</div>
<div class="line">  <a class="code hl_define" href="../../db/d56/testing_8h.html#abed59ac7e67905d886d98f1c063ac9e7">ASSERT_OK</a>(rom_or);</div>
<div class="line">  EXPECT_TRUE(rom_or.value()-&gt;is_loaded());</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">TEST(ArgumentParserTest, ParsesStringArguments) {</div>
<div class="line">  std::vector&lt;std::string&gt; args = {<span class="stringliteral">&quot;--type=dungeon&quot;</span>, <span class="stringliteral">&quot;--format&quot;</span>, <span class="stringliteral">&quot;json&quot;</span>};</div>
<div class="line">  ArgumentParser parser(args);</div>
<div class="line">  </div>
<div class="line">  EXPECT_EQ(parser.GetString(<span class="stringliteral">&quot;type&quot;</span>).value(), <span class="stringliteral">&quot;dungeon&quot;</span>);</div>
<div class="line">  EXPECT_EQ(parser.GetString(<span class="stringliteral">&quot;format&quot;</span>).value(), <span class="stringliteral">&quot;json&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="../../d8/d01/namespaceyaze_1_1cli_1_1anonymous__namespace_02resource__catalog__test_8cc_03.html#a8a4b8ed88b34f98740dd871905b3e979">TEST</a>(OutputFormatterTest, GeneratesValidJson) {</div>
<div class="line">  <span class="keyword">auto</span> formatter = OutputFormatter::FromString(<span class="stringliteral">&quot;json&quot;</span>).value();</div>
<div class="line">  formatter.BeginObject(<span class="stringliteral">&quot;Test&quot;</span>);</div>
<div class="line">  formatter.AddField(<span class="stringliteral">&quot;key&quot;</span>, <span class="stringliteral">&quot;value&quot;</span>);</div>
<div class="line">  formatter.EndObject();</div>
<div class="line">  </div>
<div class="line">  std::string output = formatter.GetOutput();</div>
<div class="line">  EXPECT_THAT(output, HasSubstr(<span class="stringliteral">&quot;\&quot;key\&quot;: \&quot;value\&quot;&quot;</span>));</div>
<div class="line">}</div>
<div class="ttc" id="anamespaceyaze_1_1cli_1_1anonymous__namespace_02resource__catalog__test_8cc_03_html_a8a4b8ed88b34f98740dd871905b3e979"><div class="ttname"><a href="../../d8/d01/namespaceyaze_1_1cli_1_1anonymous__namespace_02resource__catalog__test_8cc_03.html#a8a4b8ed88b34f98740dd871905b3e979">yaze::cli::anonymous_namespace{resource_catalog_test.cc}::TEST</a></div><div class="ttdeci">TEST(ResourceCatalogTest, SerializeResourceIncludesReturnsArray)</div><div class="ttdef"><b>Definition</b> <a href="../../d3/d72/resource__catalog__test_8cc_source.html#l00012">resource_catalog_test.cc:12</a></div></div>
<div class="ttc" id="atesting_8h_html_abed59ac7e67905d886d98f1c063ac9e7"><div class="ttname"><a href="../../db/d56/testing_8h.html#abed59ac7e67905d886d98f1c063ac9e7">ASSERT_OK</a></div><div class="ttdeci">#define ASSERT_OK(expr)</div><div class="ttdef"><b>Definition</b> <a href="../../db/d56/testing_8h_source.html#l00012">testing.h:12</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md516"></a>
Integration Testing</h2>
<div class="fragment"><div class="line">TEST(ResourceListCommandTest, ListsDungeons) {</div>
<div class="line">  std::vector&lt;std::string&gt; args = {<span class="stringliteral">&quot;--type=dungeon&quot;</span>, <span class="stringliteral">&quot;--format=json&quot;</span>};</div>
<div class="line">  Rom rom;</div>
<div class="line">  rom.LoadFromFile(<span class="stringliteral">&quot;test.sfc&quot;</span>);</div>
<div class="line">  </div>
<div class="line">  <span class="keyword">auto</span> status = HandleResourceListCommand(args, &amp;rom);</div>
<div class="line">  <a class="code hl_define" href="../../db/d56/testing_8h.html#a78b51c162425db9db9990f17fbf61bf1">EXPECT_OK</a>(status);</div>
<div class="line">}</div>
<div class="ttc" id="atesting_8h_html_a78b51c162425db9db9990f17fbf61bf1"><div class="ttname"><a href="../../db/d56/testing_8h.html#a78b51c162425db9db9990f17fbf61bf1">EXPECT_OK</a></div><div class="ttdeci">#define EXPECT_OK(expr)</div><div class="ttdef"><b>Definition</b> <a href="../../db/d56/testing_8h_source.html#l00010">testing.h:10</a></div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md517"></a>
Benefits Summary</h1>
<h2><a class="anchor" id="autotoc_md518"></a>
For Developers</h2>
<ol type="1">
<li><b>Less Code to Write</b>: New commands take 30-40 lines instead of 80-120</li>
<li><b>Consistent Patterns</b>: All commands follow the same structure</li>
<li><b>Better Error Handling</b>: Standardized error messages and validation</li>
<li><b>Easier Testing</b>: Each component can be tested independently</li>
<li><b>Self-Documenting</b>: Clear separation of concerns</li>
</ol>
<h2><a class="anchor" id="autotoc_md519"></a>
For Maintainability</h2>
<ol type="1">
<li><b>Single Source of Truth</b>: ROM loading logic in one place</li>
<li><b>Easy to Update</b>: Change all commands by updating one class</li>
<li><b>Consistent Behavior</b>: All commands handle errors the same way</li>
<li><b>Reduced Bugs</b>: Less duplication = fewer places for bugs</li>
</ol>
<h2><a class="anchor" id="autotoc_md520"></a>
For AI Integration</h2>
<ol type="1">
<li><b>Predictable Structure</b>: AI can generate commands using templates</li>
<li><b>Type Safety</b>: ArgumentParser prevents common errors</li>
<li><b>Consistent Output</b>: AI can reliably parse JSON responses</li>
<li><b>Easy to Extend</b>: New tool types follow existing patterns</li>
</ol>
<h1><a class="anchor" id="autotoc_md521"></a>
Next Steps</h1>
<h2><a class="anchor" id="autotoc_md522"></a>
Immediate (Current PR)</h2>
<ol type="1">
<li>Create abstraction layer (CommandContext, ArgumentParser, OutputFormatter)</li>
<li>Add CommandHandler base class</li>
<li>Provide refactored examples</li>
<li>Update build system</li>
<li>Document architecture</li>
</ol>
<h2><a class="anchor" id="autotoc_md523"></a>
Phase 2 (Next PR)</h2>
<ol type="1">
<li>Refactor high-priority commands (5 commands)</li>
<li>Add comprehensive unit tests</li>
<li>Update AI tool dispatcher to use new patterns</li>
<li>Create command generator templates for AI</li>
</ol>
<h2><a class="anchor" id="autotoc_md524"></a>
Phase 3 (Future)</h2>
<ol type="1">
<li>Refactor remaining commands</li>
<li>Remove old helper functions</li>
<li>Add performance benchmarks</li>
<li>Create VS Code snippets for command development</li>
</ol>
<h1><a class="anchor" id="autotoc_md525"></a>
Migration Checklist</h1>
<p>For each command being refactored:</p>
<ul>
<li>[ ] Replace manual argument parsing with ArgumentParser</li>
<li>[ ] Replace ROM loading with CommandContext</li>
<li>[ ] Replace label initialization with context.EnsureLabelsLoaded()</li>
<li>[ ] Replace manual formatting with OutputFormatter</li>
<li>[ ] Update error messages to use GetUsage()</li>
<li>[ ] Add unit tests for the command</li>
<li>[ ] Update documentation</li>
<li>[ ] Test with both JSON and text output</li>
<li>[ ] Test with missing/invalid arguments</li>
<li>[ ] Test with mock ROM</li>
</ul>
<h1><a class="anchor" id="autotoc_md526"></a>
References</h1>
<ul>
<li>Implementation: <code>src/cli/service/resources/command_context.{h,cc}</code></li>
<li>Examples: <code>src/cli/handlers/agent/tool_commands_refactored.cc</code></li>
<li>Base class: <code>src/cli/service/resources/command_handler.{h,cc}</code></li>
<li>Build config: <code>src/cli/agent.cmake</code></li>
</ul>
<h1><a class="anchor" id="autotoc_md527"></a>
Questions &amp; Answers</h1>
<p><b>Q: Should I refactor all commands at once?</b> <br  />
 A: No. Refactor in phases to minimize risk. Start with 2-3 commands as proof of concept.</p>
<p><b>Q: What if my command needs custom argument handling?</b> <br  />
 A: ArgumentParser is flexible. You can still access raw args or add custom parsing logic.</p>
<p><b>Q: Can I use both old and new patterns temporarily?</b> <br  />
 A: Yes. The new abstraction layer works alongside existing code. Migrate gradually.</p>
<p><b>Q: Will this affect AI tool calling?</b> <br  />
 A: No breaking changes. The command interfaces remain the same. Internal implementation improves.</p>
<p><b>Q: How do I test commands with the new abstractions?</b> <br  />
 A: Use CommandContext with mock ROM, or pass external rom_context in tests.</p>
<hr  />
<p><b>Last Updated</b>: October 11, 2025 <br  />
 <b>Author</b>: AI Assistant <br  />
 <b>Review Status</b>: Ready for Implementation </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
